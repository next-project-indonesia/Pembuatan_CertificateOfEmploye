<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Next Project - NEXT Cargo Logistics</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <!-- jsPDF untuk download PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas untuk konversi ke gambar -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Font Awesome untuk ikon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      overflow: hidden;
    }

    /* Header Admin */
    .admin-header {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      padding: 25px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .company-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .company-logo {
      font-size: 36px;
      font-weight: bold;
      background: white;
      color: #e74c3c;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .company-info h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .company-info .subtitle {
      font-size: 14px;
      opacity: 0.9;
    }

    .admin-stats {
      display: flex;
      gap: 20px;
      background: rgba(255,255,255,0.1);
      padding: 15px 25px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      font-size: 28px;
      font-weight: bold;
      display: block;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.8;
    }

    /* Main Content */
    .admin-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      min-height: 800px;
    }

    /* Sidebar */
    .admin-sidebar {
      background: #f8f9fa;
      border-right: 1px solid #e0e0e0;
      padding: 30px;
    }

    .search-box {
      margin-bottom: 30px;
    }

    .search-input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      background: white;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #e74c3c;
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }

    .filter-section {
      margin-bottom: 30px;
    }

    .filter-section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .filter-group {
      margin-bottom: 20px;
    }

    .filter-label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }

    .filter-select, .filter-date {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      font-size: 14px;
    }

    .recent-requests {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .recent-requests h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .recent-list {
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .recent-item {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .recent-item:hover {
      background: #f8f9fa;
    }

    .recent-item.active {
      background: #e74c3c;
      color: white;
      border-radius: 6px;
    }

    /* Main Panel */
    .admin-main {
      padding: 30px;
      background: #fff;
    }

    /* Data List */
    .data-list-container {
      display: none;
    }

    .data-list-container.active {
      display: block;
    }

    .data-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .data-header h2 {
      color: #333;
      font-size: 22px;
    }

    .data-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-success:hover {
      background: #219653;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .data-table th {
      background: #2c3e50;
      color: white;
      padding: 18px 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
    }

    .data-table td {
      padding: 18px 15px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-processed {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }

    /* Preview Container */
    .preview-container {
      display: none;
      background: #f5f5f5;
      padding: 30px;
      border-radius: 15px;
      margin-top: 30px;
    }

    .preview-container.active {
      display: block;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .preview-info h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 20px;
    }

    .preview-info p {
      color: #666;
      font-size: 14px;
    }

    /* Template Styling - REVISI SESUAI PERMINTAAN */
    .letter-container {
  width: 210mm; /* Lebar A4 */
  min-height: 297mm; /* Tinggi A4 */
  margin: 0 auto;
  padding: 20mm; /* Margin seragam untuk A4 */
  box-sizing: border-box;
  position: relative;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  
  /* Background yang optimal untuk keterbacaan */
  background: 
    /* Overlay putih dengan opacity 85% */
    linear-gradient(
      rgba(255, 255, 255, 0.25), 
      rgba(255, 255, 255, 0.25)
    ),
    /* Background image */
    url('./template/template-1.jpg');
  filter: brightness(1.1);
  /* Mengatur background image */
  background-size: 100% 100% ; /* atau  cover jika ingin memaksa penuh */
  background-position: center center;
  background-repeat: no-repeat;
  background-attachment: scroll;
  
  /* Memastikan background memenuhi area konten */
  background-origin: padding-box;
  background-clip: padding-box;
  
  /* Font dan typography */
  font-size: 11pt;
  line-height: 1.5;
  color: #333; /* Warna teks yang kontras */
}

/* Hapus pseudo-element ::before karena sudah menggunakan gradient overlay */
.letter-container::before {
  display: none;
}

/* Semua konten surat */
.letter-container > * {
  position: relative;
  z-index: 1;
}


    /* Hapus letter-header (logo) */
    .letter-header {
      display: none;
    }

    /* REVISI: Title dirapatkan dan disesuaikan */
    .letter-title {
      text-align: center;
      font-size: 14pt; /* Ukuran dikurangi sedikit */
      font-weight: bold;
      margin: 0 0 0.3cm 0; /* Margin bawah dikurangi */
      text-transform: uppercase;
      color: #1a237e;
      line-height: 1.2; /* Line height diperkecil */
    }

    .letter-title:nth-of-type(2) {
      font-size: 12pt;
      margin-bottom: 0.5cm; /* Jarak ke nomor surat */
    }

    .letter-no {
      text-align: center;
      font-size: 10pt; /* Ukuran dikurangi */
      margin-bottom: 0.8cm; /* Dikurangi dari 1cm */
      color: #333;
      font-weight: bold;
    }

    /* Ganti tabel dengan div untuk data - lebih fleksibel */
    .letter-data-section {
      margin-bottom: 0.4cm; /* Dikurangi dari 0.6cm */
    }

    .data-row {
      display: flex;
      margin-bottom: 3px; /* Dikurangi dari 5px */
      align-items: flex-start;
      min-height: 22px; /* Tinggi minimum untuk konsistensi */
    }

    .data-label {
      width: 35%;
      font-weight: bold;
      padding-right: 10px;
      white-space: nowrap;
      font-size: 11pt; /* Ukuran font diseragamkan */
    }

    .data-value {
      width: 65%;
      padding-bottom: 2px; /* Dikurangi dari 3px */
      border-bottom: 1px dotted #777;
      min-height: 1.2em;
      font-size: 11pt; /* Ukuran font diseragamkan */
    }

    .letter-statement {
      text-align: justify;
      margin: 0.4cm 0; /* Dikurangi dari 0.6cm */
      text-indent: 40px;
      line-height: 1.5; /* Disesuaikan */
      font-size: 11pt; /* Ukuran font diseragamkan */
    }

    /* REVISI: Tanggal dan Hormat Kami dirapatkan */
    .letter-date-place {
      margin-top: 1.5cm; /* Dikurangi dari 2cm */
      text-align: right;
      margin-bottom: 0; /* Dihilangkan margin bawah */
      font-size: 11pt;
    }

    .letter-signature {
      text-align: right;
      margin-top: 0.2cm; /* Ditambahkan margin kecil di atas */
      font-size: 11pt;
    }

    .letter-signature-name {
      margin-top: 1.5cm; /* Dikurangi dari 2cm */
      text-decoration: underline;
      font-weight: bold;
      font-size: 11pt; /* Dikurangi dari 12pt */
    }

    /* Footer dengan ikon media sosial */
    .letter-footer {
      position: absolute;
      bottom: 1.2cm;
      left: 2cm;
      right: 2cm;
      font-size: 9pt;
      color: #555;
      text-align: center;
      border-top: 1px solid #aaa;
      padding-top: 0.4cm;
    }

    .social-icons {
      margin-top: 8px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    .social-icons a {
      color: #555;
      font-size: 12pt;
      transition: color 0.3s;
      text-decoration: none;
    }

    .social-icons a:hover {
      color: #e74c3c;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 25px 30px;
      background: #2c3e50;
      color: white;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: #f8f9fa;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .admin-content {
        grid-template-columns: 1fr;
      }
      
      .admin-sidebar {
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .letter-container {
        width: 100%;
        padding: 2cm;
      }
    }

    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }
      
      .admin-stats {
        width: 100%;
        justify-content: center;
      }
      
      .data-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .data-actions {
        width: 100%;
      }
      
      .btn {
        flex: 1;
        justify-content: center;
      }
      
      .data-table {
        display: block;
        overflow-x: auto;
      }
      
      .letter-container {
        padding: 1.5cm;
        background-size: cover;
      }
      
      .data-row {
        flex-direction: column;
        margin-bottom: 10px;
      }
      
      .data-label, .data-value {
        width: 100%;
      }
      
      .data-label {
        padding-right: 0;
        margin-bottom: 2px;
      }
    }

    /* Printing Styles */
    @media print {
      body * {
        visibility: hidden;
      }
      
      .preview-container, .preview-container * {
        visibility: visible;
      }
      
      .preview-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white;
        padding: 0;
        margin: 0;
        box-shadow: none;
      }
      
      .preview-header {
        display: none;
      }
      
      .letter-container {
        box-shadow: none;
        margin: 0;
        padding: 20mm;
        width: 210mm;
        min-height: 297mm;
        background: white !important; /* Pastikan background putih saat print */
      }
      
      .letter-container::before {
        display: none; /* Hilangkan overlay saat print */
      }
      
      .btn {
        display: none;
      }
    }

    /* Loading */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #e74c3c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 1001;
      transform: translateX(400px);
      transition: transform 0.3s;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 5px solid #27ae60;
    }

    .notification.error {
      border-left: 5px solid #e74c3c;
    }

    .notification.warning {
      border-left: 5px solid #f39c12;
    }

    .notification-icon {
      font-size: 24px;
    }

    .notification.success .notification-icon {
      color: #27ae60;
    }

    .notification.error .notification-icon {
      color: #e74c3c;
    }

    .notification.warning .notification-icon {
      color: #f39c12;
    }

    .notification-content h4 {
      margin: 0 0 5px 0;
      color: #333;
    }

    .notification-content p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }

    .notification-close {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 20px;
      padding: 0;
      margin-left: 10px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab-btn:hover {
      color: #e74c3c;
    }

    .tab-btn.active {
      color: #e74c3c;
      border-bottom-color: #e74c3c;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      transition: transform 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-icon {
      font-size: 40px;
      margin-bottom: 15px;
    }

    .card-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card-value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .card-change {
      font-size: 12px;
      color: #27ae60;
    }

    .card-change.negative {
      color: #e74c3c;
    }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <p style="color: #e74c3c; font-weight: bold; margin-top: 10px;">Memuat data...</p>
</div>

<!-- Notification -->
<div class="notification" id="notification">
  <div class="notification-icon">üîî</div>
  <div class="notification-content">
    <h4>Notifikasi</h4>
    <p>Pesan notifikasi</p>
  </div>
  <button class="notification-close" onclick="hideNotification()">√ó</button>
</div>

<!-- Modal Edit Status -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è Ubah Status Surat</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-group">
          <label>Status Surat</label>
          <select id="editStatus" class="form-control">
            <option value="pending">‚è≥ Pending</option>
            <option value="processed">üîÑ Dalam Proses</option>
            <option value="completed">‚úÖ Selesai</option>
          </select>
        </div>
        <div class="form-group">
          <label>Catatan Admin</label>
          <textarea id="editCatatan" class="form-control" rows="4" placeholder="Tambahkan catatan jika perlu..."></textarea>
        </div>
        <div class="form-group">
          <label>Tanggal Update</label>
          <input type="date" id="editTanggal" class="form-control" value="<?php echo date('Y-m-d'); ?>">
        </div>
        <div style="display: flex; gap: 15px; margin-top: 30px;">
          <button type="button" class="btn btn-primary" onclick="updateStatus()" style="flex: 1;">
            üíæ Simpan Perubahan
          </button>
          <button type="button" class="btn btn-danger" onclick="closeModal()" style="flex: 1;">
            ‚ùå Batal
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Main Admin Container -->
<div class="admin-container">
  <!-- Header -->
  <div class="admin-header">
    <div class="company-brand">
      <div class="company-logo">NEXT PROJECT IFP</div>
      <div class="company-info">
        <h1>PANEL ADMIN PAKLARING</h1>
        <div class="subtitle">NEXT Cargo Logistics ‚Ä¢ Whatsapp: 081383796300</div>
      </div>
    </div>
    
    <div class="admin-stats">
      <div class="stat-item">
        <span class="stat-number" id="totalData">0</span>
        <span class="stat-label">Total Data</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="pendingData">0</span>
        <span class="stat-label">Pending</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="completedData">0</span>
        <span class="stat-label">Selesai</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-content">
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Cari berdasarkan Nama, NIP, atau No. Surat..." onkeyup="filterData()">
      </div>
      
      <div class="filter-section">
        <h3>üìä Filter Data</h3>
        
        <div class="filter-group">
          <label class="filter-label">Status Surat</label>
          <select id="filterStatus" class="filter-select" onchange="filterData()">
            <option value="all">Semua Status</option>
            <option value="pending">Pending</option>
            <option value="processed">Dalam Proses</option>
            <option value="completed">Selesai</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Bulan</label>
          <select id="filterBulan" class="filter-select" onchange="filterData()">
            <option value="all">Semua Bulan</option>
            <option value="1">Januari</option>
            <option value="2">Februari</option>
            <option value="3">Maret</option>
            <option value="4">April</option>
            <option value="5">Mei</option>
            <option value="6">Juni</option>
            <option value="7">Juli</option>
            <option value="8">Agustus</option>
            <option value="9">September</option>
            <option value="10">Oktober</option>
            <option value="11">November</option>
            <option value="12">Desember</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Tanggal Dari</label>
          <input type="date" id="filterDari" class="filter-date" onchange="filterData()">
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Tanggal Sampai</label>
          <input type="date" id="filterSampai" class="filter-date" onchange="filterData()">
        </div>
      </div>
      
      <div class="recent-requests">
        <h3>üïê Permintaan Terbaru</h3>
        <ul class="recent-list" id="recentList">
          <!-- Data akan diisi dari Firebase -->
        </ul>
      </div>
    </div>

    <!-- Main Panel -->
    <div class="admin-main">
      <!-- Tabs Navigation -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="showTab('data')">üìã Data Packlaring</button>
        <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Pengaturan</button>
      </div>

      <!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-content active">
        <div class="dashboard-cards">
          <div class="card">
            <div class="card-icon">üìÑ</div>
            <div class="card-title">Total Surat</div>
            <div class="card-value" id="cardTotal">0</div>
            <div class="card-change" id="cardChange">+0% dari bulan lalu</div>
          </div>
          
          <div class="card">
            <div class="card-icon">‚è≥</div>
            <div class="card-title">Pending</div>
            <div class="card-value" id="cardPending">0</div>
            <div class="card-change">Perlu tindakan</div>
          </div>
          
          <div class="card">
            <div class="card-icon">‚úÖ</div>
            <div class="card-title">Selesai</div>
            <div class="card-value" id="cardCompleted">0</div>
            <div class="card-change" id="cardCompletedChange">+0%</div>
          </div>
          
          <div class="card">
            <div class="card-icon">üìà</div>
            <div class="card-title">Bulan Ini</div>
            <div class="card-value" id="cardThisMonth">0</div>
            <div class="card-change" id="cardMonthChange">vs bulan lalu</div>
          </div>
        </div>

        <div style="background: white; border-radius: 15px; padding: 25px; margin-top: 20px;">
          <h3 style="margin-bottom: 20px; color: #333;">üìà Statistik Bulanan</h3>
          <div id="chartContainer" style="height: 300px;">
            <canvas id="statsChart"></canvas>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
          <div style="background: white; border-radius: 15px; padding: 25px;">
            <h4 style="margin-bottom: 15px; color: #333;">üìã Aktivitas Terbaru</h4>
            <div id="activityList" style="max-height: 300px; overflow-y: auto;">
              <!-- Aktivitas akan ditampilkan di sini -->
            </div>
          </div>
          
          <div style="background: white; border-radius: 15px; padding: 25px;">
            <h4 style="margin-bottom: 15px; color: #333;">üèÜ Top Departemen</h4>
            <div id="departmentStats">
              <!-- Statistik departemen -->
            </div>
          </div>
        </div>
      </div>

      <!-- Data List Tab -->
      <div id="tab-data" class="tab-content">
        <div class="data-list-container active" id="dataListContainer">
          <div class="data-header">
            <h2>üìã Data Packlaring</h2>
            <div class="data-actions">
              <button class="btn btn-primary" onclick="refreshData()">
                üîÑ Refresh Data
              </button>
              <button class="btn btn-success" onclick="exportExcel()">
                üìä Export Excel
              </button>
              <button class="btn btn-warning" onclick="showAllData()">
                üëÅÔ∏è Tampilkan Semua
              </button>
            </div>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>No</th>
                <th>Nama Karyawan</th>
                <th>NIP</th>
                <th>No. Surat</th>
                <th>Tanggal</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
              <!-- Data akan diisi dari Firebase -->
            </tbody>
          </table>
        </div>

        <!-- Preview Surat -->
        <div class="preview-container" id="previewContainer">
          <div class="preview-header">
            <div class="preview-info">
              <h3 id="previewTitle">Surat Packlaring</h3>
              <p id="previewSubtitle">Detail surat packlaring karyawan</p>
            </div>
            <div class="data-actions">
              <button class="btn btn-primary" onclick="downloadPDF()">
                üì• Download PDF
              </button>
              <button class="btn btn-warning" onclick="printLetter()">
                üñ®Ô∏è Cetak Surat
              </button>
              <button class="btn btn-danger" onclick="closePreview()">
                ‚úñÔ∏è Tutup Preview
              </button>
            </div>
          </div>
          
          <!-- Template Surat - REVISI SESUAI PERMINTAAN -->
          <div id="letterTemplate" class="letter-container">
            <div class="letter-title">SURAT KETERANGAN KERJA</div>
            <div class="letter-title">CERTIFICATE OF EMPLOYMENT</div>
            <div class="letter-no" id="letterNo">
              NO : 02/SK-HRD/NEXT/I/25
            </div>

            <div class="letter-statement">
              Yang bertanda tangan di bawah ini:<br>
              <em>The undersigned below:</em>
            </div>

            <div class="letter-data-section">
              <div class="data-row">
                <div class="data-label">Nama</div>
                <div class="data-value">: <span id="fieldPenandatangan">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">Jabatan</div>
                <div class="data-value">: <span id="fieldJabatanPenandatangan">..............................................................</span></div>
              </div>
            </div>

            <div class="letter-statement" style="margin-top:0.6cm;">
              Dengan ini menerangkan bahwa:<br>
              <em>Hereby certifies that:</em>
            </div>

            <div class="letter-data-section">
              <div class="data-row">
                <div class="data-label">Nama Lengkap</div>
                <div class="data-value">: <span id="fieldNamaLengkap">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">Tempat/Tgl Lahir</div>
                <div class="data-value">: <span id="fieldTTL">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">Jabatan Terakhir</div>
                <div class="data-value">: <span id="fieldJabatan">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">Nomor Identitas</div>
                <div class="data-value">: <span id="fieldNIP">..............................................................</span></div>
              </div>
            </div>

            <div class="letter-statement">
              Adalah benar pernah bekerja di perusahaan kami sejak:<br>
              <em>Was employed at our company starting from:</em>
            </div>

            <div class="letter-data-section">
              <div class="data-row">
                <div class="data-label">Start Contract</div>
                <div class="data-value">: <span id="fieldTanggalMasuk">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">End Contract</div>
                <div class="data-value">: <span id="fieldTanggalKeluar">..............................................................</span></div>
              </div>
            </div>

            <div class="letter-statement">
              Alasan berhenti kerja : <span id="fieldAlasanBerhenti">Mengundurkan diri secara baik-baik / kontrak kerja berakhir</span><br>
              <em>Reason for leaving : <span id="fieldAlasanBerhentiEn">Resigned in good standing / end of contract</span></em>
            </div>

            <div class="letter-statement">
              Kami mengucapkan terimakasih atas kerjasama saudara selama bekerja dengan kami dan kami berharap saudara sukses dalam karir saudara di masa depan.
            </div>
            <div class="letter-statement" style="font-style:italic;">
              We would like to say thank you for your cooperation during work with us and we wish you success in your career in the future.
            </div>

            <!-- REVISI: Tanggal ditempel di atas Hormat Kami (jarak sangat dekat) -->
            <div class="letter-date-place" id="fieldTempatTanggal">
              Bekasi, 1 Desember 2025
            </div>

            <div class="letter-signature">
              Hormat kami,<br>
              <em>Sincerely,</em><br>

              <div class="letter-signature-name" id="fieldTandaTangan">M. Fajrian Noor</div>
              <span id="fieldJabatanTTD">Direktur</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="tab-settings" class="tab-content">
        <div style="background: white; border-radius: 15px; padding: 30px;">
          <h3 style="margin-bottom: 25px; color: #333;">‚öôÔ∏è Pengaturan Sistem</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üìß Notifikasi</h4>
              <div class="form-group">
                <label>Email Admin</label>
                <input type="email" id="emailAdmin" class="form-control" placeholder="admin@nextlogistik.com">
              </div>
              <div class="form-group">
                <label>Notifikasi WhatsApp</label>
                <input type="text" id="whatsappAdmin" class="form-control" value="081383796300" readonly>
              </div>
              <div class="form-group">
                <label>Auto Refresh (detik)</label>
                <select id="autoRefresh" class="form-control">
                  <option value="30">30 detik</option>
                  <option value="60" selected>60 detik</option>
                  <option value="300">5 menit</option>
                  <option value="600">10 menit</option>
                  <option value="0">Tidak auto refresh</option>
                </select>
              </div>
            </div>
            
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üìÑ Format Surat</h4>
              <div class="form-group">
                <label>Format Nomor Surat</label>
                <input type="text" id="formatNoSurat" class="form-control" value="{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}">
              </div>
              <div class="form-group">
                <label>Kota Tanda Tangan</label>
                <input type="text" id="kotaTandaTangan" class="form-control" value="Bekasi">
              </div>
              <div class="form-group">
                <label>Nama Default Penandatangan</label>
                <input type="text" id="defaultPenandatangan" class="form-control" value="M. Fajrian Noor">
              </div>
              <div class="form-group">
                <label>Jabatan Default</label>
                <input type="text" id="defaultJabatan" class="form-control" value="Direktur">
              </div>
            </div>
            
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üîß Sistem</h4>
              <div class="form-group">
                <label>Max Data per Halaman</label>
                <select id="maxData" class="form-control">
                  <option value="10">10 data</option>
                  <option value="25" selected>25 data</option>
                  <option value="50">50 data</option>
                  <option value="100">100 data</option>
                </select>
              </div>
              <div class="form-group">
                <label>Tampilkan Data Lama</label>
                <select id="showOldData" class="form-control">
                  <option value="30">30 hari terakhir</option>
                  <option value="90" selected>3 bulan terakhir</option>
                  <option value="180">6 bulan terakhir</option>
                  <option value="365">1 tahun terakhir</option>
                  <option value="0">Semua data</option>
                </select>
              </div>
              <div class="form-group">
                <label>Backup Otomatis</label>
                <select id="autoBackup" class="form-control">
                  <option value="daily">Setiap hari</option>
                  <option value="weekly" selected>Setiap minggu</option>
                  <option value="monthly">Setiap bulan</option>
                  <option value="never">Tidak pernah</option>
                </select>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="btn btn-success" onclick="saveSettings()" style="flex: 1;">
              üíæ Simpan Pengaturan
            </button>
            <button class="btn btn-warning" onclick="loadSettings()" style="flex: 1;">
              üîÑ Muat Ulang
            </button>
            <button class="btn btn-danger" onclick="resetSettings()" style="flex: 1;">
              üóëÔ∏è Reset Default
            </button>
          </div>
          
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
            <h4 style="margin-bottom: 15px; color: #555;">üìä Informasi Sistem</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div>
                <small style="color: #888;">Versi Sistem</small>
                <div><strong>v2.0.1</strong></div>
              </div>
              <div>
                <small style="color: #888;">Terakhir Update</small>
                <div><strong id="lastUpdate">-</strong></div>
              </div>
              <div>
                <small style="color: #888;">Database Size</small>
                <div><strong id="dbSize">-</strong></div>
              </div>
              <div>
                <small style="color: #888;">Status Koneksi</small>
                <div><strong id="connectionStatus">-</strong></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js untuk grafik -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase Configuration -->
<script>
  // Konfigurasi Firebase Anda
  const firebaseConfig = {
    apiKey: "AIzaSyAEvDR-h0hkgs1xAawra7u3jo9Sc3lCbpo",
    authDomain: "next-packlaring.firebaseapp.com",
    projectId: "next-packlaring",
    storageBucket: "next-packlaring.firebasestorage.app",
    messagingSenderId: "400584486436",
    appId: "1:400584486436:web:99067d2c6dc6d87ef7b2b1",
    measurementId: "G-KRFXBYN663"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Global Variables
  let allData = [];
  let filteredData = [];
  let selectedDocId = null;
  let selectedData = null;
  let statsChart = null;
  let autoRefreshInterval = null;
  let settings = {
    emailAdmin: "admin@nextlogistik.com",
    whatsappAdmin: "081383796300",
    autoRefresh: 60,
    formatNoSurat: "{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}",
    kotaTandaTangan: "Bekasi",
    defaultPenandatangan: "M. Fajrian Noor",
    defaultJabatan: "Direktur",
    maxData: 25,
    showOldData: 90,
    autoBackup: "weekly"
  };

  // Format tanggal Indonesia
  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return date.toLocaleDateString('id-ID', options);
  }

  function formatShortDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // Tab Navigation
  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Load data if needed
    if (tabName === 'dashboard') {
      updateDashboard();
    } else if (tabName === 'data') {
      renderDataTable();
    } else if (tabName === 'settings') {
      loadSettings();
    }
  }

  // Show Loading
  function showLoading(show) {
    document.getElementById('loading').classList.toggle('active', show);
  }

  // Show Notification
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const icon = notification.querySelector('.notification-icon');
    const content = notification.querySelector('.notification-content');
    const title = content.querySelector('h4');
    const text = content.querySelector('p');
    
    // Set icon based on type
    if (type === 'success') {
      icon.textContent = '‚úÖ';
      title.textContent = 'Berhasil';
    } else if (type === 'error') {
      icon.textContent = '‚ùå';
      title.textContent = 'Error';
    } else if (type === 'warning') {
      icon.textContent = '‚ö†Ô∏è';
      title.textContent = 'Peringatan';
    }
    
    text.textContent = message;
    notification.className = `notification ${type} show`;
    
    // Auto hide after 5 seconds
    setTimeout(() => {
      notification.classList.remove('show');
    }, 5000);
  }

  function hideNotification() {
    document.getElementById('notification').classList.remove('show');
  }

  // Load Data from Firebase
  async function loadData() {
    showLoading(true);
    
    try {
      const snapshot = await db.collection('packlaring')
        .orderBy('createdAt', 'desc')
        .get();
      
      allData = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        data.id = doc.id;
        
        // Convert Firestore timestamps to Date objects
        if (data.createdAt && data.createdAt.toDate) {
          data.createdAt = data.createdAt.toDate();
        }
        if (data.updatedAt && data.updatedAt.toDate) {
          data.updatedAt = data.updatedAt.toDate();
        }
        
        allData.push(data);
      });
      
      filteredData = [...allData];
      renderDataTable();
      updateStats();
      updateRecentList();
      updateDashboard();
      
      document.getElementById('connectionStatus').textContent = '‚úÖ Terhubung';
      document.getElementById('dbSize').textContent = `${allData.length} dokumen`;
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('id-ID');
      
    } catch (error) {
      console.error('Error loading data:', error);
      showNotification('Gagal memuat data: ' + error.message, 'error');
      document.getElementById('connectionStatus').textContent = '‚ùå Gagal';
    } finally {
      showLoading(false);
    }
  }

  // Render Data Table
  function renderDataTable() {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
            <h3>üì≠ Tidak Ada Data</h3>
            <p>Tidak ada data packlaring yang ditemukan.</p>
          </td>
        </tr>
      `;
      return;
    }
    
    // Apply pagination based on settings
    const maxData = parseInt(settings.maxData) || 25;
    const displayData = filteredData.slice(0, maxData);
    
    displayData.forEach((data, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><strong>${data.namaLengkap || '-'}</strong></td>
        <td>${data.nip || '-'}</td>
        <td>${data.noSurat || '-'}</td>
        <td>${formatShortDate(data.tanggalSurat || data.createdAt)}</td>
        <td>
          <span class="status-badge status-${data.status || 'pending'}">
            ${getStatusText(data.status)}
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-primary btn-small" onclick="viewLetter('${data.id}')">
              üëÅÔ∏è Lihat
            </button>
            <button class="btn btn-success btn-small" onclick="editStatus('${data.id}')">
              ‚úèÔ∏è Edit
            </button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    // Show more indicator if there are more data
    if (filteredData.length > maxData) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td colspan="7" style="text-align: center; padding: 15px; color: #666;">
          Menampilkan ${maxData} dari ${filteredData.length} data.
          <button class="btn btn-warning btn-small" onclick="showAllData()" style="margin-left: 10px;">
            Tampilkan Semua
          </button>
        </td>
      `;
      tbody.appendChild(row);
    }
  }

  // Get Status Text
  function getStatusText(status) {
    const statusMap = {
      'pending': '‚è≥ Pending',
      'processed': 'üîÑ Diproses',
      'completed': '‚úÖ Selesai'
    };
    return statusMap[status] || '‚è≥ Pending';
  }

  // Update Statistics
  function updateStats() {
    const total = allData.length;
    const pending = allData.filter(d => d.status === 'pending').length;
    const completed = allData.filter(d => d.status === 'completed').length;
    
    document.getElementById('totalData').textContent = total;
    document.getElementById('pendingData').textContent = pending;
    document.getElementById('completedData').textContent = completed;
  }

  // Update Recent List
  function updateRecentList() {
    const recentList = document.getElementById('recentList');
    recentList.innerHTML = '';
    
    const recentData = allData.slice(0, 10);
    
    recentData.forEach(data => {
      const li = document.createElement('li');
      li.className = 'recent-item';
      li.onclick = () => {
        viewLetter(data.id);
        showTab('data');
      };
      
      const date = formatShortDate(data.tanggalSurat || data.createdAt);
      li.innerHTML = `
        <strong>${data.namaLengkap || 'Tanpa Nama'}</strong><br>
        <small>${data.nip || 'No NIP'} ‚Ä¢ ${date}</small>
        <div style="margin-top: 5px;">
          <span class="status-badge status-${data.status || 'pending'}" style="font-size: 10px; padding: 2px 8px;">
            ${getStatusText(data.status)}
          </span>
        </div>
      `;
      recentList.appendChild(li);
    });
  }

  // Update Dashboard
  function updateDashboard() {
    // Update card values
    const total = allData.length;
    const pending = allData.filter(d => d.status === 'pending').length;
    const completed = allData.filter(d => d.status === 'completed').length;
    
    // This month data
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    const thisMonthData = allData.filter(d => {
      const date = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
      return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
    });
    
    // Last month data
    const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
    const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;
    const lastMonthData = allData.filter(d => {
      const date = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
      return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
    });
    
    // Calculate changes
    const totalChange = lastMonthData.length > 0 ? 
      (((thisMonthData.length - lastMonthData.length) / lastMonthData.length) * 100).toFixed(1) : 0;
    const completedChange = allData.length > 0 ? 
      ((completed / allData.length) * 100).toFixed(1) : 0;
    
    // Update cards
    document.getElementById('cardTotal').textContent = total;
    document.getElementById('cardPending').textContent = pending;
    document.getElementById('cardCompleted').textContent = completed;
    document.getElementById('cardThisMonth').textContent = thisMonthData.length;
    
    document.getElementById('cardChange').textContent = 
      `${totalChange >= 0 ? '+' : ''}${totalChange}% dari bulan lalu`;
    document.getElementById('cardChange').className = 
      `card-change ${totalChange >= 0 ? '' : 'negative'}`;
    
    document.getElementById('cardCompletedChange').textContent = `${completedChange}% selesai`;
    
    document.getElementById('cardMonthChange').textContent = 
      lastMonthData.length > 0 ? 
      `+${(thisMonthData.length - lastMonthData.length)} dari bulan lalu` : 
      'Data bulan lalu tidak tersedia';
    
    // Update chart
    updateChart();
    
    // Update activity list
    updateActivityList();
    
    // Update department stats
    updateDepartmentStats();
  }

  // Update Chart
  function updateChart() {
    const ctx = document.getElementById('statsChart');
    
    // Destroy existing chart
    if (statsChart) {
      statsChart.destroy();
    }
    
    // Prepare monthly data
    const now = new Date();
    const months = [];
    const monthData = { pending: [], processed: [], completed: [] };
    
    // Get last 6 months
    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleDateString('id-ID', { month: 'short' });
      months.push(monthName);
      
      // Filter data for this month
      const monthDataFiltered = allData.filter(d => {
        const dataDate = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
        return dataDate.getMonth() === date.getMonth() && 
               dataDate.getFullYear() === date.getFullYear();
      });
      
      monthData.pending.push(monthDataFiltered.filter(d => d.status === 'pending').length);
      monthData.processed.push(monthDataFiltered.filter(d => d.status === 'processed').length);
      monthData.completed.push(monthDataFiltered.filter(d => d.status === 'completed').length);
    }
    
    // Create new chart
    statsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Pending',
            data: monthData.pending,
            backgroundColor: '#ffc107',
            borderColor: '#ffc107',
            borderWidth: 1
          },
          {
            label: 'Diproses',
            data: monthData.processed,
            backgroundColor: '#17a2b8',
            borderColor: '#17a2b8',
            borderWidth: 1
          },
          {
            label: 'Selesai',
            data: monthData.completed,
            backgroundColor: '#28a745',
            borderColor: '#28a745',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'Statistik Packlaring 6 Bulan Terakhir'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // Update Activity List
  function updateActivityList() {
    const activityList = document.getElementById('activityList');
    activityList.innerHTML = '';
    
    // Sort by date (newest first) and take 10
    const sortedData = [...allData].sort((a, b) => {
      const dateA = a.updatedAt || a.createdAt;
      const dateB = b.updatedAt || b.createdAt;
      return dateB - dateA;
    }).slice(0, 10);
    
    sortedData.forEach(data => {
      const activity = document.createElement('div');
      activity.style.padding = '10px 0';
      activity.style.borderBottom = '1px solid #eee';
      
      const timeAgo = getTimeAgo(data.updatedAt || data.createdAt);
      const statusIcon = data.status === 'completed' ? '‚úÖ' : 
                        data.status === 'processed' ? 'üîÑ' : '‚è≥';
      
      activity.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="font-size: 20px;">${statusIcon}</div>
          <div style="flex: 1;">
            <strong>${data.namaLengkap || 'Tanpa Nama'}</strong><br>
            <small style="color: #666;">${data.noSurat || 'No Surat'} ‚Ä¢ ${timeAgo}</small>
          </div>
        </div>
      `;
      
      activityList.appendChild(activity);
    });
    
    if (sortedData.length === 0) {
      activityList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada aktivitas</p>';
    }
  }

  // Get Time Ago
  function getTimeAgo(date) {
    if (!date) return '-';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) {
      return `${diffMins} menit lalu`;
    } else if (diffHours < 24) {
      return `${diffHours} jam lalu`;
    } else if (diffDays < 7) {
      return `${diffDays} hari lalu`;
    } else {
      return formatShortDate(date);
    }
  }

  // Update Department Stats
  function updateDepartmentStats() {
    const departmentStats = document.getElementById('departmentStats');
    
    // Count by department
    const deptCount = {};
    allData.forEach(data => {
      const dept = data.deptKaryawan || 'Tidak Diketahui';
      deptCount[dept] = (deptCount[dept] || 0) + 1;
    });
    
    // Sort by count
    const sortedDepts = Object.entries(deptCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    departmentStats.innerHTML = '';
    
    sortedDepts.forEach(([dept, count], index) => {
      const percentage = ((count / allData.length) * 100).toFixed(1);
      const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìä';
      
      const stat = document.createElement('div');
      stat.style.marginBottom = '15px';
      stat.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>${medal} ${dept}</span>
          <span><strong>${count}</strong> (${percentage}%)</span>
        </div>
        <div style="height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
          <div style="height: 100%; width: ${percentage}%; background: ${getDeptColor(index)};"></div>
        </div>
      `;
      
      departmentStats.appendChild(stat);
    });
    
    if (sortedDepts.length === 0) {
      departmentStats.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada data departemen</p>';
    }
  }

  // Get Department Color
  function getDeptColor(index) {
    const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
    return colors[index % colors.length];
  }

  // Filter Data
  function filterData() {
    const statusFilter = document.getElementById('filterStatus').value;
    const bulanFilter = document.getElementById('filterBulan').value;
    const dariFilter = document.getElementById('filterDari').value;
    const sampaiFilter = document.getElementById('filterSampai').value;
    const searchFilter = document.getElementById('searchInput').value.toLowerCase();
    
    filteredData = allData.filter(data => {
      // Filter by status
      if (statusFilter !== 'all' && data.status !== statusFilter) {
        return false;
      }
      
      // Filter by month
      if (bulanFilter !== 'all') {
        const date = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (date && (date.getMonth() + 1) !== parseInt(bulanFilter)) {
          return false;
        }
      }
      
      // Filter by date range
      if (dariFilter) {
        const dariDate = new Date(dariFilter);
        const dataDate = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (dataDate && dataDate < dariDate) {
          return false;
        }
      }
      
      if (sampaiFilter) {
        const sampaiDate = new Date(sampaiFilter);
        sampaiDate.setHours(23, 59, 59);
        const dataDate = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (dataDate && dataDate > sampaiDate) {
          return false;
        }
      }
      
      // Filter by search
      if (searchFilter) {
        const searchStr = `${data.namaLengkap || ''} ${data.nip || ''} ${data.noSurat || ''} ${data.jabatan || ''}`.toLowerCase();
        if (!searchStr.includes(searchFilter)) {
          return false;
        }
      }
      
      return true;
    });
    
    renderDataTable();
  }

  // Search Function
  document.getElementById('searchInput').addEventListener('input', function() {
    filterData();
  });

  // View Letter
  async function viewLetter(docId) {
    showLoading(true);
    
    try {
      const doc = await db.collection('packlaring').doc(docId).get();
      if (!doc.exists) {
        throw new Error('Dokumen tidak ditemukan');
      }
      
      selectedDocId = docId;
      selectedData = doc.data();
      
      // Convert timestamps
      if (selectedData.createdAt && selectedData.createdAt.toDate) {
        selectedData.createdAt = selectedData.createdAt.toDate();
      }
      
      // Update preview title
      document.getElementById('previewTitle').textContent = 
        `Surat Packlaring - ${selectedData.namaLengkap || 'Tidak Ada Nama'}`;
      document.getElementById('previewSubtitle').textContent = 
        `NIP: ${selectedData.nip || '-'} ‚Ä¢ ${formatDate(selectedData.tanggalSurat)}`;
      
      // Populate letter template
      populateLetterTemplate(selectedData);
      
      // Show preview container
      document.getElementById('dataListContainer').classList.remove('active');
      document.getElementById('previewContainer').classList.add('active');
      
    } catch (error) {
      console.error('Error viewing letter:', error);
      showNotification('Gagal memuat surat: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Populate Letter Template - DIPERBAIKI
  function populateLetterTemplate(data) {
    // Format tanggal untuk Indonesia
    function formatLetterDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const bulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                     'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      return `${date.getDate()} ${bulan[date.getMonth()]} ${date.getFullYear()}`;
    }
    
    // Format TTL
    const tempatLahir = data.tempatLahir || '-';
    const tglLahir = data.tanggalLahir ? formatLetterDate(data.tanggalLahir) : '-';
    
    // Format alasan berhenti dalam dua bahasa
    const alasanBerhentiMap = {
      'Kontrak Berakhir': { id: 'Kontrak kerja berakhir', en: 'End of contract' },
      'PHK': { id: 'Pemutusan Hubungan Kerja', en: 'Termination of employment' },
      'Pengunduran Diri': { id: 'Mengundurkan diri secara baik-baik', en: 'Resigned in good standing' },
      'Pensiun': { id: 'Pensiun', en: 'Retirement' },
      'Meninggal Dunia': { id: 'Meninggal dunia', en: 'Deceased' }
    };
    
    const alasanBerhenti = alasanBerhentiMap[data.alasanBerhenti] || 
                          { id: data.alasanBerhenti || 'Kontrak kerja berakhir', 
                            en: data.alasanBerhenti || 'End of contract' };
    
    // Set values - HANYA UNTUK ELEMEN YANG ADA DI TEMPLATE
    document.getElementById('letterNo').textContent = `NO : ${data.noSurat || '02/SK-HRD/NEXT/I/25'}`;
    document.getElementById('fieldPenandatangan').textContent = data.namaPenandatangan || settings.defaultPenandatangan;
    document.getElementById('fieldJabatanPenandatangan').textContent = data.jabatanPenandatangan || settings.defaultJabatan;
    document.getElementById('fieldNamaLengkap').textContent = data.namaLengkap || '.................................................';
    document.getElementById('fieldTTL').textContent = `${tempatLahir}, ${tglLahir}`;
    document.getElementById('fieldJabatan').textContent = data.jabatan || '.................................................';
    document.getElementById('fieldNIP').textContent = data.nip || '.................................................';
    document.getElementById('fieldTanggalMasuk').textContent = data.tanggalMulai ? formatLetterDate(data.tanggalMulai) : '.................................................';
    document.getElementById('fieldTanggalKeluar').textContent = data.tanggalBerakhir ? formatLetterDate(data.tanggalBerakhir) : '.................................................';
    document.getElementById('fieldAlasanBerhenti').textContent = alasanBerhenti.id;
    document.getElementById('fieldAlasanBerhentiEn').textContent = alasanBerhenti.en;
    document.getElementById('fieldTempatTanggal').textContent = `${settings.kotaTandaTangan}, ${formatLetterDate(data.tanggalSurat || new Date())}`;
    document.getElementById('fieldTandaTangan').textContent = data.namaPenandatangan || settings.defaultPenandatangan;
    document.getElementById('fieldJabatanTTD').textContent = data.jabatanPenandatangan || settings.defaultJabatan;
  }

  // Close Preview
  function closePreview() {
    document.getElementById('previewContainer').classList.remove('active');
    document.getElementById('dataListContainer').classList.add('active');
  }

  // Download PDF
  async function downloadPDF() {
    showLoading(true);
    
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      // Get the letter template
      const element = document.getElementById('letterTemplate');
      
      // Convert to canvas with higher quality
      const canvas = await html2canvas(element, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true,
        logging: false
      });
      
      // Get image data
      const imgData = canvas.toDataURL('image/png');
      
      // Calculate dimensions
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pdfWidth - 20; // 10mm margin each side
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      // Add image to PDF
      pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
      
      // Generate filename
      const fileName = `Packlaring_${selectedData.nip || 'NoNIP'}_${selectedData.namaLengkap?.replace(/\s+/g, '_') || 'NoName'}.pdf`;
      
      // Save PDF
      pdf.save(fileName);
      
      // Update status to completed if it was pending
      if (selectedData.status === 'pending') {
        await db.collection('packlaring').doc(selectedDocId).update({
          status: 'completed',
          downloadedAt: new Date(),
          downloadedBy: 'Admin'
        });
        
        // Reload data
        loadData();
      }
      
      showNotification('PDF berhasil didownload!', 'success');
      
    } catch (error) {
      console.error('Error downloading PDF:', error);
      showNotification('Gagal download PDF: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Print Letter
  function printLetter() {
    const printContent = document.getElementById('letterTemplate').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    
    // Restore preview
    document.getElementById('previewContainer').classList.add('active');
    document.getElementById('dataListContainer').classList.remove('active');
  }

  // Edit Status Modal
  function editStatus(docId) {
    selectedDocId = docId;
    const data = allData.find(d => d.id === docId);
    
    if (data) {
      document.getElementById('editStatus').value = data.status || 'pending';
      document.getElementById('editCatatan').value = data.catatanAdmin || '';
      document.getElementById('editTanggal').value = new Date().toISOString().split('T')[0];
      
      document.getElementById('editModal').classList.add('active');
    }
  }

  function closeModal() {
    document.getElementById('editModal').classList.remove('active');
  }

  // Update Status
  async function updateStatus() {
    showLoading(true);
    
    try {
      const newStatus = document.getElementById('editStatus').value;
      const catatan = document.getElementById('editCatatan').value;
      const tanggal = document.getElementById('editTanggal').value;
      
      await db.collection('packlaring').doc(selectedDocId).update({
        status: newStatus,
        catatanAdmin: catatan,
        updatedAt: new Date(),
        updatedBy: 'Admin',
        tanggalUpdate: tanggal
      });
      
      closeModal();
      loadData();
      
      showNotification('Status berhasil diperbarui!', 'success');
      
    } catch (error) {
      console.error('Error updating status:', error);
      showNotification('Gagal update status: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Export to Excel
  function exportExcel() {
    // Prepare data
    const exportData = filteredData.map(data => ({
      'No Surat': data.noSurat || '',
      'Nama Karyawan': data.namaLengkap || '',
      'NIP': data.nip || '',
      'Jabatan': data.jabatan || '',
      'Departemen': data.deptKaryawan || '',
      'Tempat Lahir': data.tempatLahir || '',
      'Tanggal Lahir': formatShortDate(data.tanggalLahir),
      'Tanggal Mulai': formatShortDate(data.tanggalMulai),
      'Tanggal Berakhir': formatShortDate(data.tanggalBerakhir),
      'Alasan Berhenti': data.alasanBerhenti || '',
      'Status': getStatusText(data.status),
      'Tanggal Surat': formatShortDate(data.tanggalSurat),
      'Penandatangan': data.namaPenandatangan || '',
      'Jabatan Penandatangan': data.jabatanPenandatangan || '',
      'Tanggal Input': formatShortDate(data.createdAt)
    }));
    
    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(exportData);
    
    // Set column widths
    const wscols = [
      {wch: 20}, // No Surat
      {wch: 25}, // Nama Karyawan
      {wch: 15}, // NIP
      {wch: 20}, // Jabatan
      {wch: 15}, // Departemen
      {wch: 15}, // Tempat Lahir
      {wch: 15}, // Tanggal Lahir
      {wch: 15}, // Tanggal Mulai
      {wch: 15}, // Tanggal Berakhir
      {wch: 20}, // Alasan Berhenti
      {wch: 15}, // Status
      {wch: 15}, // Tanggal Surat
      {wch: 20}, // Penandatangan
      {wch: 20}, // Jabatan Penandatangan
      {wch: 15}  // Tanggal Input
    ];
    ws['!cols'] = wscols;
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data Packlaring");
    
    // Generate filename
    const fileName = `Data_Packlaring_${new Date().toISOString().slice(0,10)}.xlsx`;
    
    // Save file
    XLSX.writeFile(wb, fileName);
    
    showNotification('Data berhasil diexport ke Excel!', 'success');
  }

  // Show All Data
  function showAllData() {
    // Show all data without pagination
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    
    filteredData.forEach((data, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><strong>${data.namaLengkap || '-'}</strong></td>
        <td>${data.nip || '-'}</td>
        <td>${data.noSurat || '-'}</td>
        <td>${formatShortDate(data.tanggalSurat || data.createdAt)}</td>
        <td>
          <span class="status-badge status-${data.status || 'pending'}">
            ${getStatusText(data.status)}
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-primary btn-small" onclick="viewLetter('${data.id}')">
              üëÅÔ∏è Lihat
            </button>
            <button class="btn btn-success btn-small" onclick="editStatus('${data.id}')">
              ‚úèÔ∏è Edit
            </button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    showNotification(`Menampilkan semua ${filteredData.length} data`, 'success');
  }

  // Refresh Data
  function refreshData() {
    loadData();
  }

  // Load Settings
  function loadSettings() {
    // Load from localStorage
    const savedSettings = localStorage.getItem('packlaringAdminSettings');
    if (savedSettings) {
      settings = JSON.parse(savedSettings);
    }
    
    // Apply to form
    document.getElementById('emailAdmin').value = settings.emailAdmin;
    document.getElementById('whatsappAdmin').value = settings.whatsappAdmin;
    document.getElementById('autoRefresh').value = settings.autoRefresh;
    document.getElementById('formatNoSurat').value = settings.formatNoSurat;
    document.getElementById('kotaTandaTangan').value = settings.kotaTandaTangan;
    document.getElementById('defaultPenandatangan').value = settings.defaultPenandatangan;
    document.getElementById('defaultJabatan').value = settings.defaultJabatan;
    document.getElementById('maxData').value = settings.maxData;
    document.getElementById('showOldData').value = settings.showOldData;
    document.getElementById('autoBackup').value = settings.autoBackup;
    
    // Setup auto refresh
    setupAutoRefresh();
  }

  // Save Settings
  function saveSettings() {
    settings.emailAdmin = document.getElementById('emailAdmin').value;
    settings.whatsappAdmin = document.getElementById('whatsappAdmin').value;
    settings.autoRefresh = document.getElementById('autoRefresh').value;
    settings.formatNoSurat = document.getElementById('formatNoSurat').value;
    settings.kotaTandaTangan = document.getElementById('kotaTandaTangan').value;
    settings.defaultPenandatangan = document.getElementById('defaultPenandatangan').value;
    settings.defaultJabatan = document.getElementById('defaultJabatan').value;
    settings.maxData = document.getElementById('maxData').value;
    settings.showOldData = document.getElementById('showOldData').value;
    settings.autoBackup = document.getElementById('autoBackup').value;
    
    localStorage.setItem('packlaringAdminSettings', JSON.stringify(settings));
    
    setupAutoRefresh();
    
    showNotification('Pengaturan berhasil disimpan!', 'success');
  }

  // Reset Settings
  function resetSettings() {
    if (confirm('Apakah Anda yakin ingin mereset pengaturan ke default?')) {
      settings = {
        emailAdmin: "admin@nextlogistik.com",
        whatsappAdmin: "081383796300",
        autoRefresh: 60,
        formatNoSurat: "{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}",
        kotaTandaTangan: "Bekasi",
        defaultPenandatangan: "M. Fajrian Noor",
        defaultJabatan: "Direktur",
        maxData: 25,
        showOldData: 90,
        autoBackup: "weekly"
      };
      
      localStorage.setItem('packlaringAdminSettings', JSON.stringify(settings));
      loadSettings();
      
      showNotification('Pengaturan berhasil direset ke default!', 'success');
    }
  }

  // Setup Auto Refresh
  function setupAutoRefresh() {
    // Clear existing interval
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
    
    // Setup new interval if not 0
    const refreshSeconds = parseInt(settings.autoRefresh);
    if (refreshSeconds > 0) {
      autoRefreshInterval = setInterval(() => {
        loadData();
      }, refreshSeconds * 1000);
      
      console.log(`Auto refresh diatur setiap ${refreshSeconds} detik`);
    }
  }

  // Initialize Admin Panel
  document.addEventListener('DOMContentLoaded', function() {
    // Set default dates for filter
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setMonth(today.getMonth() - 1);
    
    document.getElementById('filterDari').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('filterSampai').value = today.toISOString().split('T')[0];
    
    // Load initial data
    loadData();
    loadSettings();
    
    // Setup auto refresh
    setupAutoRefresh();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl + R untuk refresh
      if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        refreshData();
      }
      
      // Ctrl + F untuk focus search
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
      }
      
      // Escape untuk close modal
      if (e.key === 'Escape') {
        closeModal();
        closePreview();
      }
    });
  });
</script>
</body>
</html>
