<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Next Project - NEXT Cargo Logistics</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <!-- jsPDF untuk download PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas untuk konversi ke gambar -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Chart.js untuk grafik -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font Awesome untuk ikon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
    color: #333;
    min-height: 100vh;
    padding: 20px;
}

.admin-container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    overflow: hidden;
}

/* Header Admin */
.admin-header {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    padding: 25px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.company-brand {
    display: flex;
    align-items: center;
    gap: 15px;
}

.company-logo {
    font-size: 36px;
    font-weight: bold;
    background: white;
    color: #e74c3c;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.company-info h1 {
    font-size: 24px;
    margin-bottom: 5px;
}

.company-info .subtitle {
    font-size: 14px;
    opacity: 0.9;
}

.admin-stats {
    display: flex;
    gap: 20px;
    background: rgba(255, 255, 255, 0.1);
    padding: 15px 25px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 28px;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 12px;
    opacity: 0.8;
}

/* Main Content */
.admin-content {
    display: grid;
    grid-template-columns: 350px 1fr;
    min-height: 800px;
}

/* Sidebar */
.admin-sidebar {
    background: #f8f9fa;
    border-right: 1px solid #e0e0e0;
    padding: 30px;
}

.search-box {
    margin-bottom: 30px;
}

.search-input {
    width: 100%;
    padding: 15px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 16px;
    background: white;
    transition: all 0.3s;
}

.search-input:focus {
    outline: none;
    border-color: #e74c3c;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
}

.filter-section {
    margin-bottom: 30px;
}

.filter-section h3 {
    color: #333;
    margin-bottom: 15px;
    font-size: 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.filter-group {
    margin-bottom: 20px;
}

.filter-label {
    display: block;
    margin-bottom: 8px;
    color: #555;
    font-weight: 500;
}

.filter-select,
.filter-date {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: white;
    font-size: 14px;
}

.recent-requests {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.recent-requests h3 {
    color: #333;
    margin-bottom: 15px;
    font-size: 16px;
}

.recent-list {
    list-style: none;
    max-height: 300px;
    overflow-y: auto;
}

.recent-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
}

.recent-item:hover {
    background: #f8f9fa;
}

.recent-item.active {
    background: #e74c3c;
    color: white;
    border-radius: 6px;
}

/* Main Panel */
.admin-main {
    padding: 30px;
    background: #fff;
    overflow-x: auto;
}

/* Data List */
.data-list-container {
    display: none;
}

.data-list-container.active {
    display: block;
}

.data-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    flex-wrap: wrap;
    gap: 15px;
}

.data-header h2 {
    color: #333;
    font-size: 22px;
}

.data-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-success:hover {
    background: #219653;
    transform: translateY(-2px);
}

.btn-warning {
    background: #f39c12;
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
    transform: translateY(-2px);
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
    transform: translateY(-2px);
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #138496;
    transform: translateY(-2px);
}

/* FIX: Data Table Container */
.data-table-container {
    overflow-x: auto;
    margin-top: 20px;
    border-radius: 12px;
    background: white;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    width: 100%;
    min-width: 1400px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: #2c3e50;
    color: white;
    padding: 18px 15px;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 13px;
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    cursor: pointer;
    transition: background 0.3s;
}

.data-table th:hover {
    background: #1a252f;
}

.data-table th.sort-asc::after {
    content: " ‚Üë";
    font-size: 12px;
}

.data-table th.sort-desc::after {
    content: " ‚Üì";
    font-size: 12px;
}

.data-table td {
    padding: 18px 15px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
    white-space: nowrap;
}

.data-table tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-processed {
    background: #d1ecf1;
    color: #0c5460;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: nowrap;
}

.btn-small {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 6px;
    white-space: nowrap;
}

/* Pagination Styles */
.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
}

.pagination-info {
    font-size: 14px;
    color: #555;
}

.pagination-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.pagination-btn {
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

.pagination-btn:hover:not(:disabled) {
    background: #e74c3c;
    color: white;
    border-color: #e74c3c;
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-numbers {
    display: flex;
    gap: 5px;
}

.page-number {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.page-number:hover {
    background: #f0f0f0;
}

.page-number.active {
    background: #e74c3c;
    color: white;
    border-color: #e74c3c;
}

/* Preview Container */
.preview-container {
    display: none;
    background: #f5f5f5;
    padding: 30px;
    border-radius: 15px;
    margin-top: 30px;
}

.preview-container.active {
    display: block;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.preview-info h3 {
    color: #333;
    margin-bottom: 10px;
    font-size: 20px;
}

.preview-info p {
    color: #666;
    font-size: 14px;
}

/* Template Styling */
.letter-container {
    width: 210mm;
    min-height: 297mm;
    margin: 0 auto;
    padding: 20mm;
    box-sizing: border-box;
    position: relative;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    background: url('./template/next.png');
    filter: brightness(1.1);
    background-size: 100% 100%;
    background-position: center center;
    background-repeat: no-repeat;
    background-attachment: scroll;
    background-origin: padding-box;
    background-clip: padding-box;
    font-size: 11pt;
    line-height: 1.5;
    color: #333333;
}

.letter-header {
    display: none;
}

.letter-title {
    text-align: center;
    font-size: 14pt;
    font-weight: bold;
    margin: 0 0 0.1cm 0;
    text-transform: uppercase;
    color: #000000;
    line-height: 1;
}

.letter-title:nth-of-type(2) {
    font-size: 12pt;
    margin-bottom: 0.1cm;
}

.letter-no {
    text-align: center;
    font-size: 10pt;
    margin-bottom: 0.8cm;
    color: #333;
    font-weight: bold;
}

.letter-data-section {
    margin-bottom: 0.2cm;
}

.data-row {
    display: flex;
    margin-bottom: 3px;
    align-items: flex-start;
    min-height: 22px;
}

.data-label {
    width: 35%;
    font-weight: bold;
    padding-right: 10px;
    white-space: nowrap;
    font-size: 11pt;
}

.data-value {
    width: 65%;
    padding-bottom: 2px;
    border-bottom: 1px dotted #777;
    min-height: 1.2em;
    font-size: 11pt;
}

.letter-statement {
    text-align: justify;
    margin: 0.4cm 0;
    text-indent: 40px;
    line-height: 1.5;
    font-size: 11pt;
}

.letter-statement-field {
    margin-top: 1cm;
    padding-bottom: 2px;
    text-align: center;
}

.letter-date-place {
    margin-top: 1cm;
    text-align: left;
    margin-bottom: 0;
    font-size: 11pt;
}

.letter-signature {
    text-align: left;
    margin-top: 0.1cm;
    font-size: 12pt;
}

.letter-signature-name {
    margin-top: 3cm;
    text-decoration: underline;
    font-weight: bold;
    font-size: 12pt;
}

.letter-footer {
    position: absolute;
    bottom: 1.2cm;
    left: 2cm;
    right: 2cm;
    font-size: 9pt;
    color: #555;
    text-align: center;
    border-top: 1px solid #aaa;
    padding-top: 0.4cm;
}

.social-icons {
    margin-top: 8px;
    display: flex;
    justify-content: center;
    gap: 15px;
}

.social-icons a {
    color: #555;
    font-size: 12pt;
    transition: color 0.3s;
    text-decoration: none;
}

.social-icons a:hover {
    color: #e74c3c;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 25px 30px;
    background: #2c3e50;
    color: white;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 20px;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 30px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #333;
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    background: #f8f9fa;
}

/* Extended Edit Modal */
.extended-edit-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.extended-edit-form .form-group.full-width {
    grid-column: 1 / -1;
}

/* Responsive */
@media (max-width: 1200px) {
    .admin-content {
        grid-template-columns: 1fr;
    }

    .admin-sidebar {
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
    }

    .letter-container {
        width: 100%;
        padding: 2cm;
    }
}

@media (max-width: 992px) {
    .data-table-container {
        min-width: 100%;
    }
    
    .data-table {
        min-width: 1400px;
    }
}

@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }

    .admin-stats {
        width: 100%;
        justify-content: center;
    }

    .data-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .data-actions {
        width: 100%;
    }

    .btn {
        flex: 1;
        justify-content: center;
    }

    .pagination-container {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }

    .page-numbers {
        flex-wrap: wrap;
        justify-content: center;
    }

    .letter-container {
        padding: 1.5cm;
        background-size: cover;
    }

    .data-row {
        flex-direction: column;
        margin-bottom: 10px;
    }

    .data-label,
    .data-value {
        width: 100%;
    }

    .data-label {
        padding-right: 0;
        margin-bottom: 2px;
    }
    
    .extended-edit-form {
        grid-template-columns: 1fr;
    }
}

/* Printing Styles */
@media print {
    body * {
        visibility: hidden;
    }

    .preview-container,
    .preview-container * {
        visibility: visible;
    }

    .preview-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white;
        padding: 0;
        margin: 0;
        box-shadow: none;
    }

    .preview-header {
        display: none;
    }

    .letter-container {
        box-shadow: none;
        margin: 0;
        padding: 20mm;
        width: 210mm;
        min-height: 297mm;
        background: white !important;
    }

    .letter-container::before {
        display: none;
    }

    .btn {
        display: none;
    }
}

/* Loading */
.loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    flex-direction: column;
}

.loading.active {
    display: flex;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #e74c3c;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 1001;
    transform: translateX(400px);
    transition: transform 0.3s;
}

.notification.show {
    transform: translateX(0);
}

.notification.success {
    border-left: 5px solid #27ae60;
}

.notification.error {
    border-left: 5px solid #e74c3c;
}

.notification.warning {
    border-left: 5px solid #f39c12;
}

.notification-icon {
    font-size: 24px;
}

.notification.success .notification-icon {
    color: #27ae60;
}

.notification.error .notification-icon {
    color: #e74c3c;
}

.notification.warning .notification-icon {
    color: #f39c12;
}

.notification-content h4 {
    margin: 0 0 5px 0;
    color: #333;
}

.notification-content p {
    margin: 0;
    color: #666;
    font-size: 14px;
}

.notification-close {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    font-size: 20px;
    padding: 0;
    margin-left: 10px;
}

/* Tabs */
.tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 12px 24px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    color: #666;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.tab-btn:hover {
    color: #e74c3c;
}

.tab-btn.active {
    color: #e74c3c;
    border-bottom-color: #e74c3c;
}

.tab-content {
    display: none;
    animation: fadeIn 0.5s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
}

/* Dashboard Cards */
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s;
}

.card:hover {
    transform: translateY(-5px);
}

.card-icon {
    font-size: 40px;
    margin-bottom: 15px;
}

.card-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.card-value {
    font-size: 32px;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.card-change {
    font-size: 12px;
    color: #27ae60;
}

.card-change.negative {
    color: #e74c3c;
}

/* Storage Info Card */
.storage-card {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
}

.storage-card .card-icon {
    color: white;
}

.storage-card .card-title {
    color: rgba(255, 255, 255, 0.9);
}

.storage-card .card-value {
    color: white;
}

.storage-progress {
    height: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    margin-top: 15px;
    overflow: hidden;
}

.storage-progress-bar {
    height: 100%;
    background: white;
    border-radius: 4px;
    transition: width 0.3s;
}

.storage-details {
    margin-top: 10px;
    font-size: 12px;
    opacity: 0.9;
}

/* Activity and Province Stats */
.activity-item, .province-item {
    padding: 10px 0;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    gap: 10px;
}

.activity-item:last-child, .province-item:last-child {
    border-bottom: none;
}

.activity-icon, .province-icon {
    font-size: 20px;
    width: 40px;
    text-align: center;
}

.activity-content, .province-content {
    flex: 1;
}

.province-bar {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    margin-top: 5px;
    overflow: hidden;
}

.province-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s;
}

/* Province Colors */
.province-color-0 { background: #e74c3c; }
.province-color-1 { background: #3498db; }
.province-color-2 { background: #2ecc71; }
.province-color-3 { background: #f39c12; }
.province-color-4 { background: #9b59b6; }
.province-color-5 { background: #1abc9c; }
.province-color-6 { background: #d35400; }
.province-color-7 { background: #c0392b; }
.province-color-8 { background: #16a085; }
.province-color-9 { background: #8e44ad; }
</style>
<body>

<!-- Loading Screen -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <p style="color: #e74c3c; font-weight: bold; margin-top: 10px;">Memuat data...</p>
</div>

<!-- Notification -->
<div class="notification" id="notification">
  <div class="notification-icon">üîî</div>
  <div class="notification-content">
    <h4>Notifikasi</h4>
    <p>Pesan notifikasi</p>
  </div>
  <button class="notification-close" onclick="hideNotification()">√ó</button>
</div>

<!-- Modal Edit Data Lengkap -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è Edit Data Lengkap</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form id="editForm" class="extended-edit-form">
        <!-- Data Pribadi -->
        <div class="form-group">
          <label>Nama Lengkap</label>
          <input type="text" id="editNamaLengkap" class="form-control" placeholder="Nama Lengkap">
        </div>
        <div class="form-group">
          <label>NIP</label>
          <input type="text" id="editNIP" class="form-control" placeholder="NIP">
        </div>
        
        <!-- Data Surat -->
        <div class="form-group">
          <label>Nomor Surat</label>
          <input type="text" id="editNoSurat" class="form-control" placeholder="Nomor Surat">
        </div>
        <div class="form-group">
          <label>Tanggal Surat</label>
          <input type="date" id="editTanggalSurat" class="form-control">
        </div>
        
        <!-- Data Kontak -->
        <div class="form-group">
          <label>WhatsApp</label>
          <input type="text" id="editWhatsapp" class="form-control" placeholder="WhatsApp">
        </div>
        <div class="form-group">
          <label>Provinsi/Wilayah</label>
          <input type="text" id="editWilayah" class="form-control" placeholder="Provinsi/Wilayah">
        </div>
        
        <!-- Data Teknisi -->
        <div class="form-group">
          <label>Kabupaten (Khusus Teknisi)</label>
          <input type="text" id="editKabupaten" class="form-control" placeholder="Nama Kabupaten">
        </div>
        <div class="form-group">
          <label>Koordinator (Khusus Teknisi)</label>
          <input type="text" id="editKoordinator" class="form-control" placeholder="Nama Koordinator">
        </div>
        
        <!-- Keterangan -->
        <div class="form-group full-width">
          <label>Keterangan User</label>
          <textarea id="editKeterangan" class="form-control" rows="3" placeholder="Keterangan yang diinputkan user..."></textarea>
        </div>
        
        <!-- Status -->
        <div class="form-group full-width">
          <label>Status Surat</label>
          <select id="editStatus" class="form-control">
            <option value="pending">‚è≥ Pending</option>
            <option value="processed">üîÑ Dalam Proses</option>
            <option value="completed">‚úÖ Selesai</option>
          </select>
        </div>
        
        <!-- Catatan -->
        <div class="form-group full-width">
          <label>Catatan Admin</label>
          <textarea id="editCatatan" class="form-control" rows="4" placeholder="Tambahkan catatan jika perlu..."></textarea>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
          <button type="button" class="btn btn-primary" onclick="updateData()" style="flex: 1;">
            üíæ Simpan Perubahan
          </button>
          <button type="button" class="btn btn-danger" onclick="closeModal()" style="flex: 1;">
            ‚ùå Batal
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Detail Data -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üìã Detail Lengkap Data</h3>
      <button class="modal-close" onclick="closeDetailModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div id="detailContent">
        <!-- Detail akan diisi oleh JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Modal Hapus Data -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üóëÔ∏è Hapus Data</h3>
      <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div id="deleteContent">
        <div style="text-align: center; margin-bottom: 30px;">
          <div style="font-size: 60px; color: #e74c3c; margin-bottom: 20px;">‚ö†Ô∏è</div>
          <h3 style="color: #333; margin-bottom: 10px;" id="deleteTitle">Konfirmasi Hapus Data</h3>
          <p style="color: #666;" id="deleteMessage">Apakah Anda yakin ingin menghapus data ini?</p>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
          <h4 style="margin-bottom: 15px; color: #333;">üìã Detail Data yang Akan Dihapus</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <div>
              <small style="color: #888;">Nama</small>
              <div><strong id="deleteNama">-</strong></div>
            </div>
            <div>
              <small style="color: #888;">NIP</small>
              <div><strong id="deleteNIP">-</strong></div>
            </div>
            <div>
              <small style="color: #888;">Nomor Surat</small>
              <div><strong id="deleteNoSurat">-</strong></div>
            </div>
            <div>
              <small style="color: #888;">Tanggal Input</small>
              <div><strong id="deleteTanggal">-</strong></div>
            </div>
          </div>
        </div>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #ffc107;">
          <h5 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è PERINGATAN</h5>
          <p style="color: #856404; font-size: 14px; margin: 0;">
            Data yang sudah dihapus <strong>TIDAK DAPAT</strong> dikembalikan. Pastikan Anda sudah mencetak atau mendownload data sebelum menghapus.
          </p>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
          <button type="button" class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">
            üóëÔ∏è Ya, Hapus Data
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">
            ‚ùå Batalkan
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Admin Container -->
<div class="admin-container">
  <!-- Header -->
  <div class="admin-header">
    <div class="company-brand">
      <div class="company-logo">NEXT PROJECT IFP</div>
      <div class="company-info">
        <h1>PANEL ADMIN PAKLARING</h1>
        <div class="subtitle">NEXT Cargo Logistics ‚Ä¢ Whatsapp: 081383796300</div>
      </div>
    </div>
    
    <div class="admin-stats">
      <div class="stat-item">
        <span class="stat-number" id="totalData">0</span>
        <span class="stat-label">Total Data</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="pendingData">0</span>
        <span class="stat-label">Pending</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="completedData">0</span>
        <span class="stat-label">Selesai</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-content">
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Cari berdasarkan Nama, NIP, No. KTP, atau No. Surat..." onkeyup="filterData()">
      </div>
      
      <div class="filter-section">
        <h3>üìä Filter Data</h3>
        
        <div class="filter-group">
          <label class="filter-label">Status Surat</label>
          <select id="filterStatus" class="filter-select" onchange="filterData()">
            <option value="all">Semua Status</option>
            <option value="pending">Pending</option>
            <option value="processed">Dalam Proses</option>
            <option value="completed">Selesai</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Bulan</label>
          <select id="filterBulan" class="filter-select" onchange="filterData()">
            <option value="all">Semua Bulan</option>
            <option value="1">Januari</option>
            <option value="2">Februari</option>
            <option value="3">Maret</option>
            <option value="4">April</option>
            <option value="5">Mei</option>
            <option value="6">Juni</option>
            <option value="7">Juli</option>
            <option value="8">Agustus</option>
            <option value="9">September</option>
            <option value="10">Oktober</option>
            <option value="11">November</option>
            <option value="12">Desember</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Tanggal Dari</label>
          <input type="date" id="filterDari" class="filter-date" onchange="filterData()">
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Tanggal Sampai</label>
          <input type="date" id="filterSampai" class="filter-date" onchange="filterData()">
        </div>
      </div>
      
      <div class="recent-requests">
        <h3>üïê Permintaan Terbaru</h3>
        <ul class="recent-list" id="recentList">
          <!-- Data akan diisi dari Firebase -->
        </ul>
      </div>
    </div>

    <!-- Main Panel -->
    <div class="admin-main">
      <!-- Tabs Navigation -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="showTab('data')">üìã Data Packlaring</button>
        <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Pengaturan</button>
      </div>

      <!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-content active">
        <div class="dashboard-cards">
          <div class="card">
            <div class="card-icon">üìÑ</div>
            <div class="card-title">Total Surat</div>
            <div class="card-value" id="cardTotal">0</div>
            <div class="card-change" id="cardChange">+0% dari bulan lalu</div>
          </div>
          
          <div class="card">
            <div class="card-icon">‚è≥</div>
            <div class="card-title">Pending</div>
            <div class="card-value" id="cardPending">0</div>
            <div class="card-change">Perlu tindakan</div>
          </div>
          
          <div class="card">
            <div class="card-icon">‚úÖ</div>
            <div class="card-title">Selesai</div>
            <div class="card-value" id="cardCompleted">0</div>
            <div class="card-change" id="cardCompletedChange">+0%</div>
          </div>
          
          <div class="card storage-card">
            <div class="card-icon">üíæ</div>
            <div class="card-title">Storage Data</div>
            <div class="card-value" id="storageSize">0 KB</div>
            <div class="storage-progress">
              <div class="storage-progress-bar" id="storageProgressBar" style="width: 0%"></div>
            </div>
            <div class="storage-details" id="storageDetails">
              <span id="storageUsed">0</span> dari <span id="storageTotal">0</span> data
            </div>
          </div>
        </div>

        <div style="background: white; border-radius: 15px; padding: 25px; margin-top: 20px;">
          <h3 style="margin-bottom: 20px; color: #333;">üìà Statistik Bulanan</h3>
          <div id="chartContainer" style="height: 300px;">
            <canvas id="statsChart"></canvas>
          </div>
        </div>

        <!-- FIXED: Aktivitas Terbaru dan Top Provinsi -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
          <div style="background: white; border-radius: 15px; padding: 25px;">
            <h4 style="margin-bottom: 15px; color: #333;">üìã Aktivitas Terbaru</h4>
            <div id="activityList" style="max-height: 300px; overflow-y: auto;">
              <p style="text-align: center; color: #666; padding: 20px;">Memuat aktivitas...</p>
            </div>
          </div>
          
          <div style="background: white; border-radius: 15px; padding: 25px;">
            <h4 style="margin-bottom: 15px; color: #333;">üèÜ Top Provinsi</h4>
            <div id="provinceStats" style="max-height: 300px; overflow-y: auto;">
              <p style="text-align: center; color: #666; padding: 20px;">Memuat data provinsi...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Data List Tab -->
      <div id="tab-data" class="tab-content">
        <div class="data-list-container active" id="dataListContainer">
          <div class="data-header">
            <h2>üìã Data Packlaring</h2>
            <div class="data-actions">
              <button class="btn btn-primary" onclick="refreshData()">
                üîÑ Refresh Data
              </button>
              <button class="btn btn-success" onclick="exportExcel()">
                üìä Export Excel
              </button>
              <button class="btn btn-warning" onclick="showAllData()">
                üëÅÔ∏è Tampilkan Semua
              </button>
              <button class="btn btn-danger" onclick="deleteMultiple()">
                üóëÔ∏è Hapus Multiple
              </button>
            </div>
          </div>
          
          <!-- Checkbox untuk seleksi massal -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px;">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="width: 18px; height: 18px;">
            <label for="selectAll" style="font-weight: 500; color: #333;">Pilih Semua</label>
            <div style="margin-left: auto; display: flex; gap: 10px;">
              <span id="selectedCount" style="color: #666;">0 data terpilih</span>
              <button class="btn btn-danger btn-small" onclick="deleteSelected()" id="deleteSelectedBtn" disabled>
                üóëÔ∏è Hapus Terpilih
              </button>
            </div>
          </div>
          
          <!-- FIX: Table Container dengan Scroll Horizontal -->
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th width="50">Pilih</th>
                  <th data-sort="index">No</th>
                  <th data-sort="namaLengkap">Nama Karyawan</th>
                  <th data-sort="nip">NIP</th>
                  <th data-sort="nomorKTP">No. KTP</th>
                  <th data-sort="wilayahArea">Provinsi</th>
                  <th data-sort="kabupaten">Kabupaten</th>
                  <th data-sort="koordinator">Koordinator</th>
                  <th data-sort="keterangan">Keterangan</th>
                  <th data-sort="whatsapp">WhatsApp</th>
                  <th data-sort="noSurat">No. Surat</th>
                  <th data-sort="tanggalSurat">Tanggal</th>
                  <th data-sort="status">Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="dataTableBody">
                <!-- Data akan diisi dari Firebase -->
              </tbody>
            </table>
            
            <!-- Pagination Controls -->
            <div class="pagination-container" id="paginationControls">
              <div class="pagination-info" id="paginationInfo">
                Menampilkan 0-0 dari 0 data
              </div>
              <div class="pagination-controls">
                <button class="pagination-btn" onclick="prevPage()" id="prevBtn" disabled>
                  ‚óÄ Sebelumnya
                </button>
                <div class="page-numbers" id="pageNumbers">
                  <!-- Page numbers will be generated here -->
                </div>
                <button class="pagination-btn" onclick="nextPage()" id="nextBtn" disabled>
                  Berikutnya ‚ñ∂
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Preview Surat -->
        <div class="preview-container" id="previewContainer">
          <div class="preview-header">
            <div class="preview-info">
              <h3 id="previewTitle">Surat Packlaring</h3>
              <p id="previewSubtitle">
                <span id="previewNIP">NIP: -</span> ‚Ä¢ 
                <span id="previewWhatsapp">WhatsApp: -</span> ‚Ä¢ 
                <span id="previewDate">Tanggal: -</span>
              </p>
            </div>
            <div class="data-actions">
              <button class="btn btn-primary" onclick="downloadPDF()">
                üì• Download PDF
              </button>
              <button class="btn btn-warning" onclick="printLetter()">
                üñ®Ô∏è Cetak Surat
              </button>
              <button class="btn btn-danger" onclick="closePreview()">
                ‚úñÔ∏è Tutup Preview
              </button>
            </div>
          </div>
          
          <!-- Template Surat -->
          <div id="letterTemplate" class="letter-container">
            <div class="letter-title">SURAT KETERANGAN KERJA</div>
            <div class="letter-title">CERTIFICATE OF EMPLOYMENT</div>
            <div class="letter-no" id="letterNo">
              NO : 02/SK-HRD/NEXT/I/25
            </div>

            <div class="letter-statement">
              Yang bertanda tangan di bawah ini:<br>
              <em>The undersigned below:</em>
            </div>

            <div class="letter-data-section">
              <div class="data-row">
                <div class="data-label">Nama</div>
                <div class="data-value">: <span id="fieldPenandatangan">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">Jabatan</div>
                <div class="data-value">: <span id="fieldJabatanPenandatangan">..............................................................</span></div>
              </div>
            </div>

            <div class="letter-statement" style="margin-top:0.6cm;">
              Dengan ini menerangkan bahwa:<br>
              <em>Hereby certifies that:</em>
            </div>

            <div class="letter-data-section">
              <div class="data-row">
                <div class="data-label">Nama Lengkap</div>
                <div class="data-value">: <span id="fieldNamaLengkap">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">Tempat/Tgl Lahir</div>
                <div class="data-value">: <span id="fieldTTL">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">Jabatan Terakhir</div>
                <div class="data-value">: <span id="fieldJabatan">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">Nomor Identitas</div>
                <div class="data-value">: <span id="fieldNIP">..............................................................</span></div>
              </div>
            </div>

            <div class="letter-statement" style="margin-top:0.6cm;">
              Adalah benar pernah bekerja di perusahaan kami sejak:<br>
              <em>Was employed at our company starting from:</em>
            </div>

            <div class="letter-data-section">
              <div class="data-row">
                <div class="data-label">Start Contract</div>
                <div class="data-value">: <span id="fieldTanggalMasuk">..............................................................</span></div>
              </div>
              <div class="data-row">
                <div class="data-label">End Contract</div>
                <div class="data-value">: <span id="fieldTanggalKeluar">..............................................................</span></div>
              </div>
            </div>

            <div class="letter-statement-field">
              Alasan berhenti kerja : <span id="fieldAlasanBerhenti">Mengundurkan diri secara baik-baik / kontrak kerja berakhir</span><br>
              <em>Reason for leaving : <span id="fieldAlasanBerhentiEn">Resigned in good standing / end of contract</span></em>
            </div>

            <div class="letter-statement" style="margin-top:0.3cm;font-weight: bold;">
              Kami mengucapkan terimakasih atas kerjasama saudara selama bekerja dengan kami dan kami berharap saudara sukses dalam karir saudara di masa depan.
            </div>

            <div class="letter-date-place" id="fieldTempatTanggal">
              Bekasi, 1 Desember 2025
            </div>

            <div class="letter-signature">
              Hormat kami,<br>
              <em>Sincerely,</em><br>

              <div class="letter-signature-name" id="fieldTandaTangan">M. Fajrian Noor</div>
              <span id="fieldJabatanTTD">Direktur</span>
            </div>

            <!-- Informasi WhatsApp di footer -->
            <!-- <div class="letter-footer" style="text-align: center; font-size: 10pt; margin-top: 2cm;">
              <p>Untuk informasi lebih lanjut, hubungi WhatsApp: <span id="fieldWhatsappFooter">081383796300</span></p>
            </div> -->
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="tab-settings" class="tab-content">
        <div style="background: white; border-radius: 15px; padding: 30px;">
          <h3 style="margin-bottom: 25px; color: #333;">‚öôÔ∏è Pengaturan Sistem</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üìß Notifikasi</h4>
              <div class="form-group">
                <label>Email Admin</label>
                <input type="email" id="emailAdmin" class="form-control" placeholder="admin@nextlogistik.com">
              </div>
              <div class="form-group">
                <label>Notifikasi WhatsApp</label>
                <input type="text" id="whatsappAdmin" class="form-control" value="081383796300">
              </div>
              <div class="form-group">
                <label>Auto Refresh (detik)</label>
                <select id="autoRefresh" class="form-control">
                  <option value="30">30 detik</option>
                  <option value="60" selected>60 detik</option>
                  <option value="300">5 menit</option>
                  <option value="600">10 menit</option>
                  <option value="0">Tidak auto refresh</option>
                </select>
              </div>
            </div>
            
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üìÑ Format Surat</h4>
              <div class="form-group">
                <label>Format Nomor Surat</label>
                <input type="text" id="formatNoSurat" class="form-control" value="{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}">
              </div>
              <div class="form-group">
                <label>Format NIP</label>
                <input type="text" id="formatNIP" class="form-control" value="NEXT-{TAHUN}-{BULAN}-{NO}">
              </div>
              <div class="form-group">
                <label>Kota Tanda Tangan</label>
                <input type="text" id="kotaTandaTangan" class="form-control" value="Bekasi">
              </div>
              <div class="form-group">
                <label>Nama Default Penandatangan</label>
                <input type="text" id="defaultPenandatangan" class="form-control" value="M. Fajrian Noor">
              </div>
              <div class="form-group">
                <label>Jabatan Default</label>
                <input type="text" id="defaultJabatan" class="form-control" value="Direktur">
              </div>
            </div>
            
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üîß Sistem</h4>
              <div class="form-group">
                <label>Max Data per Halaman</label>
                <select id="maxData" class="form-control">
                  <option value="10">10 data</option>
                  <option value="20" selected>20 data</option>
                  <option value="50">50 data</option>
                  <option value="100">100 data</option>
                  <option value="0">Semua Data</option>
                </select>
              </div>
              <div class="form-group">
                <label>Tampilkan Data Lama</label>
                <select id="showOldData" class="form-control">
                  <option value="30">30 hari terakhir</option>
                  <option value="90" selected>3 bulan terakhir</option>
                  <option value="180">6 bulan terakhir</option>
                  <option value="365">1 tahun terakhir</option>
                  <option value="0">Semua data</option>
                </select>
              </div>
              <div class="form-group">
                <label>Max Data per Hari (Laporan)</label>
                <select id="maxDataPerHari" class="form-control">
                  <option value="0">Tidak Ada Batasan</option>
                  <option value="50">50 data</option>
                  <option value="100">100 data</option>
                  <option value="200">200 data</option>
                  <option value="500">500 data</option>
                </select>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="btn btn-success" onclick="saveSettings()" style="flex: 1;">
              üíæ Simpan Pengaturan
            </button>
            <button class="btn btn-warning" onclick="loadSettings()" style="flex: 1;">
              üîÑ Muat Ulang
            </button>
            <button class="btn btn-danger" onclick="resetSettings()" style="flex: 1;">
              üóëÔ∏è Reset Default
            </button>
          </div>
          
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
            <h4 style="margin-bottom: 15px; color: #555;">üìä Informasi Sistem</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div>
                <small style="color: #888;">Versi Sistem</small>
                <div><strong>v2.4.0</strong></div>
              </div>
              <div>
                <small style="color: #888;">Terakhir Update</small>
                <div><strong id="lastUpdate">-</strong></div>
              </div>
              <div>
                <small style="color: #888;">Ukuran Database</small>
                <div><strong id="dbSize">-</strong></div>
              </div>
              <div>
                <small style="color: #888;">Status Koneksi</small>
                <div><strong id="connectionStatus">-</strong></div>
              </div>
              <div>
                <small style="color: #888;">Total Data</small>
                <div><strong id="totalDataInfo">0</strong></div>
              </div>
              <div>
                <small style="color: #888;">Data Hari Ini</small>
                <div><strong id="todayDataCount">0</strong></div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h5 style="margin-bottom: 10px; color: #555;">üíæ Informasi Storage Firebase</h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div>
                  <small style="color: #888;">Total Storage</small>
                  <div><strong id="firebaseTotalStorage">0 GB</strong></div>
                </div>
                <div>
                  <small style="color: #888;">Storage Terpakai</small>
                  <div><strong id="firebaseUsedStorage">0 GB</strong></div>
                </div>
                <div>
                  <small style="color: #888;">Storage Tersedia</small>
                  <div><strong id="firebaseAvailableStorage">0 GB</strong></div>
                </div>
                <div>
                  <small style="color: #888;">Persentase</small>
                  <div><strong id="firebaseStoragePercent">0%</strong></div>
                </div>
              </div>
              <div style="margin-top: 10px;">
                <div class="storage-progress" style="background: #e0e0e0;">
                  <div class="storage-progress-bar" id="firebaseStorageProgress" style="background: #3498db; width: 0%"></div>
                </div>
                <small style="color: #888; font-size: 12px;" id="firebaseStorageText">0% terpakai</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAEvDR-h0hkgs1xAawra7u3jo9Sc3lCbpo",
    authDomain: "next-packlaring.firebaseapp.com",
    projectId: "next-packlaring",
    storageBucket: "next-packlaring.firebasestorage.app",
    messagingSenderId: "400584486436",
    appId: "1:400584486436:web:99067d2c6dc6d87ef7b2b1",
    measurementId: "G-KRFXBYN663"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const analytics = firebase.analytics();

  // Global Variables
  let allData = [];
  let filteredData = [];
  let selectedDocId = null;
  let selectedData = null;
  let statsChart = null;
  let autoRefreshInterval = null;
  
  // Pagination Variables
  let currentPage = 1;
  let itemsPerPage = 20;
  let totalPages = 1;
  
  // Sorting Variables
  let currentSortColumn = 'createdAt';
  let currentSortDirection = 'desc';
  
  // Settings
  let settings = {
    emailAdmin: "admin@nextlogistik.com",
    whatsappAdmin: "081383796300",
    autoRefresh: 60,
    formatNoSurat: "{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}",
    formatNIP: "NEXT-{TAHUN}-{BULAN}-{NO}",
    kotaTandaTangan: "Bekasi",
    defaultPenandatangan: "M. Fajrian Noor",
    defaultJabatan: "Direktur",
    maxData: 20,
    showOldData: 90,
    autoBackup: "weekly",
    maxDataPerHari: "0"
  };

  // Variables for multi-select
  let selectedIds = new Set();
  let deleteDataToDelete = null;

  // Format tanggal Indonesia
  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return date.toLocaleDateString('id-ID', options);
  }

  function formatShortDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // Format nomor KTP untuk display
  function formatNomorKTPDisplay(ktp) {
    if (!ktp || ktp === '-') return '-';
    const cleanKTP = ktp.replace(/\D/g, '');
    if (cleanKTP.length !== 16) return ktp;
    
    let formatted = '';
    for (let i = 0; i < cleanKTP.length; i++) {
      if (i > 0 && i % 4 === 0) {
        formatted += '-';
      }
      formatted += cleanKTP[i];
    }
    return formatted;
  }

  // Format WhatsApp untuk display
  function formatWhatsAppDisplay(wa) {
    if (!wa || wa === '-') return '-';
    const cleanWA = wa.replace(/\D/g, '');
    if (cleanWA.length < 10) return wa;
    
    if (cleanWA.startsWith('62')) {
      return `+62 ${cleanWA.substring(2, 5)}-${cleanWA.substring(5, 9)}-${cleanWA.substring(9)}`;
    } else if (cleanWA.startsWith('0')) {
      return `0${cleanWA.substring(1, 5)}-${cleanWA.substring(5, 9)}-${cleanWA.substring(9)}`;
    }
    return wa;
  }

  // Tab Navigation
  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Load data if needed
    if (tabName === 'dashboard') {
      updateDashboard();
    } else if (tabName === 'data') {
      renderDataTable();
    } else if (tabName === 'settings') {
      loadSettings();
      updateFirebaseStorageInfo();
    }
  }

  // Show Loading
  function showLoading(show) {
    const loadingElement = document.getElementById('loading');
    if (loadingElement) {
      loadingElement.classList.toggle('active', show);
    }
  }

  // Show Notification
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    const icon = notification.querySelector('.notification-icon');
    const content = notification.querySelector('.notification-content');
    const title = content.querySelector('h4');
    const text = content.querySelector('p');
    
    // Set icon based on type
    if (type === 'success') {
      icon.textContent = '‚úÖ';
      title.textContent = 'Berhasil';
    } else if (type === 'error') {
      icon.textContent = '‚ùå';
      title.textContent = 'Error';
    } else if (type === 'warning') {
      icon.textContent = '‚ö†Ô∏è';
      title.textContent = 'Peringatan';
    }
    
    text.textContent = message;
    notification.className = `notification ${type} show`;
    
    // Auto hide after 5 seconds
    setTimeout(() => {
      notification.classList.remove('show');
    }, 5000);
  }

  function hideNotification() {
    const notification = document.getElementById('notification');
    if (notification) {
      notification.classList.remove('show');
    }
  }

  // Load Data from Firebase
  async function loadData() {
    showLoading(true);
    
    try {
      const snapshot = await db.collection('packlaring')
        .orderBy('createdAt', 'desc')
        .get();
      
      allData = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        data.id = doc.id;
        
        // Convert Firestore timestamps to Date objects
        if (data.createdAt && data.createdAt.toDate) {
          data.createdAt = data.createdAt.toDate();
        }
        if (data.updatedAt && data.updatedAt.toDate) {
          data.updatedAt = data.updatedAt.toDate();
        }
        
        allData.push(data);
      });
      
      // Apply sorting
      sortData();
      
      filteredData = [...allData];
      renderDataTable();
      updateStats();
      updateRecentList();
      updateDashboard();
      updateSystemInfo();
      updateFirebaseStorageInfo();
      
      const connectionStatus = document.getElementById('connectionStatus');
      if (connectionStatus) connectionStatus.textContent = '‚úÖ Terhubung';
      
      const lastUpdate = document.getElementById('lastUpdate');
      if (lastUpdate) lastUpdate.textContent = new Date().toLocaleTimeString('id-ID');
      
    } catch (error) {
      console.error('Error loading data:', error);
      showNotification('Gagal memuat data: ' + error.message, 'error');
      const connectionStatus = document.getElementById('connectionStatus');
      if (connectionStatus) connectionStatus.textContent = '‚ùå Gagal';
    } finally {
      showLoading(false);
    }
  }

  // Sort Data
  function sortData() {
    allData.sort((a, b) => {
      let aValue, bValue;
      
      switch(currentSortColumn) {
        case 'namaLengkap':
          aValue = (a.namaLengkap || '').toLowerCase();
          bValue = (b.namaLengkap || '').toLowerCase();
          break;
        case 'nip':
          aValue = a.nip || '';
          bValue = b.nip || '';
          break;
        case 'noSurat':
          aValue = a.noSurat || '';
          bValue = b.noSurat || '';
          break;
        case 'wilayahArea':
          aValue = (a.wilayahArea || '').toLowerCase();
          bValue = (b.wilayahArea || '').toLowerCase();
          break;
        case 'kabupaten':
          aValue = (a.kabupaten || '').toLowerCase();
          bValue = (b.kabupaten || '').toLowerCase();
          break;
        case 'koordinator':
          aValue = (a.koordinator || '').toLowerCase();
          bValue = (b.koordinator || '').toLowerCase();
          break;
        case 'keterangan':
          aValue = (a.keterangan || '').toLowerCase();
          bValue = (b.keterangan || '').toLowerCase();
          break;
        case 'whatsapp':
          aValue = a.whatsapp || '';
          bValue = b.whatsapp || '';
          break;
        case 'tanggalSurat':
          aValue = a.tanggalSurat ? new Date(a.tanggalSurat) : new Date(0);
          bValue = b.tanggalSurat ? new Date(b.tanggalSurat) : new Date(0);
          break;
        case 'status':
          aValue = a.status || 'pending';
          bValue = b.status || 'pending';
          break;
        case 'createdAt':
        default:
          aValue = a.createdAt || new Date(0);
          bValue = b.createdAt || new Date(0);
          break;
      }
      
      if (currentSortDirection === 'asc') {
        return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
      } else {
        return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
      }
    });
  }

  // Toggle Sort
  function toggleSort(column) {
    if (currentSortColumn === column) {
      currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortColumn = column;
      currentSortDirection = 'asc';
    }
    
    // Update sort indicators
    document.querySelectorAll('.data-table th').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
    });
    
    const currentTh = document.querySelector(`.data-table th[data-sort="${column}"]`);
    if (currentTh) {
      currentTh.classList.add(`sort-${currentSortDirection}`);
    }
    
    // Sort and render
    sortData();
    filteredData = [...allData];
    currentPage = 1;
    renderDataTable();
  }

  // Render Data Table with Pagination
  function renderDataTable() {
    const tbody = document.getElementById('dataTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="14" style="text-align: center; padding: 40px; color: #666;">
            <h3>üì≠ Tidak Ada Data</h3>
            <p>Tidak ada data packlaring yang ditemukan.</p>
          </td>
        </tr>
      `;
      updatePaginationInfo();
      updateSelectedCount();
      return;
    }
    
    // Calculate pagination
    totalPages = Math.ceil(filteredData.length / itemsPerPage);
    if (currentPage > totalPages) currentPage = totalPages;
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
    const displayData = filteredData.slice(startIndex, endIndex);
    
    // Render table rows
    displayData.forEach((data, index) => {
      const globalIndex = startIndex + index + 1;
      const isSelected = selectedIds.has(data.id);
      const row = document.createElement('tr');
      
      // Cek jika jabatan adalah teknisi untuk menampilkan data khusus
      const isTeknisi = data.jabatan && data.jabatan.toLowerCase().includes('teknisi');
      
      row.innerHTML = `
        <td>
          <input type="checkbox" class="data-checkbox" data-id="${data.id}" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${data.id}')" style="width: 18px; height: 18px;">
        </td>
        <td>${globalIndex}</td>
        <td><strong>${data.namaLengkap || '-'}</strong></td>
        <td>${data.nip || '-'}</td>
        <td>${formatNomorKTPDisplay(data.nomorKTP || '-')}</td>
        <td>${data.wilayahArea || '-'}</td>
        <td>${data.kabupaten || '-'}</td>
        <td>${data.koordinator || '-'}</td>
        <td>${data.keterangan || '-'}</td>
        <td>${formatWhatsAppDisplay(data.whatsapp || '-')}</td>
        <td>${data.noSurat || '-'}</td>
        <td>${formatShortDate(data.tanggalSurat || data.createdAt)}</td>
        <td>
          <span class="status-badge status-${data.status || 'pending'}">
            ${getStatusText(data.status)}
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-info btn-small" onclick="showDetail('${data.id}')">
              üìã Detail
            </button>
            <button class="btn btn-primary btn-small" onclick="viewLetter('${data.id}')">
              üëÅÔ∏è Surat
            </button>
            <button class="btn btn-success btn-small" onclick="editData('${data.id}')">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn btn-danger btn-small" onclick="confirmDeleteData('${data.id}')">
              üóëÔ∏è Hapus
            </button>
          </div>
        </td>
      `;
      
      // Tambahkan warna latar untuk data teknisi
      if (isTeknisi) {
        row.style.backgroundColor = '#f0f8ff';
      }
      
      tbody.appendChild(row);
    });
    
    updatePaginationInfo();
    updatePaginationControls();
    updateSelectedCount();
  }

  // Update Pagination Information
  function updatePaginationInfo() {
    const paginationInfo = document.getElementById('paginationInfo');
    if (!paginationInfo) return;
    
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
    
    paginationInfo.innerHTML = 
      `Menampilkan ${startIndex}-${endIndex} dari ${filteredData.length} data`;
  }

  // Update Pagination Controls
  function updatePaginationControls() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageNumbers = document.getElementById('pageNumbers');
    
    if (!prevBtn || !nextBtn || !pageNumbers) return;
    
    // Update buttons state
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
    
    // Generate page numbers
    pageNumbers.innerHTML = '';
    
    // Calculate page range to display
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    // Adjust if at the beginning
    if (currentPage <= 3) {
      endPage = Math.min(5, totalPages);
    }
    
    // Adjust if at the end
    if (currentPage >= totalPages - 2) {
      startPage = Math.max(1, totalPages - 4);
    }
    
    // Add page numbers
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => goToPage(i);
      pageNumbers.appendChild(pageBtn);
    }
  }

  // Pagination Functions
  function nextPage() {
    if (currentPage < totalPages) {
      currentPage++;
      renderDataTable();
    }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderDataTable();
    }
  }

  function goToPage(page) {
    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      renderDataTable();
    }
  }

  // Get Status Text
  function getStatusText(status) {
    const statusMap = {
      'pending': '‚è≥ Pending',
      'processed': 'üîÑ Diproses',
      'completed': '‚úÖ Selesai'
    };
    return statusMap[status] || '‚è≥ Pending';
  }

  // Update Statistics
  function updateStats() {
    const total = allData.length;
    const pending = allData.filter(d => d.status === 'pending').length;
    const completed = allData.filter(d => d.status === 'completed').length;
    
    const totalDataElement = document.getElementById('totalData');
    const pendingDataElement = document.getElementById('pendingData');
    const completedDataElement = document.getElementById('completedData');
    
    if (totalDataElement) totalDataElement.textContent = total;
    if (pendingDataElement) pendingDataElement.textContent = pending;
    if (completedDataElement) completedDataElement.textContent = completed;
  }

  // Update System Information
  function updateSystemInfo() {
    // Calculate storage size
    const storageSize = calculateStorageSize(allData);
    
    const dbSizeElement = document.getElementById('dbSize');
    const storageSizeElement = document.getElementById('storageSize');
    
    if (dbSizeElement) dbSizeElement.textContent = storageSize;
    if (storageSizeElement) storageSizeElement.textContent = storageSize;
    
    // Calculate storage usage percentage (simulated)
    const storageUsed = allData.length;
    const storageLimit = 10000;
    const percentage = Math.min((storageUsed / storageLimit) * 100, 100);
    
    const storageProgressBar = document.getElementById('storageProgressBar');
    const storageUsedElement = document.getElementById('storageUsed');
    const storageTotalElement = document.getElementById('storageTotal');
    const storageDetails = document.getElementById('storageDetails');
    const todayDataCount = document.getElementById('todayDataCount');
    const totalDataInfo = document.getElementById('totalDataInfo');
    
    if (storageProgressBar) storageProgressBar.style.width = `${percentage}%`;
    if (storageUsedElement) storageUsedElement.textContent = storageUsed;
    if (storageTotalElement) storageTotalElement.textContent = storageLimit;
    if (storageDetails) storageDetails.innerHTML = 
      `<span id="storageUsed">${storageUsed}</span> dari <span id="storageTotal">${storageLimit}</span> data`;
    
    // Count today's data
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayData = allData.filter(d => {
      const dataDate = d.createdAt ? new Date(d.createdAt) : null;
      if (!dataDate) return false;
      dataDate.setHours(0, 0, 0, 0);
      return dataDate.getTime() === today.getTime();
    });
    
    if (todayDataCount) todayDataCount.textContent = todayData.length;
    if (totalDataInfo) totalDataInfo.textContent = allData.length;
  }

  // Get Firebase Storage Information
  async function updateFirebaseStorageInfo() {
    try {
      // Get storage usage from Firebase
      const totalDocs = allData.length;
      
      // Estimated storage usage (average 1KB per document)
      const estimatedUsageKB = totalDocs * 1;
      const estimatedUsageMB = estimatedUsageKB / 1024;
      const estimatedUsageGB = estimatedUsageMB / 1024;
      
      // Firebase free tier: 1GB storage
      const freeStorageGB = 1;
      const usedStorageGB = Math.min(estimatedUsageGB, freeStorageGB);
      const availableStorageGB = freeStorageGB - usedStorageGB;
      const percentageUsed = (usedStorageGB / freeStorageGB) * 100;
      
      // Update UI
      const firebaseTotalStorage = document.getElementById('firebaseTotalStorage');
      const firebaseUsedStorage = document.getElementById('firebaseUsedStorage');
      const firebaseAvailableStorage = document.getElementById('firebaseAvailableStorage');
      const firebaseStoragePercent = document.getElementById('firebaseStoragePercent');
      const firebaseStorageProgress = document.getElementById('firebaseStorageProgress');
      const firebaseStorageText = document.getElementById('firebaseStorageText');
      
      if (firebaseTotalStorage) firebaseTotalStorage.textContent = `${freeStorageGB.toFixed(2)} GB`;
      if (firebaseUsedStorage) firebaseUsedStorage.textContent = `${usedStorageGB.toFixed(2)} GB`;
      if (firebaseAvailableStorage) firebaseAvailableStorage.textContent = `${availableStorageGB.toFixed(2)} GB`;
      if (firebaseStoragePercent) firebaseStoragePercent.textContent = `${percentageUsed.toFixed(1)}%`;
      if (firebaseStorageProgress) firebaseStorageProgress.style.width = `${percentageUsed}%`;
      if (firebaseStorageText) firebaseStorageText.textContent = `${percentageUsed.toFixed(1)}% terpakai`;
      
    } catch (error) {
      console.error('Error getting Firebase storage info:', error);
      showNotification('Tidak dapat memuat informasi storage Firebase', 'warning');
    }
  }

  // Calculate storage size
  function calculateStorageSize(data) {
    if (!data || data.length === 0) return '0 KB';
    
    // Calculate approximate size
    const totalSize = calculateDataSize(data);
    return formatBytes(totalSize);
  }

  // Calculate data size in bytes
  function calculateDataSize(data) {
    const jsonString = JSON.stringify(data);
    return new Blob([jsonString]).size;
  }

  // Format bytes to human readable
  function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Update Recent List
  function updateRecentList() {
    const recentList = document.getElementById('recentList');
    if (!recentList) return;
    
    recentList.innerHTML = '';
    
    const recentData = allData.slice(0, 10);
    
    recentData.forEach(data => {
      const li = document.createElement('li');
      li.className = 'recent-item';
      li.onclick = () => {
        showDetail(data.id);
        showTab('data');
      };
      
      const date = formatShortDate(data.tanggalSurat || data.createdAt);
      li.innerHTML = `
        <strong>${data.namaLengkap || 'Tanpa Nama'}</strong><br>
        <small>${data.nip || 'No NIP'} ‚Ä¢ ${date}</small>
        <div style="margin-top: 5px;">
          <span class="status-badge status-${data.status || 'pending'}" style="font-size: 10px; padding: 2px 8px;">
            ${getStatusText(data.status)}
          </span>
        </div>
      `;
      recentList.appendChild(li);
    });
  }

  // Show Detail Data
  function showDetail(docId) {
    const data = allData.find(d => d.id === docId);
    if (!data) return;
    
    const detailHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div>
          <h4 style="margin-bottom: 15px; color: #333;">üë§ Data Pribadi</h4>
          <div class="detail-item">
            <strong>Nama Lengkap:</strong> ${data.namaLengkap || '-'}
          </div>
          <div class="detail-item">
            <strong>NIP:</strong> ${data.nip || '-'}
          </div>
          <div class="detail-item">
            <strong>Nomor KTP:</strong> ${formatNomorKTPDisplay(data.nomorKTP || '-')}
          </div>
          <div class="detail-item">
            <strong>Wilayah Area:</strong> ${data.wilayahArea || '-'}
          </div>
          <div class="detail-item">
            <strong>Kabupaten:</strong> ${data.kabupaten || '-'}
          </div>
          <div class="detail-item">
            <strong>Koordinator:</strong> ${data.koordinator || '-'}
          </div>
          <div class="detail-item">
            <strong>Keterangan:</strong> ${data.keterangan || '-'}
          </div>
        </div>
        
        <div>
          <h4 style="margin-bottom: 15px; color: #333;">üè¢ Data Perusahaan</h4>
          <div class="detail-item">
            <strong>Jabatan:</strong> ${data.jabatan || '-'}
          </div>
          <div class="detail-item">
            <strong>Departemen:</strong> ${data.deptKaryawan || '-'}
          </div>
          <div class="detail-item">
            <strong>No. Surat:</strong> ${data.noSurat || '-'}
          </div>
          <div class="detail-item">
            <strong>Tanggal Surat:</strong> ${formatDate(data.tanggalSurat)}
          </div>
          <div class="detail-item">
            <strong>Tujuan Surat:</strong> ${data.tujuanSurat || '-'}
          </div>
        </div>
        
        <div>
          <h4 style="margin-bottom: 15px; color: #333;">üìÖ Masa Kerja</h4>
          <div class="detail-item">
            <strong>Tanggal Mulai:</strong> ${formatDate(data.tanggalMulai)}
          </div>
          <div class="detail-item">
            <strong>Tanggal Berakhir:</strong> ${formatDate(data.tanggalBerakhir)}
          </div>
          <div class="detail-item">
            <strong>Alasan Berhenti:</strong> ${data.alasanBerhenti || '-'}
          </div>
        </div>
        
        <div>
          <h4 style="margin-bottom: 15px; color: #333;">üìû Kontak & Status</h4>
          <div class="detail-item">
            <strong>WhatsApp:</strong> ${formatWhatsAppDisplay(data.whatsapp || '-')}
          </div>
          <div class="detail-item">
            <strong>Email:</strong> ${data.email || '-'}
          </div>
          <div class="detail-item">
            <strong>Status:</strong> <span class="status-badge status-${data.status || 'pending'}">
              ${getStatusText(data.status)}
            </span>
          </div>
          <div class="detail-item">
            <strong>Tanggal Input:</strong> ${formatDate(data.createdAt)}
          </div>
          <div class="detail-item">
            <strong>Terakhir Update:</strong> ${formatDate(data.updatedAt || data.createdAt)}
          </div>
        </div>
      </div>
      
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
          <button class="btn btn-primary" onclick="viewLetter('${data.id}')">
            üëÅÔ∏è Lihat Surat
          </button>
          <button class="btn btn-success" onclick="editData('${data.id}')">
            ‚úèÔ∏è Edit Data
          </button>
          <button class="btn btn-danger" onclick="confirmDeleteData('${data.id}')">
            üóëÔ∏è Hapus Data
          </button>
        </div>
      </div>
    `;
    
    const detailContent = document.getElementById('detailContent');
    if (detailContent) detailContent.innerHTML = detailHTML;
    
    const detailModal = document.getElementById('detailModal');
    if (detailModal) detailModal.classList.add('active');
  }

  function closeDetailModal() {
    const detailModal = document.getElementById('detailModal');
    if (detailModal) detailModal.classList.remove('active');
  }

  // Edit Data
  function editData(docId) {
    selectedDocId = docId;
    const data = allData.find(d => d.id === docId);
    
    if (data) {
      // Populate form with current data
      const editNamaLengkap = document.getElementById('editNamaLengkap');
      const editNIP = document.getElementById('editNIP');
      const editNoSurat = document.getElementById('editNoSurat');
      const editTanggalSurat = document.getElementById('editTanggalSurat');
      const editWhatsapp = document.getElementById('editWhatsapp');
      const editWilayah = document.getElementById('editWilayah');
      const editKabupaten = document.getElementById('editKabupaten');
      const editKoordinator = document.getElementById('editKoordinator');
      const editKeterangan = document.getElementById('editKeterangan');
      const editStatus = document.getElementById('editStatus');
      const editCatatan = document.getElementById('editCatatan');
      
      if (editNamaLengkap) editNamaLengkap.value = data.namaLengkap || '';
      if (editNIP) editNIP.value = data.nip || '';
      if (editNoSurat) editNoSurat.value = data.noSurat || '';
      if (editTanggalSurat) editTanggalSurat.value = data.tanggalSurat ? 
        new Date(data.tanggalSurat).toISOString().split('T')[0] : '';
      if (editWhatsapp) editWhatsapp.value = data.whatsapp || '';
      if (editWilayah) editWilayah.value = data.wilayahArea || '';
      if (editKabupaten) editKabupaten.value = data.kabupaten || '';
      if (editKoordinator) editKoordinator.value = data.koordinator || '';
      if (editKeterangan) editKeterangan.value = data.keterangan || '';
      if (editStatus) editStatus.value = data.status || 'pending';
      if (editCatatan) editCatatan.value = data.catatanAdmin || '';
      
      const editModal = document.getElementById('editModal');
      if (editModal) editModal.classList.add('active');
    }
  }

  function closeModal() {
    const editModal = document.getElementById('editModal');
    if (editModal) editModal.classList.remove('active');
  }

  // Update Data
  async function updateData() {
    showLoading(true);
    
    try {
      const editNamaLengkap = document.getElementById('editNamaLengkap');
      const editNIP = document.getElementById('editNIP');
      const editNoSurat = document.getElementById('editNoSurat');
      const editTanggalSurat = document.getElementById('editTanggalSurat');
      const editWhatsapp = document.getElementById('editWhatsapp');
      const editWilayah = document.getElementById('editWilayah');
      const editKabupaten = document.getElementById('editKabupaten');
      const editKoordinator = document.getElementById('editKoordinator');
      const editKeterangan = document.getElementById('editKeterangan');
      const editStatus = document.getElementById('editStatus');
      const editCatatan = document.getElementById('editCatatan');
      
      if (!editNamaLengkap || !editNIP || !editNoSurat) {
        throw new Error('Form tidak lengkap');
      }
      
      const namaLengkap = editNamaLengkap.value;
      const nip = editNIP.value;
      const noSurat = editNoSurat.value;
      const tanggalSurat = editTanggalSurat ? editTanggalSurat.value : '';
      const whatsapp = editWhatsapp ? editWhatsapp.value : '';
      const wilayah = editWilayah ? editWilayah.value : '';
      const kabupaten = editKabupaten ? editKabupaten.value : '';
      const koordinator = editKoordinator ? editKoordinator.value : '';
      const keterangan = editKeterangan ? editKeterangan.value : '';
      const status = editStatus ? editStatus.value : 'pending';
      const catatan = editCatatan ? editCatatan.value : '';
      
      // Check for duplicate NIP
      if (nip) {
        const duplicateNIP = allData.find(d => 
          d.id !== selectedDocId && d.nip === nip
        );
        
        if (duplicateNIP) {
          showNotification('NIP sudah digunakan oleh karyawan lain!', 'warning');
          return;
        }
      }
      
      // Check for duplicate No Surat
      if (noSurat) {
        const duplicateNoSurat = allData.find(d => 
          d.id !== selectedDocId && d.noSurat === noSurat
        );
        
        if (duplicateNoSurat) {
          showNotification('Nomor Surat sudah digunakan!', 'warning');
          return;
        }
      }
      
      await db.collection('packlaring').doc(selectedDocId).update({
        namaLengkap: namaLengkap,
        nip: nip,
        noSurat: noSurat,
        tanggalSurat: tanggalSurat ? new Date(tanggalSurat) : null,
        whatsapp: whatsapp,
        wilayahArea: wilayah,
        kabupaten: kabupaten,
        koordinator: koordinator,
        keterangan: keterangan,
        status: status,
        catatanAdmin: catatan,
        updatedAt: new Date(),
        updatedBy: 'Admin'
      });
      
      closeModal();
      loadData();
      
      showNotification('Data berhasil diperbarui!', 'success');
      
    } catch (error) {
      console.error('Error updating data:', error);
      showNotification('Gagal update data: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Confirm Delete Data
  function confirmDeleteData(docId) {
    const data = allData.find(d => d.id === docId);
    if (!data) return;
    
    deleteDataToDelete = {
      id: docId,
      data: data
    };
    
    // Update modal content
    document.getElementById('deleteNama').textContent = data.namaLengkap || '-';
    document.getElementById('deleteNIP').textContent = data.nip || '-';
    document.getElementById('deleteNoSurat').textContent = data.noSurat || '-';
    document.getElementById('deleteTanggal').textContent = formatDate(data.createdAt);
    
    document.getElementById('deleteTitle').textContent = `Hapus Data: ${data.namaLengkap || 'Tanpa Nama'}`;
    document.getElementById('deleteMessage').textContent = 
      `Apakah Anda yakin ingin menghapus data "${data.namaLengkap || 'Data'}"?`;
    
    // Show delete modal
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) deleteModal.classList.add('active');
  }

  // Close Delete Modal
  function closeDeleteModal() {
    deleteDataToDelete = null;
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) deleteModal.classList.remove('active');
  }

  // Confirm Delete (after confirmation)
  async function confirmDelete() {
    if (!deleteDataToDelete) return;
    
    showLoading(true);
    
    try {
      await db.collection('packlaring').doc(deleteDataToDelete.id).delete();
      
      showNotification(
        `Data "${deleteDataToDelete.data.namaLengkap || 'Data'}" berhasil dihapus!`, 
        'success'
      );
      
      // Remove from selected IDs if exists
      selectedIds.delete(deleteDataToDelete.id);
      
      // Close modal and reload data
      closeDeleteModal();
      loadData();
      
    } catch (error) {
      console.error('Error deleting data:', error);
      showNotification('Gagal menghapus data: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Multi-select functions
  function toggleSelect(id) {
    if (selectedIds.has(id)) {
      selectedIds.delete(id);
    } else {
      selectedIds.add(id);
    }
    updateSelectedCount();
  }

  function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    if (!selectAll) return;
    
    if (selectAll.checked) {
      // Select all filtered data
      filteredData.forEach(item => {
        selectedIds.add(item.id);
      });
    } else {
      // Deselect all
      selectedIds.clear();
    }
    
    // Update checkboxes
    document.querySelectorAll('.data-checkbox').forEach(checkbox => {
      checkbox.checked = selectAll.checked;
    });
    
    updateSelectedCount();
  }

  function updateSelectedCount() {
    const selectedCount = document.getElementById('selectedCount');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    
    if (selectedCount) {
      selectedCount.textContent = `${selectedIds.size} data terpilih`;
    }
    
    if (deleteSelectedBtn) {
      deleteSelectedBtn.disabled = selectedIds.size === 0;
    }
    
    // Update "Select All" checkbox state
    const selectAll = document.getElementById('selectAll');
    if (selectAll && filteredData.length > 0) {
      const allChecked = filteredData.every(item => selectedIds.has(item.id));
      selectAll.checked = allChecked;
      selectAll.indeterminate = !allChecked && selectedIds.size > 0;
    }
  }

  // Delete selected data
  async function deleteSelected() {
    if (selectedIds.size === 0) return;
    
    const count = selectedIds.size;
    if (!confirm(`Apakah Anda yakin ingin menghapus ${count} data yang dipilih?`)) {
      return;
    }
    
    showLoading(true);
    
    try {
      // Delete each selected document
      const deletePromises = Array.from(selectedIds).map(id => 
        db.collection('packlaring').doc(id).delete()
      );
      
      await Promise.all(deletePromises);
      
      showNotification(`${count} data berhasil dihapus!`, 'success');
      
      // Clear selection and reload data
      selectedIds.clear();
      loadData();
      
    } catch (error) {
      console.error('Error deleting selected data:', error);
      showNotification('Gagal menghapus data: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Show multiple delete instructions
  function deleteMultiple() {
    showNotification(
      'Pilih data yang ingin dihapus dengan mencentang kotak di kolom "Pilih", lalu klik "Hapus Terpilih"',
      'info'
    );
  }

  // Update Dashboard
  function updateDashboard() {
    // Update card values
    const total = allData.length;
    const pending = allData.filter(d => d.status === 'pending').length;
    const completed = allData.filter(d => d.status === 'completed').length;
    
    // This month data
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    const thisMonthData = allData.filter(d => {
      const date = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
      return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
    });
    
    // Last month data
    const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
    const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;
    const lastMonthData = allData.filter(d => {
      const date = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
      return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
    });
    
    // Calculate changes
    const totalChange = lastMonthData.length > 0 ? 
      (((thisMonthData.length - lastMonthData.length) / lastMonthData.length) * 100).toFixed(1) : 0;
    const completedChange = allData.length > 0 ? 
      ((completed / allData.length) * 100).toFixed(1) : 0;
    
    // Update cards
    const cardTotal = document.getElementById('cardTotal');
    const cardPending = document.getElementById('cardPending');
    const cardCompleted = document.getElementById('cardCompleted');
    const cardThisMonth = document.getElementById('cardThisMonth');
    const cardChange = document.getElementById('cardChange');
    const cardCompletedChange = document.getElementById('cardCompletedChange');
    const cardMonthChange = document.getElementById('cardMonthChange');
    
    if (cardTotal) cardTotal.textContent = total;
    if (cardPending) cardPending.textContent = pending;
    if (cardCompleted) cardCompleted.textContent = completed;
    if (cardThisMonth) cardThisMonth.textContent = thisMonthData.length;
    
    if (cardChange) {
      cardChange.textContent = 
        `${totalChange >= 0 ? '+' : ''}${totalChange}% dari bulan lalu`;
      cardChange.className = 
        `card-change ${totalChange >= 0 ? '' : 'negative'}`;
    }
    
    if (cardCompletedChange) cardCompletedChange.textContent = `${completedChange}% selesai`;
    
    if (cardMonthChange) {
      cardMonthChange.textContent = 
        lastMonthData.length > 0 ? 
        `+${(thisMonthData.length - lastMonthData.length)} dari bulan lalu` : 
        'Data bulan lalu tidak tersedia';
    }
    
    // Update chart
    updateChart();
    
    // Update activity list
    updateActivityList();
    
    // Update province stats
    updateProvinceStats();
  }

  // Update Chart
  function updateChart() {
    const ctx = document.getElementById('statsChart');
    if (!ctx) return;
    
    // Destroy existing chart
    if (statsChart) {
      statsChart.destroy();
    }
    
    // Prepare monthly data
    const now = new Date();
    const months = [];
    const monthData = { pending: [], processed: [], completed: [] };
    
    // Get last 6 months
    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleDateString('id-ID', { month: 'short' });
      months.push(monthName);
      
      // Filter data for this month
      const monthDataFiltered = allData.filter(d => {
        const dataDate = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
        return dataDate.getMonth() === date.getMonth() && 
               dataDate.getFullYear() === date.getFullYear();
      });
      
      monthData.pending.push(monthDataFiltered.filter(d => d.status === 'pending').length);
      monthData.processed.push(monthDataFiltered.filter(d => d.status === 'processed').length);
      monthData.completed.push(monthDataFiltered.filter(d => d.status === 'completed').length);
    }
    
    // Create new chart
    statsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Pending',
            data: monthData.pending,
            backgroundColor: '#ffc107',
            borderColor: '#ffc107',
            borderWidth: 1
          },
          {
            label: 'Diproses',
            data: monthData.processed,
            backgroundColor: '#17a2b8',
            borderColor: '#17a2b8',
            borderWidth: 1
          },
          {
            label: 'Selesai',
            data: monthData.completed,
            backgroundColor: '#28a745',
            borderColor: '#28a745',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'Statistik Packlaring 6 Bulan Terakhir'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // Update Activity List
  function updateActivityList() {
    const activityList = document.getElementById('activityList');
    if (!activityList) return;
    
    // Sort by date (newest first) and take 10
    const sortedData = [...allData].sort((a, b) => {
      const dateA = a.updatedAt || a.createdAt;
      const dateB = b.updatedAt || b.createdAt;
      return dateB - dateA;
    }).slice(0, 10);
    
    if (sortedData.length === 0) {
      activityList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada aktivitas</p>';
      return;
    }
    
    let activityHTML = '';
    sortedData.forEach(data => {
      const timeAgo = getTimeAgo(data.updatedAt || data.createdAt);
      const statusIcon = data.status === 'completed' ? '‚úÖ' : 
                        data.status === 'processed' ? 'üîÑ' : '‚è≥';
      
      activityHTML += `
        <div class="activity-item">
          <div class="activity-icon">${statusIcon}</div>
          <div class="activity-content">
            <strong>${data.namaLengkap || 'Tanpa Nama'}</strong><br>
            <small style="color: #666;">${data.wilayahArea || 'Tidak ada wilayah'} ‚Ä¢ ${timeAgo}</small>
          </div>
        </div>
      `;
    });
    
    activityList.innerHTML = activityHTML;
  }

  // Get Time Ago
  function getTimeAgo(date) {
    if (!date) return '-';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) {
      return `${diffMins} menit lalu`;
    } else if (diffHours < 24) {
      return `${diffHours} jam lalu`;
    } else if (diffDays < 7) {
      return `${diffDays} hari lalu`;
    } else {
      return formatShortDate(date);
    }
  }

  // Update Province Stats
  function updateProvinceStats() {
    const provinceStats = document.getElementById('provinceStats');
    if (!provinceStats) return;
    
    // Count by province
    const provinceCount = {};
    allData.forEach(data => {
      const province = data.wilayahArea || 'Tidak Diketahui';
      provinceCount[province] = (provinceCount[province] || 0) + 1;
    });
    
    // Sort by count
    const sortedProvinces = Object.entries(provinceCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10); // Show top 10 provinces
    
    if (sortedProvinces.length === 0) {
      provinceStats.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada data provinsi</p>';
      return;
    }
    
    const totalData = allData.length;
    let provinceHTML = '';
    
    sortedProvinces.forEach(([province, count], index) => {
      const percentage = ((count / totalData) * 100).toFixed(1);
      const colorClass = `province-color-${index % 10}`;
      const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
      
      provinceHTML += `
        <div class="province-item">
          <div class="province-icon">${medal}</div>
          <div class="province-content">
            <div style="display: flex; justify-content: space-between;">
              <span>${province}</span>
              <span><strong>${count}</strong> (${percentage}%)</span>
            </div>
            <div class="province-bar">
              <div class="province-bar-fill ${colorClass}" style="width: ${percentage}%"></div>
            </div>
          </div>
        </div>
      `;
    });
    
    provinceStats.innerHTML = provinceHTML;
  }

  // Filter Data
  function filterData() {
    const statusFilterElement = document.getElementById('filterStatus');
    const bulanFilterElement = document.getElementById('filterBulan');
    const dariFilterElement = document.getElementById('filterDari');
    const sampaiFilterElement = document.getElementById('filterSampai');
    const searchFilterElement = document.getElementById('searchInput');
    
    if (!statusFilterElement || !bulanFilterElement || !searchFilterElement) return;
    
    const statusFilter = statusFilterElement.value;
    const bulanFilter = bulanFilterElement.value;
    const dariFilter = dariFilterElement ? dariFilterElement.value : '';
    const sampaiFilter = sampaiFilterElement ? sampaiFilterElement.value : '';
    const searchFilter = searchFilterElement.value.toLowerCase();
    
    filteredData = allData.filter(data => {
      // Filter by status
      if (statusFilter !== 'all' && data.status !== statusFilter) {
        return false;
      }
      
      // Filter by month
      if (bulanFilter !== 'all') {
        const date = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (date && (date.getMonth() + 1) !== parseInt(bulanFilter)) {
          return false;
        }
      }
      
      // Filter by date range
      if (dariFilter) {
        const dariDate = new Date(dariFilter);
        const dataDate = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (dataDate && dataDate < dariDate) {
          return false;
        }
      }
      
      if (sampaiFilter) {
        const sampaiDate = new Date(sampaiFilter);
        sampaiDate.setHours(23, 59, 59);
        const dataDate = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (dataDate && dataDate > sampaiDate) {
          return false;
        }
      }
      
      // Filter by search
      if (searchFilter) {
        const searchStr = `
          ${data.namaLengkap || ''} 
          ${data.nip || ''} 
          ${data.noSurat || ''} 
          ${data.jabatan || ''}
          ${data.nomorKTP || ''}
          ${data.wilayahArea || ''}
          ${data.kabupaten || ''}
          ${data.koordinator || ''}
          ${data.keterangan || ''}
          ${data.whatsapp || ''}
        `.toLowerCase();
        
        if (!searchStr.includes(searchFilter)) {
          return false;
        }
      }
      
      return true;
    });
    
    // Reset to first page when filtering
    currentPage = 1;
    renderDataTable();
  }

  // View Letter
  async function viewLetter(docId) {
    showLoading(true);
    
    try {
      const doc = await db.collection('packlaring').doc(docId).get();
      if (!doc.exists) {
        throw new Error('Dokumen tidak ditemukan');
      }
      
      selectedDocId = docId;
      selectedData = doc.data();
      
      // Convert timestamps
      if (selectedData.createdAt && selectedData.createdAt.toDate) {
        selectedData.createdAt = selectedData.createdAt.toDate();
      }
      
      // Update preview title
      const previewTitle = document.getElementById('previewTitle');
      const previewSubtitle = document.getElementById('previewSubtitle');
      const previewNIP = document.getElementById('previewNIP');
      const previewWhatsapp = document.getElementById('previewWhatsapp');
      const previewDate = document.getElementById('previewDate');
      
      if (previewTitle) {
        previewTitle.textContent = 
          `Surat Packlaring - ${selectedData.namaLengkap || 'Tidak Ada Nama'}`;
      }
      
      if (previewNIP) {
        previewNIP.textContent = `NIP: ${selectedData.nip || '-'}`;
      }
      
      if (previewWhatsapp) {
        previewWhatsapp.textContent = `WhatsApp: ${formatWhatsAppDisplay(selectedData.whatsapp || '-')}`;
      }
      
      if (previewDate) {
        previewDate.textContent = `Tanggal: ${formatDate(selectedData.tanggalSurat)}`;
      }
      
      // Populate letter template
      populateLetterTemplate(selectedData);
      
      // Show preview container
      const dataListContainer = document.getElementById('dataListContainer');
      const previewContainer = document.getElementById('previewContainer');
      
      if (dataListContainer) dataListContainer.classList.remove('active');
      if (previewContainer) previewContainer.classList.add('active');
      
    } catch (error) {
      console.error('Error viewing letter:', error);
      showNotification('Gagal memuat surat: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Populate Letter Template
  function populateLetterTemplate(data) {
    // Format tanggal untuk Indonesia
    function formatLetterDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const bulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                     'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      return `${date.getDate()} ${bulan[date.getMonth()]} ${date.getFullYear()}`;
    }
    
    // Format TTL
    const tempatLahir = data.tempatLahir || '-';
    const tglLahir = data.tanggalLahir ? formatLetterDate(data.tanggalLahir) : '-';
    
    // Format alasan berhenti dalam dua bahasa
    const alasanBerhentiMap = {
      'Kontrak Berakhir': { id: 'Kontrak kerja berakhir', en: 'End of contract' },
      'PHK': { id: 'Pemutusan Hubungan Kerja', en: 'Termination of employment' },
      'Pengunduran Diri': { id: 'Mengundurkan diri secara baik-baik', en: 'Resigned in good standing' },
      'Pensiun': { id: 'Pensiun', en: 'Retirement' },
      'Meninggal Dunia': { id: 'Meninggal dunia', en: 'Deceased' }
    };
    
    const alasanBerhenti = alasanBerhentiMap[data.alasanBerhenti] || 
                          { id: data.alasanBerhenti || 'Kontrak kerja berakhir', 
                            en: data.alasanBerhenti || 'End of contract' };
    
    // Set values
    const letterNo = document.getElementById('letterNo');
    const fieldPenandatangan = document.getElementById('fieldPenandatangan');
    const fieldJabatanPenandatangan = document.getElementById('fieldJabatanPenandatangan');
    const fieldNamaLengkap = document.getElementById('fieldNamaLengkap');
    const fieldTTL = document.getElementById('fieldTTL');
    const fieldJabatan = document.getElementById('fieldJabatan');
    const fieldNIP = document.getElementById('fieldNIP');
    const fieldTanggalMasuk = document.getElementById('fieldTanggalMasuk');
    const fieldTanggalKeluar = document.getElementById('fieldTanggalKeluar');
    const fieldAlasanBerhenti = document.getElementById('fieldAlasanBerhenti');
    const fieldAlasanBerhentiEn = document.getElementById('fieldAlasanBerhentiEn');
    const fieldTempatTanggal = document.getElementById('fieldTempatTanggal');
    const fieldTandaTangan = document.getElementById('fieldTandaTangan');
    const fieldJabatanTTD = document.getElementById('fieldJabatanTTD');
    const fieldWhatsappFooter = document.getElementById('fieldWhatsappFooter');
    
    if (letterNo) letterNo.textContent = `NO : ${data.noSurat || '02/SK-HRD/NEXT/I/25'}`;
    if (fieldPenandatangan) fieldPenandatangan.textContent = data.namaPenandatangan || settings.defaultPenandatangan;
    if (fieldJabatanPenandatangan) fieldJabatanPenandatangan.textContent = data.jabatanPenandatangan || settings.defaultJabatan;
    if (fieldNamaLengkap) fieldNamaLengkap.textContent = data.namaLengkap || '.................................................';
    if (fieldTTL) fieldTTL.textContent = `${tempatLahir}, ${tglLahir}`;
    if (fieldJabatan) fieldJabatan.textContent = data.jabatan || '.................................................';
    if (fieldNIP) fieldNIP.textContent = data.nip || '.................................................';
    if (fieldTanggalMasuk) fieldTanggalMasuk.textContent = data.tanggalMulai ? formatLetterDate(data.tanggalMulai) : '.................................................';
    if (fieldTanggalKeluar) fieldTanggalKeluar.textContent = data.tanggalBerakhir ? formatLetterDate(data.tanggalBerakhir) : '.................................................';
    if (fieldAlasanBerhenti) fieldAlasanBerhenti.textContent = alasanBerhenti.id;
    if (fieldAlasanBerhentiEn) fieldAlasanBerhentiEn.textContent = alasanBerhenti.en;
    if (fieldTempatTanggal) fieldTempatTanggal.textContent = `${settings.kotaTandaTangan}, ${formatLetterDate(data.tanggalSurat || new Date())}`;
    if (fieldTandaTangan) fieldTandaTangan.textContent = data.namaPenandatangan || settings.defaultPenandatangan;
    if (fieldJabatanTTD) fieldJabatanTTD.textContent = data.jabatanPenandatangan || settings.defaultJabatan;
    if (fieldWhatsappFooter) fieldWhatsappFooter.textContent = data.whatsapp || '081383796300';
  }

  // Close Preview
  function closePreview() {
    const previewContainer = document.getElementById('previewContainer');
    const dataListContainer = document.getElementById('dataListContainer');
    
    if (previewContainer) previewContainer.classList.remove('active');
    if (dataListContainer) dataListContainer.classList.add('active');
  }

  // Download PDF
  async function downloadPDF() {
    showLoading(true);
    
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      // Get the letter template
      const element = document.getElementById('letterTemplate');
      
      // Convert to canvas with higher quality
      const canvas = await html2canvas(element, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true,
        logging: false
      });
      
      // Get image data
      const imgData = canvas.toDataURL('image/png');
      
      // Calculate dimensions
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pdfWidth - 20;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      // Add image to PDF
      pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
      
      // Generate filename
      const fileName = `Packlaring_${selectedData.nip || 'NoNIP'}_${selectedData.namaLengkap?.replace(/\s+/g, '_') || 'NoName'}.pdf`;
      
      // Save PDF
      pdf.save(fileName);
      
      // Update status to completed if it was pending
      if (selectedData.status === 'pending') {
        await db.collection('packlaring').doc(selectedDocId).update({
          status: 'completed',
          downloadedAt: new Date(),
          downloadedBy: 'Admin'
        });
        
        // Reload data
        loadData();
      }
      
      showNotification('PDF berhasil didownload!', 'success');
      
    } catch (error) {
      console.error('Error downloading PDF:', error);
      showNotification('Gagal download PDF: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Print Letter
  function printLetter() {
    const printContent = document.getElementById('letterTemplate').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    
    // Restore preview
    const previewContainer = document.getElementById('previewContainer');
    const dataListContainer = document.getElementById('dataListContainer');
    
    if (previewContainer) previewContainer.classList.add('active');
    if (dataListContainer) dataListContainer.classList.remove('active');
  }

  // Export to Excel
  function exportExcel() {
    // Prepare data
    const exportData = filteredData.map(data => ({
      'No Surat': data.noSurat || '',
      'Nama Karyawan': data.namaLengkap || '',
      'NIP': data.nip || '',
      'Nomor KTP': data.nomorKTP || '',
      'Wilayah Area': data.wilayahArea || '',
      'Kabupaten': data.kabupaten || '',
      'Koordinator': data.koordinator || '',
      'Keterangan': data.keterangan || '',
      'WhatsApp': data.whatsapp || '',
      'Jabatan': data.jabatan || '',
      'Departemen': data.deptKaryawan || '',
      'Tempat Lahir': data.tempatLahir || '',
      'Tanggal Lahir': formatShortDate(data.tanggalLahir),
      'Tanggal Mulai': formatShortDate(data.tanggalMulai),
      'Tanggal Berakhir': formatShortDate(data.tanggalBerakhir),
      'Alasan Berhenti': data.alasanBerhenti || '',
      'Status': getStatusText(data.status),
      'Tanggal Surat': formatShortDate(data.tanggalSurat),
      'Tujuan Surat': data.tujuanSurat || '',
      'Email': data.email || '',
      'Tanggal Input': formatShortDate(data.createdAt),
      'Terakhir Update': formatShortDate(data.updatedAt || data.createdAt)
    }));
    
    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(exportData);
    
    // Set column widths
    const wscols = [
      {wch: 20}, {wch: 25}, {wch: 15}, {wch: 20}, {wch: 20},
      {wch: 15}, {wch: 15}, {wch: 15}, {wch: 25}, {wch: 15},
      {wch: 20}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15},
      {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 25},
      {wch: 25}, {wch: 15}, {wch: 15}
    ];
    ws['!cols'] = wscols;
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data Packlaring");
    
    // Generate filename
    const fileName = `Data_Packlaring_${new Date().toISOString().slice(0,10)}.xlsx`;
    
    // Save file
    XLSX.writeFile(wb, fileName);
    
    showNotification('Data berhasil diexport ke Excel!', 'success');
  }

  // Show All Data (without pagination)
  function showAllData() {
    // Show all filtered data in one page
    const oldItemsPerPage = itemsPerPage;
    itemsPerPage = filteredData.length;
    renderDataTable();
    itemsPerPage = oldItemsPerPage;
    
    showNotification(`Menampilkan semua ${filteredData.length} data`, 'success');
  }

  // Refresh Data
  function refreshData() {
    loadData();
  }

  // Load Settings
  function loadSettings() {
    // Load from localStorage
    const savedSettings = localStorage.getItem('packlaringAdminSettings');
    if (savedSettings) {
      settings = JSON.parse(savedSettings);
    }
    
    // Apply to form
    const emailAdmin = document.getElementById('emailAdmin');
    const whatsappAdmin = document.getElementById('whatsappAdmin');
    const autoRefresh = document.getElementById('autoRefresh');
    const formatNoSurat = document.getElementById('formatNoSurat');
    const formatNIP = document.getElementById('formatNIP');
    const kotaTandaTangan = document.getElementById('kotaTandaTangan');
    const defaultPenandatangan = document.getElementById('defaultPenandatangan');
    const defaultJabatan = document.getElementById('defaultJabatan');
    const maxData = document.getElementById('maxData');
    const showOldData = document.getElementById('showOldData');
    const autoBackup = document.getElementById('autoBackup');
    const maxDataPerHari = document.getElementById('maxDataPerHari');
    
    if (emailAdmin) emailAdmin.value = settings.emailAdmin;
    if (whatsappAdmin) whatsappAdmin.value = settings.whatsappAdmin;
    if (autoRefresh) autoRefresh.value = settings.autoRefresh;
    if (formatNoSurat) formatNoSurat.value = settings.formatNoSurat;
    if (formatNIP) formatNIP.value = settings.formatNIP;
    if (kotaTandaTangan) kotaTandaTangan.value = settings.kotaTandaTangan;
    if (defaultPenandatangan) defaultPenandatangan.value = settings.defaultPenandatangan;
    if (defaultJabatan) defaultJabatan.value = settings.defaultJabatan;
    if (maxData) maxData.value = settings.maxData;
    if (showOldData) showOldData.value = settings.showOldData;
    if (autoBackup) autoBackup.value = settings.autoBackup;
    if (maxDataPerHari) maxDataPerHari.value = settings.maxDataPerHari;
    
    // Update items per page
    itemsPerPage = parseInt(settings.maxData) || 20;
    currentPage = 1;
    
    // Setup auto refresh
    setupAutoRefresh();
  }

  // Save Settings
  function saveSettings() {
    const emailAdmin = document.getElementById('emailAdmin');
    const whatsappAdmin = document.getElementById('whatsappAdmin');
    const autoRefresh = document.getElementById('autoRefresh');
    const formatNoSurat = document.getElementById('formatNoSurat');
    const formatNIP = document.getElementById('formatNIP');
    const kotaTandaTangan = document.getElementById('kotaTandaTangan');
    const defaultPenandatangan = document.getElementById('defaultPenandatangan');
    const defaultJabatan = document.getElementById('defaultJabatan');
    const maxData = document.getElementById('maxData');
    const showOldData = document.getElementById('showOldData');
    const autoBackup = document.getElementById('autoBackup');
    const maxDataPerHari = document.getElementById('maxDataPerHari');
    
    if (!emailAdmin || !whatsappAdmin || !autoRefresh) {
      showNotification('Form pengaturan tidak lengkap', 'error');
      return;
    }
    
    settings.emailAdmin = emailAdmin.value;
    settings.whatsappAdmin = whatsappAdmin.value;
    settings.autoRefresh = autoRefresh.value;
    settings.formatNoSurat = formatNoSurat ? formatNoSurat.value : settings.formatNoSurat;
    settings.formatNIP = formatNIP ? formatNIP.value : settings.formatNIP;
    settings.kotaTandaTangan = kotaTandaTangan ? kotaTandaTangan.value : settings.kotaTandaTangan;
    settings.defaultPenandatangan = defaultPenandatangan ? defaultPenandatangan.value : settings.defaultPenandatangan;
    settings.defaultJabatan = defaultJabatan ? defaultJabatan.value : settings.defaultJabatan;
    settings.maxData = maxData ? maxData.value : settings.maxData;
    settings.showOldData = showOldData ? showOldData.value : settings.showOldData;
    settings.autoBackup = autoBackup ? autoBackup.value : settings.autoBackup;
    settings.maxDataPerHari = maxDataPerHari ? maxDataPerHari.value : settings.maxDataPerHari;
    
    localStorage.setItem('packlaringAdminSettings', JSON.stringify(settings));
    
    // Update items per page
    itemsPerPage = parseInt(settings.maxData) || 20;
    currentPage = 1;
    
    if (document.getElementById('tab-data') && document.getElementById('tab-data').classList.contains('active')) {
      renderDataTable();
    }
    
    setupAutoRefresh();
    
    showNotification('Pengaturan berhasil disimpan!', 'success');
  }

  // Reset Settings
  function resetSettings() {
    if (confirm('Apakah Anda yakin ingin mereset pengaturan ke default?')) {
      settings = {
        emailAdmin: "admin@nextlogistik.com",
        whatsappAdmin: "081383796300",
        autoRefresh: 60,
        formatNoSurat: "{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}",
        formatNIP: "NEXT-{TAHUN}-{BULAN}-{NO}",
        kotaTandaTangan: "Bekasi",
        defaultPenandatangan: "M. Fajrian Noor",
        defaultJabatan: "Direktur",
        maxData: 20,
        showOldData: 90,
        autoBackup: "weekly",
        maxDataPerHari: "0"
      };
      
      localStorage.setItem('packlaringAdminSettings', JSON.stringify(settings));
      loadSettings();
      
      showNotification('Pengaturan berhasil direset ke default!', 'success');
    }
  }

  // Setup Auto Refresh
  function setupAutoRefresh() {
    // Clear existing interval
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
    
    // Setup new interval if not 0
    const refreshSeconds = parseInt(settings.autoRefresh);
    if (refreshSeconds > 0) {
      autoRefreshInterval = setInterval(() => {
        loadData();
      }, refreshSeconds * 1000);
      
      console.log(`Auto refresh diatur setiap ${refreshSeconds} detik`);
    }
  }

  // Initialize Admin Panel
  document.addEventListener('DOMContentLoaded', function() {
    // Set default dates for filter
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setMonth(today.getMonth() - 1);
    
    const filterDari = document.getElementById('filterDari');
    const filterSampai = document.getElementById('filterSampai');
    
    if (filterDari) filterDari.value = lastMonth.toISOString().split('T')[0];
    if (filterSampai) filterSampai.value = today.toISOString().split('T')[0];
    
    // Add sort event listeners to table headers
    document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
      th.addEventListener('click', function() {
        const sortColumn = this.getAttribute('data-sort');
        toggleSort(sortColumn);
      });
    });
    
    // Set initial sort indicator
    const initialTh = document.querySelector(`.data-table th[data-sort="${currentSortColumn}"]`);
    if (initialTh) {
      initialTh.classList.add(`sort-${currentSortDirection}`);
    }
    
    // Load initial data
    loadData();
    loadSettings();
    
    // Setup auto refresh
    setupAutoRefresh();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl + R untuk refresh
      if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        refreshData();
      }
      
      // Ctrl + F untuk focus search
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.focus();
      }
      
      // Escape untuk close modal
      if (e.key === 'Escape') {
        closeModal();
        closeDetailModal();
        closeDeleteModal();
        closePreview();
      }
      
      // Ctrl + A untuk select all pada tabel
      if (e.ctrlKey && e.key === 'a' && document.getElementById('tab-data').classList.contains('active')) {
        e.preventDefault();
        const selectAll = document.getElementById('selectAll');
        if (selectAll) {
          selectAll.checked = !selectAll.checked;
          toggleSelectAll();
        }
      }
      
      // Delete key untuk hapus data terpilih
      if (e.key === 'Delete' && selectedIds.size > 0) {
        e.preventDefault();
        deleteSelected();
      }
    });
  });
</script>
</body>
</html>
