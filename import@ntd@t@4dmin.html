<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - NEXT Cargo Logistics</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <!-- Excel Import/Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Chart.js untuk grafik -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font Awesome untuk ikon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    /* Header Admin */
    .admin-header {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      padding: 25px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .company-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .company-logo {
      font-size: 36px;
      font-weight: bold;
      background: white;
      color: #e74c3c;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .company-info h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .company-info .subtitle {
      font-size: 14px;
      opacity: 0.9;
    }

    .admin-stats {
      display: flex;
      gap: 20px;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px 25px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      font-size: 28px;
      font-weight: bold;
      display: block;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.8;
    }

    /* Main Content */
    .admin-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      min-height: 800px;
    }

    /* Sidebar */
    .admin-sidebar {
      background: #f8f9fa;
      border-right: 1px solid #e0e0e0;
      padding: 30px;
    }

    .search-box {
      margin-bottom: 30px;
    }

    .search-input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      background: white;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #e74c3c;
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }

    .filter-section {
      margin-bottom: 30px;
    }

    .filter-section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .filter-group {
      margin-bottom: 20px;
    }

    .filter-label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }

    .filter-select,
    .filter-date {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      font-size: 14px;
    }

    .recent-requests {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .recent-requests h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .recent-list {
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .recent-item {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .recent-item:hover {
      background: #f8f9fa;
    }

    .recent-item.active {
      background: #e74c3c;
      color: white;
      border-radius: 6px;
    }

    /* Main Panel */
    .admin-main {
      padding: 30px;
      background: #fff;
      overflow-x: auto;
    }

    /* Data List */
    .data-list-container {
      display: none;
    }

    .data-list-container.active {
      display: block;
    }

    .data-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .data-header h2 {
      color: #333;
      font-size: 22px;
    }

    .data-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-success:hover {
      background: #219653;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    /* Data Table Container */
    .data-table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      width: 100%;
      min-width: 1400px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: #2c3e50;
      color: white;
      padding: 18px 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      cursor: pointer;
      transition: background 0.3s;
    }

    .data-table th:hover {
      background: #1a252f;
    }

    .data-table th.sort-asc::after {
      content: " ‚Üë";
      font-size: 12px;
    }

    .data-table th.sort-desc::after {
      content: " ‚Üì";
      font-size: 12px;
    }

    .data-table td {
      padding: 18px 15px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      white-space: nowrap;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-processed {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      white-space: nowrap;
    }

    /* Pagination Styles */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }

    .pagination-info {
      font-size: 14px;
      color: #555;
    }

    .pagination-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .pagination-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #e74c3c;
      color: white;
      border-color: #e74c3c;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-numbers {
      display: flex;
      gap: 5px;
    }

    .page-number {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .page-number:hover {
      background: #f0f0f0;
    }

    .page-number.active {
      background: #e74c3c;
      color: white;
      border-color: #e74c3c;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 25px 30px;
      background: #2c3e50;
      color: white;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: 500;
      font-size: 13px;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      background: #f8f9fa;
    }

    .form-control:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    /* Extended Edit Modal */
    .extended-edit-form {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }

    .extended-edit-form .form-group.full-width {
      grid-column: 1 / -1;
    }

    /* Field lokasi khusus teknisi */
    .lokasi-teknisi {
      display: none;
    }

    .lokasi-teknisi.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .admin-content {
        grid-template-columns: 1fr;
      }

      .admin-sidebar {
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
      }
    }

    @media (max-width: 992px) {
      .data-table-container {
        min-width: 100%;
      }
      
      .data-table {
        min-width: 1400px;
      }
      
      .extended-edit-form {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }

      .admin-stats {
        width: 100%;
        justify-content: center;
      }

      .data-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .data-actions {
        width: 100%;
      }

      .btn {
        flex: 1;
        justify-content: center;
      }

      .pagination-container {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .page-numbers {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .extended-edit-form {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 576px) {
      .extended-edit-form {
        grid-template-columns: 1fr;
      }
    }

    /* Loading */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #e74c3c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 1001;
      transform: translateX(400px);
      transition: transform 0.3s;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 5px solid #27ae60;
    }

    .notification.error {
      border-left: 5px solid #e74c3c;
    }

    .notification.warning {
      border-left: 5px solid #f39c12;
    }

    .notification.info {
      border-left: 5px solid #3498db;
    }

    .notification-icon {
      font-size: 24px;
    }

    .notification.success .notification-icon {
      color: #27ae60;
    }

    .notification.error .notification-icon {
      color: #e74c3c;
    }

    .notification.warning .notification-icon {
      color: #f39c12;
    }

    .notification.info .notification-icon {
      color: #3498db;
    }

    .notification-content h4 {
      margin: 0 0 5px 0;
      color: #333;
    }

    .notification-content p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }

    .notification-close {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 20px;
      padding: 0;
      margin-left: 10px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab-btn:hover {
      color: #e74c3c;
    }

    .tab-btn.active {
      color: #e74c3c;
      border-bottom-color: #e74c3c;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-icon {
      font-size: 40px;
      margin-bottom: 15px;
    }

    .card-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card-value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .card-change {
      font-size: 12px;
      color: #27ae60;
    }

    .card-change.negative {
      color: #e74c3c;
    }

    /* Storage Info Card */
    .storage-card {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }

    .storage-card .card-icon {
      color: white;
    }

    .storage-card .card-title {
      color: rgba(255, 255, 255, 0.9);
    }

    .storage-card .card-value {
      color: white;
    }

    .storage-progress {
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      margin-top: 15px;
      overflow: hidden;
    }

    .storage-progress-bar {
      height: 100%;
      background: white;
      border-radius: 4px;
      transition: width 0.3s;
    }

    .storage-details {
      margin-top: 10px;
      font-size: 12px;
      opacity: 0.9;
    }

    /* Activity and Province Stats */
    .activity-item, .province-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .activity-item:last-child, .province-item:last-child {
      border-bottom: none;
    }

    .activity-icon, .province-icon {
      font-size: 20px;
      width: 40px;
      text-align: center;
    }

    .activity-content, .province-content {
      flex: 1;
    }

    .province-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-top: 5px;
      overflow: hidden;
    }

    .province-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    /* Province Colors */
    .province-color-0 { background: #e74c3c; }
    .province-color-1 { background: #3498db; }
    .province-color-2 { background: #2ecc71; }
    .province-color-3 { background: #f39c12; }
    .province-color-4 { background: #9b59b6; }
    .province-color-5 { background: #1abc9c; }
    .province-color-6 { background: #d35400; }
    .province-color-7 { background: #c0392b; }
    .province-color-8 { background: #16a085; }
    .province-color-9 { background: #8e44ad; }

    /* Import/Export Modal */
    .import-export-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .import-export-container h4 {
      margin-bottom: 15px;
      color: #333;
    }

    .file-upload-area {
      border: 2px dashed #3498db;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
      margin-bottom: 20px;
    }

    .file-upload-area:hover {
      background: #e8f4fc;
      border-color: #2980b9;
    }

    .file-upload-area.drag-over {
      background: #d4edda;
      border-color: #28a745;
    }

    .file-upload-icon {
      font-size: 48px;
      color: #3498db;
      margin-bottom: 15px;
    }

    .file-input {
      display: none;
    }

    .file-info {
      margin-top: 15px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }

    .file-info h5 {
      color: #1a56db;
      margin-bottom: 8px;
    }

    .file-info p {
      color: #1a56db;
      font-size: 12px;
      margin: 0;
    }

    .import-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .template-download {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .template-download h4 {
      margin-bottom: 10px;
      color: #333;
    }

    .template-info {
      padding: 15px;
      background: #fff3cd;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
      margin-bottom: 15px;
    }

    .template-info h5 {
      color: #856404;
      margin-bottom: 8px;
    }

    .template-info p {
      color: #856404;
      font-size: 12px;
      margin: 0;
    }

    /* Share Link Modal */
    .share-link-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .share-link-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #3498db;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      font-family: monospace;
      margin-bottom: 10px;
    }

    .share-link-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .copy-btn {
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .copy-btn:hover {
      background: #2980b9;
    }

    .whatsapp-btn {
      padding: 10px 20px;
      background: #25D366;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .whatsapp-btn:hover {
      background: #128C7E;
    }

    .share-info {
      margin-top: 15px;
      padding: 10px;
      background: #fff3cd;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }

    .share-info h4 {
      color: #856404;
      margin-bottom: 5px;
    }

    .share-info p {
      color: #856404;
      font-size: 12px;
      margin: 0;
    }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <p style="color: #e74c3c; font-weight: bold; margin-top: 10px;">Memuat data...</p>
</div>

<!-- Notification -->
<div class="notification" id="notification">
  <div class="notification-icon">üîî</div>
  <div class="notification-content">
    <h4>Notifikasi</h4>
    <p>Pesan notifikasi</p>
  </div>
  <button class="notification-close" onclick="hideNotification()">√ó</button>
</div>

<!-- Modal Tambah Data Baru -->
<div class="modal" id="addModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Tambah Data Baru</h3>
      <button class="modal-close" onclick="closeAddModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form id="addForm" class="extended-edit-form">
        <!-- Data Pribadi -->
        <div class="form-group">
          <label>Nama Lengkap *</label>
          <input type="text" id="addNamaLengkap" class="form-control" placeholder="Nama Lengkap" required>
        </div>
        <div class="form-group">
          <label>NIP *</label>
          <input type="text" id="addNIP" class="form-control" placeholder="NIP" required>
        </div>
        <div class="form-group">
          <label>Nomor KTP *</label>
          <input type="text" id="addNomorKTP" class="form-control" placeholder="Nomor KTP" required>
        </div>
        <div class="form-group">
          <label>Tempat Lahir</label>
          <input type="text" id="addTempatLahir" class="form-control" placeholder="Tempat Lahir">
        </div>
        <div class="form-group">
          <label>Tanggal Lahir</label>
          <input type="date" id="addTanggalLahir" class="form-control">
        </div>
        
        <!-- Data Perusahaan -->
        <div class="form-group">
          <label>Jabatan *</label>
          <select id="addJabatan" class="form-control" required onchange="toggleAddLokasiFields()">
            <option value="">PILIH JABATAN</option>
            <option value="TEKNISI">TEKNISI</option>
            <option value="STAFF ADMIN PUSAT">STAFF ADMIN PUSAT</option>
            <option value="STAFF ADMIN WILAYAH">STAFF ADMIN WILAYAH</option>
            <option value="SPV AREA">SPV AREA</option>
            <option value="KORDINATOR WILAYAH">KORDINATOR WILAYAH</option>
            <option value="CUSTOMER SERVICE">CUSTOMER SERVICE</option>
            <option value="STAFF MONITORING">STAFF MONITORING</option>
            <option value="MANAGER AREA">MANAGER AREA</option>
          </select>
        </div>
        <div class="form-group">
          <label>Departemen</label>
          <input type="text" id="addDeptKaryawan" class="form-control" placeholder="Departemen">
        </div>
        <div class="form-group">
          <label>Tanggal Mulai *</label>
          <input type="date" id="addTanggalMulai" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Tanggal Berakhir *</label>
          <input type="date" id="addTanggalBerakhir" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Alasan Berhenti *</label>
          <select id="addAlasanBerhenti" class="form-control" required>
            <option value="KONTRAK BERAKHIR">Kontrak Berakhir</option>
            <option value="PENGUNDURAN DIRI">Pengunduran Diri</option>
            <option value="PHK">PHK</option>
            <option value="PENSIUN">Pensiun</option>
            <option value="MENINGGAL DUNIA">Meninggal Dunia</option>
          </select>
        </div>
        
        <!-- Data Surat -->
        <div class="form-group">
          <label>Nomor Surat *</label>
          <input type="text" id="addNoSurat" class="form-control" placeholder="Nomor Surat" required>
        </div>
        <div class="form-group">
          <label>Tanggal Surat *</label>
          <input type="date" id="addTanggalSurat" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Tujuan Surat</label>
          <input type="text" id="addTujuanSurat" class="form-control" placeholder="Tujuan Surat">
        </div>
        
        <!-- Data Kontak -->
        <div class="form-group">
          <label>WhatsApp *</label>
          <input type="text" id="addWhatsapp" class="form-control" placeholder="WhatsApp" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="addEmail" class="form-control" placeholder="Email">
        </div>
        
        <!-- Field lokasi khusus teknisi -->
        <div id="addLokasiTeknisiFields" class="lokasi-teknisi">
          <div class="form-group full-width">
            <label style="color: #e74c3c; font-weight: bold;">üìç LOKASI TEKNISI</label>
          </div>
          <div class="form-group">
            <label>Provinsi/Wilayah *</label>
            <input type="text" id="addWilayah" class="form-control" placeholder="Provinsi/Wilayah">
          </div>
          <div class="form-group">
            <label>Kabupaten</label>
            <input type="text" id="addKabupaten" class="form-control" placeholder="Nama Kabupaten">
          </div>
          <div class="form-group">
            <label>Koordinator</label>
            <input type="text" id="addKoordinator" class="form-control" placeholder="Nama Koordinator">
          </div>
        </div>
        
        <!-- Penandatangan -->
        <div class="form-group">
          <label>Nama Penandatangan *</label>
          <input type="text" id="addNamaPenandatangan" class="form-control" placeholder="Nama Penandatangan" value="M. Fajrian Noor" required>
        </div>
        <div class="form-group">
          <label>Jabatan Penandatangan *</label>
          <input type="text" id="addJabatanPenandatangan" class="form-control" placeholder="Jabatan Penandatangan" value="Direktur" required>
        </div>
        <div class="form-group">
          <label>Kota Penandatangan *</label>
          <input type="text" id="addKotaPenandatangan" class="form-control" placeholder="Kota Penandatangan" value="Bekasi" required>
        </div>
        
        <!-- Keterangan -->
        <div class="form-group full-width">
          <label>Keterangan User</label>
          <textarea id="addKeterangan" class="form-control" rows="2" placeholder="Keterangan yang diinputkan user..."></textarea>
        </div>
        
        <!-- Status -->
        <div class="form-group">
          <label>Status Surat *</label>
          <select id="addStatus" class="form-control" required>
            <option value="pending">‚è≥ Pending</option>
            <option value="processed">üîÑ Dalam Proses</option>
            <option value="completed">‚úÖ Selesai</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px; grid-column: 1 / -1;">
          <button type="button" class="btn btn-success" onclick="saveNewData()" style="flex: 1;">
            üíæ Simpan Data Baru
          </button>
          <button type="button" class="btn btn-danger" onclick="closeAddModal()" style="flex: 1;">
            ‚ùå Batal
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Edit Data Lengkap -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è Edit Data Lengkap</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form id="editForm" class="extended-edit-form">
        <!-- Data Pribadi -->
        <div class="form-group">
          <label>Nama Lengkap *</label>
          <input type="text" id="editNamaLengkap" class="form-control" placeholder="Nama Lengkap" required>
        </div>
        <div class="form-group">
          <label>NIP *</label>
          <input type="text" id="editNIP" class="form-control" placeholder="NIP" required>
        </div>
        <div class="form-group">
          <label>Nomor KTP *</label>
          <input type="text" id="editNomorKTP" class="form-control" placeholder="Nomor KTP" required>
        </div>
        <div class="form-group">
          <label>Tempat Lahir</label>
          <input type="text" id="editTempatLahir" class="form-control" placeholder="Tempat Lahir">
        </div>
        <div class="form-group">
          <label>Tanggal Lahir</label>
          <input type="date" id="editTanggalLahir" class="form-control">
        </div>
        
        <!-- Data Perusahaan -->
        <div class="form-group">
          <label>Jabatan *</label>
          <select id="editJabatan" class="form-control" required onchange="toggleLokasiFields()">
            <option value="">PILIH JABATAN</option>
            <option value="TEKNISI">TEKNISI</option>
            <option value="STAFF ADMIN PUSAT">STAFF ADMIN PUSAT</option>
            <option value="STAFF ADMIN WILAYAH">STAFF ADMIN WILAYAH</option>
            <option value="SPV AREA">SPV AREA</option>
            <option value="KORDINATOR WILAYAH">KORDINATOR WILAYAH</option>
            <option value="CUSTOMER SERVICE">CUSTOMER SERVICE</option>
            <option value="STAFF MONITORING">STAFF MONITORING</option>
            <option value="MANAGER AREA">MANAGER AREA</option>
          </select>
        </div>
        <div class="form-group">
          <label>Departemen</label>
          <input type="text" id="editDeptKaryawan" class="form-control" placeholder="Departemen">
        </div>
        <div class="form-group">
          <label>Tanggal Mulai *</label>
          <input type="date" id="editTanggalMulai" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Tanggal Berakhir *</label>
          <input type="date" id="editTanggalBerakhir" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Alasan Berhenti *</label>
          <select id="editAlasanBerhenti" class="form-control" required>
            <option value="KONTRAK BERAKHIR">Kontrak Berakhir</option>
            <option value="PENGUNDURAN DIRI">Pengunduran Diri</option>
            <option value="PHK">PHK</option>
            <option value="PENSIUN">Pensiun</option>
            <option value="MENINGGAL DUNIA">Meninggal Dunia</option>
          </select>
        </div>
        
        <!-- Data Surat -->
        <div class="form-group">
          <label>Nomor Surat *</label>
          <input type="text" id="editNoSurat" class="form-control" placeholder="Nomor Surat" required>
        </div>
        <div class="form-group">
          <label>Tanggal Surat *</label>
          <input type="date" id="editTanggalSurat" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Tujuan Surat</label>
          <input type="text" id="editTujuanSurat" class="form-control" placeholder="Tujuan Surat">
        </div>
        
        <!-- Data Kontak -->
        <div class="form-group">
          <label>WhatsApp *</label>
          <input type="text" id="editWhatsapp" class="form-control" placeholder="WhatsApp" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="editEmail" class="form-control" placeholder="Email">
        </div>
        
        <!-- Field lokasi khusus teknisi -->
        <div id="lokasiTeknisiFields" class="lokasi-teknisi">
          <div class="form-group full-width">
            <label style="color: #e74c3c; font-weight: bold;">üìç LOKASI TEKNISI</label>
          </div>
          <div class="form-group">
            <label>Provinsi/Wilayah *</label>
            <input type="text" id="editWilayah" class="form-control" placeholder="Provinsi/Wilayah">
          </div>
          <div class="form-group">
            <label>Kabupaten</label>
            <input type="text" id="editKabupaten" class="form-control" placeholder="Nama Kabupaten">
          </div>
          <div class="form-group">
            <label>Koordinator</label>
            <input type="text" id="editKoordinator" class="form-control" placeholder="Nama Koordinator">
          </div>
        </div>
        
        <!-- Penandatangan -->
        <div class="form-group">
          <label>Nama Penandatangan *</label>
          <input type="text" id="editNamaPenandatangan" class="form-control" placeholder="Nama Penandatangan" required>
        </div>
        <div class="form-group">
          <label>Jabatan Penandatangan *</label>
          <input type="text" id="editJabatanPenandatangan" class="form-control" placeholder="Jabatan Penandatangan" required>
        </div>
        <div class="form-group">
          <label>Kota Penandatangan *</label>
          <input type="text" id="editKotaPenandatangan" class="form-control" placeholder="Kota Penandatangan" required>
        </div>
        
        <!-- Keterangan -->
        <div class="form-group full-width">
          <label>Keterangan User</label>
          <textarea id="editKeterangan" class="form-control" rows="2" placeholder="Keterangan yang diinputkan user..."></textarea>
        </div>
        
        <!-- Status -->
        <div class="form-group">
          <label>Status Surat *</label>
          <select id="editStatus" class="form-control" required>
            <option value="pending">‚è≥ Pending</option>
            <option value="processed">üîÑ Dalam Proses</option>
            <option value="completed">‚úÖ Selesai</option>
          </select>
        </div>
        
        <!-- Catatan -->
        <div class="form-group full-width">
          <label>Catatan Admin</label>
          <textarea id="editCatatan" class="form-control" rows="3" placeholder="Tambahkan catatan jika perlu..."></textarea>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px; grid-column: 1 / -1;">
          <button type="button" class="btn btn-primary" onclick="updateData()" style="flex: 1;">
            üíæ Simpan Perubahan
          </button>
          <button type="button" class="btn btn-danger" onclick="closeModal()" style="flex: 1;">
            ‚ùå Batal
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Detail Data -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üìã Detail Lengkap Data</h3>
      <button class="modal-close" onclick="closeDetailModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div id="detailContent">
        <!-- Detail akan diisi oleh JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Modal Hapus Data -->
<div class="modal" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üóëÔ∏è Hapus Data</h3>
      <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div id="deleteContent">
        <div style="text-align: center; margin-bottom: 30px;">
          <div style="font-size: 60px; color: #e74c3c; margin-bottom: 20px;">‚ö†Ô∏è</div>
          <h3 style="color: #333; margin-bottom: 10px;" id="deleteTitle">Konfirmasi Hapus Data</h3>
          <p style="color: #666;" id="deleteMessage">Apakah Anda yakin ingin menghapus data ini?</p>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
          <h4 style="margin-bottom: 15px; color: #333;">üìã Detail Data yang Akan Dihapus</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <div>
              <small style="color: #888;">Nama</small>
              <div><strong id="deleteNama">-</strong></div>
            </div>
            <div>
              <small style="color: #888;">NIP</small>
              <div><strong id="deleteNIP">-</strong></div>
            </div>
            <div>
              <small style="color: #888;">Nomor Surat</small>
              <div><strong id="deleteNoSurat">-</strong></div>
            </div>
            <div>
              <small style="color: #888;">Tanggal Input</small>
              <div><strong id="deleteTanggal">-</strong></div>
            </div>
          </div>
        </div>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #ffc107;">
          <h5 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è PERINGATAN</h5>
          <p style="color: #856404; font-size: 14px; margin: 0;">
            Data yang sudah dihapus <strong>TIDAK DAPAT</strong> dikembalikan. Pastikan Anda sudah mencetak atau mendownload data sebelum menghapus.
          </p>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
          <button type="button" class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">
            üóëÔ∏è Ya, Hapus Data
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">
            ‚ùå Batalkan
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Import/Export Excel -->
<div class="modal" id="importExportModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üìä Import/Export Excel</h3>
      <button class="modal-close" onclick="closeImportExportModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="import-export-container">
        <!-- Import Section -->
        <h4>üì• Import Data dari Excel</h4>
        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
          <div class="file-upload-icon">üìÅ</div>
          <h4 style="color: #3498db; margin-bottom: 10px;">Klik atau drag file Excel ke sini</h4>
          <p style="color: #666; margin-bottom: 10px;">Format file: .xlsx, .xls, .csv</p>
          <small style="color: #999;">Maksimal 10MB</small>
          <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
        </div>
        
        <div id="filePreview" style="display: none;">
          <div class="file-info">
            <h5>File Dipilih:</h5>
            <p id="fileName">-</p>
            <p id="fileSize">-</p>
            <p id="fileRowCount">-</p>
          </div>
          
          <div class="import-actions">
            <button class="btn btn-success" onclick="importExcelData()">
              üì• Import Data
            </button>
            <button class="btn btn-warning" onclick="previewImportData()">
              üëÅÔ∏è Preview Data
            </button>
            <button class="btn btn-danger" onclick="clearSelectedFile()">
              ‚ùå Hapus File
            </button>
          </div>
        </div>
        
        <div id="importPreview" style="display: none; margin-top: 20px;">
          <h5>Preview Data yang akan diimport:</h5>
          <div id="importPreviewTable" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
        </div>
        
        <!-- Export Section -->
        <div class="template-download">
          <h4>üì§ Export Data ke Excel</h4>
          
          <div class="template-info">
            <h5>Informasi Format Excel:</h5>
            <p>‚Ä¢ Export akan mencakup semua kolom termasuk Link Download</p>
            <p>‚Ä¢ File dapat diedit dan diimport kembali untuk update data</p>
            <p>‚Ä¢ Pastikan format kolom tetap sama saat mengedit</p>
          </div>
          
          <div class="import-actions">
            <button class="btn btn-primary" onclick="exportExcelWithLinks()">
              üìä Export dengan Link
            </button>
            <button class="btn btn-info" onclick="downloadTemplate()">
              üìã Download Template
            </button>
          </div>
          
          <div style="margin-top: 15px; padding: 10px; background: #f1f8ff; border-radius: 8px;">
            <h5 style="color: #1a56db; margin-bottom: 8px;">‚ÑπÔ∏è Cara Import/Edit Data:</h5>
            <p style="color: #1a56db; font-size: 12px; margin: 0;">
              1. Export data ke Excel<br>
              2. Edit data di Excel sesuai kebutuhan<br>
              3. Save file Excel<br>
              4. Import kembali file yang sudah diedit<br>
              5. Sistem akan update data yang ada dan tambah data baru
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Generate Link -->
<div class="modal" id="shareModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üîó Generate Link Download</h3>
      <button class="modal-close" onclick="closeShareModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="share-link-container">
        <h4 style="margin-bottom: 15px; color: #333;">üìã Informasi Data</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div>
            <small style="color: #888;">Nama</small>
            <div><strong id="shareNama">-</strong></div>
          </div>
          <div>
            <small style="color: #888;">NIP</small>
            <div><strong id="shareNIP">-</strong></div>
          </div>
          <div>
            <small style="color: #888;">Nomor KTP</small>
            <div><strong id="shareKTP">-</strong></div>
          </div>
          <div>
            <small style="color: #888;">Status</small>
            <div><strong id="shareStatus">-</strong></div>
          </div>
        </div>
        
        <h4 style="margin-bottom: 10px; color: #333;">üîó Link Download</h4>
        <input type="text" id="shareLinkInput" class="share-link-input" readonly value="https://example.com/download-letter.html">
        
        <div class="share-link-actions">
          <button class="copy-btn" onclick="copyShareLink()">
            üìã Copy Link
          </button>
          <a href="#" id="whatsappShareBtn" class="whatsapp-btn" target="_blank">
            üí¨ Share ke User
          </a>
          <button class="copy-btn" onclick="sendToAdminWhatsApp()" style="background: #3498db;">
            üì± Kirim ke Admin
          </button>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #f1f8ff; border-radius: 8px; border-left: 4px solid #3498db;">
          <h5 style="color: #1a56db; margin-bottom: 8px;">‚ÑπÔ∏è Format WhatsApp:</h5>
          <p style="color: #1a56db; font-size: 12px; margin: 0;">
            <strong>0812/0813/0851/0852/0853</strong> ‚Üí otomatis diubah ke <strong>62812/62813/62851/62852/62853</strong>
          </p>
        </div>
        
        <div class="share-info">
          <h4>‚ÑπÔ∏è Cara Penggunaan:</h4>
          <p>1. Copy link di atas atau share via WhatsApp</p>
          <p>2. User akan diarahkan ke halaman download</p>
          <p>3. User harus memasukkan nomor KTP untuk verifikasi</p>
          <p>4. Status akan otomatis berubah menjadi "Selesai" saat user download</p>
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
          <h4 style="margin-bottom: 10px; color: #333;">‚öôÔ∏è Opsi Tambahan</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-success btn-small" onclick="markAsCompleted()">
              ‚úÖ Tandai Selesai
            </button>
            <button class="btn btn-warning btn-small" onclick="sendWhatsAppNotification()">
              üì± Notifikasi User
            </button>
            <button class="btn btn-info btn-small" onclick="sendTestLink()">
              üîó Test Link
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Admin Container -->
<div class="admin-container">
  <!-- Header -->
  <div class="admin-header">
    <div class="company-brand">
      <div class="company-logo">NEXT PROJECT IFP</div>
      <div class="company-info">
        <h1>PANEL ADMIN PAKLARING</h1>
        <div class="subtitle">NEXT Cargo Logistics ‚Ä¢ Whatsapp: 081383796300</div>
      </div>
    </div>
    
    <div class="admin-stats">
      <div class="stat-item">
        <span class="stat-number" id="totalData">0</span>
        <span class="stat-label">Total Data</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="pendingData">0</span>
        <span class="stat-label">Pending</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="completedData">0</span>
        <span class="stat-label">Selesai</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-content">
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Cari berdasarkan Nama, NIP, No. KTP, atau No. Surat..." onkeyup="filterData()">
      </div>
      
      <div class="filter-section">
        <h3>üìä Filter Data</h3>
        
        <div class="filter-group">
          <label class="filter-label">Status Surat</label>
          <select id="filterStatus" class="filter-select" onchange="filterData()">
            <option value="all">Semua Status</option>
            <option value="pending">Pending</option>
            <option value="processed">Dalam Proses</option>
            <option value="completed">Selesai</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Bulan</label>
          <select id="filterBulan" class="filter-select" onchange="filterData()">
            <option value="all">Semua Bulan</option>
            <option value="1">Januari</option>
            <option value="2">Februari</option>
            <option value="3">Maret</option>
            <option value="4">April</option>
            <option value="5">Mei</option>
            <option value="6">Juni</option>
            <option value="7">Juli</option>
            <option value="8">Agustus</option>
            <option value="9">September</option>
            <option value="10">Oktober</option>
            <option value="11">November</option>
            <option value="12">Desember</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Tanggal Dari</label>
          <input type="date" id="filterDari" class="filter-date" onchange="filterData()">
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Tanggal Sampai</label>
          <input type="date" id="filterSampai" class="filter-date" onchange="filterData()">
        </div>
      </div>
      
      <div class="recent-requests">
        <h3>üïê Permintaan Terbaru</h3>
        <ul class="recent-list" id="recentList">
          <!-- Data akan diisi dari Firebase -->
        </ul>
      </div>
    </div>

    <!-- Main Panel -->
    <div class="admin-main">
      <!-- Tabs Navigation -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="showTab('data')">üìã Data Packlaring</button>
        <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Pengaturan</button>
      </div>

      <!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-content active">
        <div class="dashboard-cards">
          <div class="card">
            <div class="card-icon">üìÑ</div>
            <div class="card-title">Total Surat</div>
            <div class="card-value" id="cardTotal">0</div>
            <div class="card-change" id="cardChange">+0% dari bulan lalu</div>
          </div>
          
          <div class="card">
            <div class="card-icon">‚è≥</div>
            <div class="card-title">Pending</div>
            <div class="card-value" id="cardPending">0</div>
            <div class="card-change">Perlu tindakan</div>
          </div>
          
          <div class="card">
            <div class="card-icon">‚úÖ</div>
            <div class="card-title">Selesai</div>
            <div class="card-value" id="cardCompleted">0</div>
            <div class="card-change" id="cardCompletedChange">+0%</div>
          </div>
          
          <div class="card storage-card">
            <div class="card-icon">üíæ</div>
            <div class="card-title">Storage Data</div>
            <div class="card-value" id="storageSize">0 KB</div>
            <div class="storage-progress">
              <div class="storage-progress-bar" id="storageProgressBar" style="width: 0%"></div>
            </div>
            <div class="storage-details" id="storageDetails">
              <span id="storageUsed">0</span> dari <span id="storageTotal">0</span> data
            </div>
          </div>
        </div>

        <div style="background: white; border-radius: 15px; padding: 25px; margin-top: 20px;">
          <h3 style="margin-bottom: 20px; color: #333;">üìà Statistik Bulanan</h3>
          <div id="chartContainer" style="height: 300px;">
            <canvas id="statsChart"></canvas>
          </div>
        </div>

        <!-- Aktivitas Terbaru dan Top Provinsi -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
          <div style="background: white; border-radius: 15px; padding: 25px;">
            <h4 style="margin-bottom: 15px; color: #333;">üìã Aktivitas Terbaru</h4>
            <div id="activityList" style="max-height: 300px; overflow-y: auto;">
              <p style="text-align: center; color: #666; padding: 20px;">Memuat aktivitas...</p>
            </div>
          </div>
          
          <div style="background: white; border-radius: 15px; padding: 25px;">
            <h4 style="margin-bottom: 15px; color: #333;">üèÜ Top Provinsi</h4>
            <div id="provinceStats" style="max-height: 300px; overflow-y: auto;">
              <p style="text-align: center; color: #666; padding: 20px;">Memuat data provinsi...</p>
            </div>
          </div>
        </div>

        <!-- Download Statistics -->
        <div style="background: white; border-radius: 15px; padding: 25px; margin-top: 30px;">
          <h3 style="margin-bottom: 20px; color: #333;">üìä Statistik Download</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div class="card">
              <div class="card-icon">üì•</div>
              <div class="card-title">Total Download</div>
              <div class="card-value" id="totalDownloads">0</div>
              <div class="card-change">Hari ini: <span id="todayDownloads">0</span></div>
            </div>
            
            <div class="card">
              <div class="card-icon">üîó</div>
              <div class="card-title">Link Dibagikan</div>
              <div class="card-value" id="totalLinks">0</div>
              <div class="card-change">Bulan ini: <span id="monthLinks">0</span></div>
            </div>
            
            <div class="card">
              <div class="card-icon">‚è∞</div>
              <div class="card-title">Rata-rata Waktu</div>
              <div class="card-value" id="avgTime">0h</div>
              <div class="card-change">Pending ke Selesai</div>
            </div>
            
            <div class="card">
              <div class="card-icon">üìà</div>
              <div class="card-title">Konversi</div>
              <div class="card-value" id="conversionRate">0%</div>
              <div class="card-change">Download/Request</div>
            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <h4 style="margin-bottom: 15px; color: #333;">üìã Download Terakhir (7 Hari)</h4>
            <div id="recentDownloads" style="max-height: 200px; overflow-y: auto;">
              <p style="text-align: center; color: #666; padding: 20px;">Memuat data download...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Data List Tab -->
      <div id="tab-data" class="tab-content">
        <div class="data-list-container active" id="dataListContainer">
          <div class="data-header">
            <h2>üìã Data Packlaring</h2>
            <div class="data-actions">
              <button class="btn btn-success" onclick="showAddModal()">
                ‚ûï Tambah Data Baru
              </button>
              <button class="btn btn-primary" onclick="showImportExportModal()">
                üìä Import/Export Excel
              </button>
              <button class="btn btn-info" onclick="refreshData()">
                üîÑ Refresh Data
              </button>
              <button class="btn btn-warning" onclick="showAllData()">
                üëÅÔ∏è Tampilkan Semua
              </button>
              <button class="btn btn-danger" onclick="deleteMultiple()">
                üóëÔ∏è Hapus Multiple
              </button>
            </div>
          </div>
          
          <!-- Checkbox untuk seleksi massal -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px;">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="width: 18px; height: 18px;">
            <label for="selectAll" style="font-weight: 500; color: #333;">Pilih Semua</label>
            <div style="margin-left: auto; display: flex; gap: 10px;">
              <span id="selectedCount" style="color: #666;">0 data terpilih</span>
              <button class="btn btn-danger btn-small" onclick="deleteSelected()" id="deleteSelectedBtn" disabled>
                üóëÔ∏è Hapus Terpilih
              </button>
            </div>
          </div>
          
          <!-- Table Container dengan Scroll Horizontal -->
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th width="50">Pilih</th>
                  <th data-sort="index">No</th>
                  <th data-sort="namaLengkap">Nama Karyawan</th>
                  <th data-sort="nip">NIP</th>
                  <th data-sort="nomorKTP">No. KTP</th>
                  <th data-sort="wilayahArea">Provinsi</th>
                  <th data-sort="kabupaten">Kabupaten</th>
                  <th data-sort="koordinator">Koordinator</th>
                  <th data-sort="keterangan">Keterangan</th>
                  <th data-sort="whatsapp">WhatsApp</th>
                  <th data-sort="noSurat">No. Surat</th>
                  <th data-sort="tanggalSurat">Tanggal</th>
                  <th data-sort="status">Status</th>
                  <th width="250">Aksi</th>
                </tr>
              </thead>
              <tbody id="dataTableBody">
                <!-- Data akan diisi dari Firebase -->
              </tbody>
            </table>
            
            <!-- Pagination Controls -->
            <div class="pagination-container" id="paginationControls">
              <div class="pagination-info" id="paginationInfo">
                Menampilkan 0-0 dari 0 data
              </div>
              <div class="pagination-controls">
                <button class="pagination-btn" onclick="prevPage()" id="prevBtn" disabled>
                  ‚óÄ Sebelumnya
                </button>
                <div class="page-numbers" id="pageNumbers">
                  <!-- Page numbers will be generated here -->
                </div>
                <button class="pagination-btn" onclick="nextPage()" id="nextBtn" disabled>
                  Berikutnya ‚ñ∂
                </button>
              </div>
              <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <select id="pageSizeSelect" onchange="changePageSize()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                  <option value="10">10 per halaman</option>
                  <option value="20" selected>20 per halaman</option>
                  <option value="50">50 per halaman</option>
                  <option value="100">100 per halaman</option>
                  <option value="0">Semua Data</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="tab-settings" class="tab-content">
        <div style="background: white; border-radius: 15px; padding: 30px;">
          <h3 style="margin-bottom: 25px; color: #333;">‚öôÔ∏è Pengaturan Sistem</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üìß Notifikasi</h4>
              <div class="form-group">
                <label>Email Admin</label>
                <input type="email" id="emailAdmin" class="form-control" placeholder="admin@nextlogistik.com">
              </div>
              <div class="form-group">
                <label>Notifikasi WhatsApp</label>
                <input type="text" id="whatsappAdmin" class="form-control" value="081383796300">
              </div>
              <div class="form-group">
                <label>Auto Refresh (detik)</label>
                <select id="autoRefresh" class="form-control">
                  <option value="30">30 detik</option>
                  <option value="60" selected>60 detik</option>
                  <option value="300">5 menit</option>
                  <option value="600">10 menit</option>
                  <option value="0">Tidak auto refresh</option>
                </select>
              </div>
            </div>
            
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üìÑ Format Surat</h4>
              <div class="form-group">
                <label>Format Nomor Surat</label>
                <input type="text" id="formatNoSurat" class="form-control" value="{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}">
              </div>
              <div class="form-group">
                <label>Format NIP</label>
                <input type="text" id="formatNIP" class="form-control" value="NEXT-{TAHUN}-{BULAN}-{NO}">
              </div>
              <div class="form-group">
                <label>Kota Tanda Tangan</label>
                <input type="text" id="kotaTandaTangan" class="form-control" value="Bekasi">
              </div>
              <div class="form-group">
                <label>Nama Default Penandatangan</label>
                <input type="text" id="defaultPenandatangan" class="form-control" value="M. Fajrian Noor">
              </div>
              <div class="form-group">
                <label>Jabatan Default</label>
                <input type="text" id="defaultJabatan" class="form-control" value="Direktur">
              </div>
            </div>
            
            <div>
              <h4 style="margin-bottom: 15px; color: #555;">üîß Sistem</h4>
              <div class="form-group">
                <label>Max Data per Halaman</label>
                <select id="maxData" class="form-control">
                  <option value="10">10 data</option>
                  <option value="20" selected>20 data</option>
                  <option value="50">50 data</option>
                  <option value="100">100 data</option>
                  <option value="0">Semua Data</option>
                </select>
              </div>
              <div class="form-group">
                <label>Tampilkan Data Lama</label>
                <select id="showOldData" class="form-control">
                  <option value="30">30 hari terakhir</option>
                  <option value="90" selected>3 bulan terakhir</option>
                  <option value="180">6 bulan terakhir</option>
                  <option value="365">1 tahun terakhir</option>
                  <option value="0">Semua data</option>
                </select>
              </div>
              <div class="form-group">
                <label>Max Data per Hari (Import)</label>
                <select id="maxDataPerHari" class="form-control">
                  <option value="0">Tidak Ada Batasan</option>
                  <option value="50">50 data</option>
                  <option value="100">100 data</option>
                  <option value="200">200 data</option>
                  <option value="500">500 data</option>
                </select>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="btn btn-success" onclick="saveSettings()" style="flex: 1;">
              üíæ Simpan Pengaturan
            </button>
            <button class="btn btn-warning" onclick="loadSettings()" style="flex: 1;">
              üîÑ Muat Ulang
            </button>
            <button class="btn btn-danger" onclick="resetSettings()" style="flex: 1;">
              üóëÔ∏è Reset Default
            </button>
          </div>
          
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
            <h4 style="margin-bottom: 15px; color: #555;">üìä Informasi Sistem</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div>
                <small style="color: #888;">Versi Sistem</small>
                <div><strong>v3.0.0</strong></div>
              </div>
              <div>
                <small style="color: #888;">Terakhir Update</small>
                <div><strong id="lastUpdate">-</strong></div>
              </div>
              <div>
                <small style="color: #888;">Ukuran Database</small>
                <div><strong id="dbSize">-</strong></div>
              </div>
              <div>
                <small style="color: #888;">Status Koneksi</small>
                <div><strong id="connectionStatus">-</strong></div>
              </div>
              <div>
                <small style="color: #888;">Total Data</small>
                <div><strong id="totalDataInfo">0</strong></div>
              </div>
              <div>
                <small style="color: #888;">Data Hari Ini</small>
                <div><strong id="todayDataCount">0</strong></div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h5 style="margin-bottom: 10px; color: #555;">üíæ Informasi Storage Firebase</h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div>
                  <small style="color: #888;">Total Storage</small>
                  <div><strong id="firebaseTotalStorage">0 GB</strong></div>
                </div>
                <div>
                  <small style="color: #888;">Storage Terpakai</small>
                  <div><strong id="firebaseUsedStorage">0 GB</strong></div>
                </div>
                <div>
                  <small style="color: #888;">Storage Tersedia</small>
                  <div><strong id="firebaseAvailableStorage">0 GB</strong></div>
                </div>
                <div>
                  <small style="color: #888;">Persentase</small>
                  <div><strong id="firebaseStoragePercent">0%</strong></div>
                </div>
              </div>
              <div style="margin-top: 10px;">
                <div class="storage-progress" style="background: #e0e0e0;">
                  <div class="storage-progress-bar" id="firebaseStorageProgress" style="background: #3498db; width: 0%"></div>
                </div>
                <small style="color: #888; font-size: 12px;" id="firebaseStorageText">0% terpakai</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAEvDR-h0hkgs1xAawra7u3jo9Sc3lCbpo",
    authDomain: "next-packlaring.firebaseapp.com",
    projectId: "next-packlaring",
    storageBucket: "next-packlaring.firebasestorage.app",
    messagingSenderId: "400584486436",
    appId: "1:400584486436:web:99067d2c6dc6d87ef7b2b1",
    measurementId: "G-KRFXBYN663"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const analytics = firebase.analytics();

  // Global Variables
  let allData = [];
  let filteredData = [];
  let selectedDocId = null;
  let selectedData = null;
  let statsChart = null;
  let autoRefreshInterval = null;
  
  // Pagination Variables
  let currentPage = 1;
  let itemsPerPage = 20;
  let totalPages = 1;
  
  // Sorting Variables
  let currentSortColumn = 'createdAt';
  let currentSortDirection = 'desc';
  
  // Settings
  let settings = {
    emailAdmin: "admin@nextlogistik.com",
    whatsappAdmin: "081383796300",
    autoRefresh: 60,
    formatNoSurat: "{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}",
    formatNIP: "NEXT-{TAHUN}-{BULAN}-{NO}",
    kotaTandaTangan: "Bekasi",
    defaultPenandatangan: "M. Fajrian Noor",
    defaultJabatan: "Direktur",
    maxData: 20,
    showOldData: 90,
    maxDataPerHari: "0"
  };

  // Variables for multi-select
  let selectedIds = new Set();
  let deleteDataToDelete = null;
  
  // Variables for share modal
  let shareData = null;
  
  // Variable untuk menyimpan data asli sebelum diedit
  let originalDataBeforeEdit = null;
  
  // Variable untuk import Excel
  let importExcelFile = null;
  let importExcelData = [];
  let importPreviewTable = null;

  // ==================== FUNGSI UTAMA YANG DIPERBAIKI ====================

  // Fungsi untuk format nomor WhatsApp agar kompatibel
  function formatWhatsAppNumber(phone) {
    if (!phone) return '628138796300'; // Default admin number
    
    // Hilangkan semua karakter non-digit
    let cleanNumber = phone.replace(/\D/g, '');
    
    // Jika nomor kosong, return default
    if (cleanNumber.length === 0) return '628138796300';
    
    // Jika nomor dimulai dengan 0, ganti dengan 62
    if (cleanNumber.startsWith('0')) {
      cleanNumber = '62' + cleanNumber.substring(1);
    }
    
    // Jika nomor dimulai dengan 8 (tanpa 0), tambahkan 62
    else if (cleanNumber.startsWith('8')) {
      cleanNumber = '62' + cleanNumber;
    }
    
    // Jika sudah dimulai dengan 62, biarkan saja
    // Periksa apakah nomor sudah memiliki kode negara
    else if (!cleanNumber.startsWith('62') && cleanNumber.length >= 10) {
      // Anggap sebagai nomor Indonesia dan tambahkan 62
      cleanNumber = '62' + cleanNumber;
    }
    
    // Pastikan panjang minimal 10 digit
    if (cleanNumber.length < 10) {
      return '628138796300'; // Fallback to admin
    }
    
    return cleanNumber;
  }

  // Fungsi untuk memuat semua data dari Firebase
  async function loadAllData() {
    showLoading(true);
    showNotification('Memuat semua data... Harap tunggu', 'info');
    
    try {
      // Dapatkan semua data tanpa limit
      const snapshot = await db.collection('packlaring')
        .orderBy('createdAt', 'desc')
        .get();
      
      allData = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        data.id = doc.id;
        
        // Convert Firestore timestamps to Date objects
        if (data.createdAt && data.createdAt.toDate) {
          data.createdAt = data.createdAt.toDate();
        }
        if (data.updatedAt && data.updatedAt.toDate) {
          data.updatedAt = data.updatedAt.toDate();
        }
        if (data.downloadedAt && data.downloadedAt.toDate) {
          data.downloadedAt = data.downloadedAt.toDate();
        }
        if (data.lastDownloadedAt && data.lastDownloadedAt.toDate) {
          data.lastDownloadedAt = data.lastDownloadedAt.toDate();
        }
        
        allData.push(data);
      });
      
      // Apply sorting
      sortData();
      
      filteredData = [...allData];
      renderDataTable();
      updateStats();
      updateRecentList();
      updateDashboard();
      updateSystemInfo();
      updateFirebaseStorageInfo();
      
      const connectionStatus = document.getElementById('connectionStatus');
      if (connectionStatus) connectionStatus.textContent = '‚úÖ Terhubung';
      
      const lastUpdate = document.getElementById('lastUpdate');
      if (lastUpdate) lastUpdate.textContent = new Date().toLocaleTimeString('id-ID');
      
      showNotification(`Berhasil memuat ${allData.length} data`, 'success');
      
    } catch (error) {
      console.error('Error loading all data:', error);
      showNotification('Gagal memuat data: ' + error.message, 'error');
      const connectionStatus = document.getElementById('connectionStatus');
      if (connectionStatus) connectionStatus.textContent = '‚ùå Gagal';
    } finally {
      showLoading(false);
    }
  }

  // PERBAIKAN: Fungsi generateLink yang benar dengan link ke download-letter.html
  function generateLink(docId) {
    const data = allData.find(d => d.id === docId);
    if (!data) {
      showNotification('Data tidak ditemukan', 'error');
      return;
    }
    
    shareData = data;
    
    // Update modal content
    document.getElementById('shareNama').textContent = data.namaLengkap || '-';
    document.getElementById('shareNIP').textContent = data.nip || '-';
    document.getElementById('shareKTP').textContent = formatNomorKTPDisplay(data.nomorKTP || '-');
    document.getElementById('shareStatus').textContent = getStatusText(data.status);
    
    // Generate download link yang benar ke download-letter.html
    const currentUrl = window.location.href;
    let baseUrl = currentUrl;
    
    // Jika kita di admin.html, ubah ke download-letter.html
    if (currentUrl.includes('admin.html')) {
      baseUrl = currentUrl.replace('admin.html', 'download-letter.html');
    } else {
      // Jika tidak, buat URL dasar
      const url = new URL(currentUrl);
      url.pathname = url.pathname.replace(/\/[^\/]*$/, '/download-letter.html');
      baseUrl = url.toString();
    }
    
    // Tambahkan parameter
    const downloadUrl = `${baseUrl.split('?')[0]}?id=${docId}&ktp=${encodeURIComponent(data.nomorKTP || '')}`;
    
    // Update link input
    const linkInput = document.getElementById('shareLinkInput');
    linkInput.value = downloadUrl;
    
    // Format nomor WhatsApp user
    const userWhatsApp = data.whatsapp || '';
    const formattedUserPhone = formatWhatsAppNumber(userWhatsApp);
    
    // Update WhatsApp share button untuk user dengan pesan yang benar
    const whatsappBtn = document.getElementById('whatsappShareBtn');
    const message = `Halo ${data.namaLengkap || 'Karyawan'},

üìã *SURAT PACKLARING SUDAH SIAP*

Surat keterangan kerja Anda sudah siap untuk didownload.

üîó *Link Download:*
${downloadUrl}

üìù *Informasi:*
‚Ä¢ Nama: ${data.namaLengkap || '-'}
‚Ä¢ NIP: ${data.nip || '-'}
‚Ä¢ No. Surat: ${data.noSurat || '-'}

üìã *Cara Download:*
1. Buka link di atas
2. Masukkan nomor KTP: *${data.nomorKTP || '-'}*
3. Download surat dalam format PDF

‚è±Ô∏è *Masa Aktif Link:* 30 hari
üìû *Bantuan:* 081383796300

Terima kasih,
Admin NEXT Cargo Logistics`;

    const encodedMessage = encodeURIComponent(message);
    whatsappBtn.href = `https://wa.me/${formattedUserPhone}?text=${encodedMessage}`;
    
    // Set title untuk tombol
    whatsappBtn.title = `Kirim ke ${userWhatsApp || 'User'}`;
    
    // Show modal
    const shareModal = document.getElementById('shareModal');
    if (shareModal) shareModal.classList.add('active');
  }

  // Fungsi untuk mengirim link ke admin WhatsApp
  function sendToAdminWhatsApp() {
    if (!shareData) return;
    
    // Dapatkan link yang sama seperti di atas
    const currentUrl = window.location.href;
    let baseUrl = currentUrl;
    
    if (currentUrl.includes('admin.html')) {
      baseUrl = currentUrl.replace('admin.html', 'download-letter.html');
    } else {
      const url = new URL(currentUrl);
      url.pathname = url.pathname.replace(/\/[^\/]*$/, '/download-letter.html');
      baseUrl = url.toString();
    }
    
    const downloadUrl = `${baseUrl.split('?')[0]}?id=${shareData.id}&ktp=${encodeURIComponent(shareData.nomorKTP || '')}`;
    
    const message = `üìã *LINK PACKLARING UNTUK USER*

üîó *Link Download:*
${downloadUrl}

üìù *Data User:*
‚Ä¢ Nama: ${shareData.namaLengkap || '-'}
‚Ä¢ NIP: ${shareData.nip || '-'}
‚Ä¢ No. KTP: ${shareData.nomorKTP || '-'}
‚Ä¢ WhatsApp: ${shareData.whatsapp || '-'}
‚Ä¢ Status: ${getStatusText(shareData.status)}

‚è±Ô∏è *Dibuat:* ${new Date().toLocaleString('id-ID')}
üìä *Total Download:* ${shareData.downloadCount || 0}x

*Note:* Link ini untuk user ${shareData.namaLengkap || 'tersebut'}`;

    const encodedMessage = encodeURIComponent(message);
    const adminNumber = '628138796300'; // Admin number
    
    window.open(`https://wa.me/${adminNumber}?text=${encodedMessage}`, '_blank');
    showNotification('Link dibuka di WhatsApp Admin', 'success');
  }

  // Fungsi untuk mengubah ukuran halaman
  function changePageSize() {
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    if (!pageSizeSelect) return;
    
    const newSize = parseInt(pageSizeSelect.value);
    if (newSize === 0) {
      // Tampilkan semua data
      itemsPerPage = filteredData.length;
    } else {
      itemsPerPage = newSize;
    }
    
    currentPage = 1;
    renderDataTable();
    
    if (newSize === 0) {
      showNotification(`Menampilkan semua ${filteredData.length} data`, 'info');
    } else {
      showNotification(`Diubah ke ${itemsPerPage} data per halaman`, 'success');
    }
  }

  // Fungsi untuk muat semua data dengan pagination khusus
  function loadAllDataWithPagination() {
    // Set items per page ke jumlah total data
    itemsPerPage = filteredData.length;
    currentPage = 1;
    
    // Update select box
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    if (pageSizeSelect) {
      pageSizeSelect.value = "0";
    }
    
    renderDataTable();
    showNotification(`Menampilkan semua ${filteredData.length} data`, 'success');
  }

  // ==================== FUNGSI IMPORT/EXPORT EXCEL ====================

  // Show Import/Export Modal
  function showImportExportModal() {
    const importExportModal = document.getElementById('importExportModal');
    if (importExportModal) importExportModal.classList.add('active');
  }

  // Close Import/Export Modal
  function closeImportExportModal() {
    const importExportModal = document.getElementById('importExportModal');
    if (importExportModal) importExportModal.classList.remove('active');
    clearSelectedFile();
  }

  // Handle file select for import
  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validasi file
    const validTypes = ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/csv'];
    const fileExtension = file.name.split('.').pop().toLowerCase();
    
    if (!validTypes.includes(file.type) && !['xlsx', 'xls', 'csv'].includes(fileExtension)) {
      showNotification('Format file tidak didukung. Gunakan file Excel (.xlsx, .xls) atau CSV.', 'error');
      return;
    }
    
    if (file.size > 10 * 1024 * 1024) { // 10MB
      showNotification('Ukuran file terlalu besar. Maksimal 10MB.', 'error');
      return;
    }
    
    importExcelFile = file;
    
    // Update file info display
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatBytes(file.size);
    
    // Show file preview section
    document.getElementById('filePreview').style.display = 'block';
    
    // Preview the data
    previewImportData();
  }

  // Preview import data
  function previewImportData() {
    if (!importExcelFile) return;
    
    showLoading(true);
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: 'binary' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        
        importExcelData = jsonData;
        
        // Update row count
        document.getElementById('fileRowCount').textContent = `${jsonData.length} baris data ditemukan`;
        
        // Show preview table
        showImportPreview(jsonData.slice(0, 10)); // Show first 10 rows
        
        showNotification(`Berhasil membaca ${jsonData.length} baris data`, 'success');
        
      } catch (error) {
        console.error('Error reading Excel file:', error);
        showNotification('Gagal membaca file Excel: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    };
    
    reader.onerror = function() {
      showNotification('Gagal membaca file', 'error');
      showLoading(false);
    };
    
    reader.readAsBinaryString(importExcelFile);
  }

  // Show import preview
  function showImportPreview(data) {
    const previewContainer = document.getElementById('importPreview');
    const previewTable = document.getElementById('importPreviewTable');
    
    if (data.length === 0) {
      previewTable.innerHTML = '<p>Tidak ada data yang dapat dipreview</p>';
      return;
    }
    
    // Get column headers
    const headers = Object.keys(data[0]);
    
    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
    
    // Table header
    html += '<thead><tr style="background: #f8f9fa;">';
    html += '<th style="padding: 8px; border: 1px solid #ddd;">#</th>';
    headers.forEach(header => {
      html += `<th style="padding: 8px; border: 1px solid #ddd;">${header}</th>`;
    });
    html += '</tr></thead>';
    
    // Table body
    html += '<tbody>';
    data.forEach((row, index) => {
      html += `<tr style="${index % 2 === 0 ? 'background: white;' : 'background: #f9f9f9;'}">`;
      html += `<td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>`;
      headers.forEach(header => {
        const value = row[header] !== undefined ? row[header] : '';
        html += `<td style="padding: 8px; border: 1px solid #ddd; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${value}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    
    previewTable.innerHTML = html;
    previewContainer.style.display = 'block';
  }

  // Import Excel data to Firebase
  async function importExcelData() {
    if (!importExcelData || importExcelData.length === 0) {
      showNotification('Tidak ada data untuk diimport', 'warning');
      return;
    }
    
    if (!confirm(`Apakah Anda yakin ingin mengimport ${importExcelData.length} data? Data yang sudah ada akan diupdate.`)) {
      return;
    }
    
    showLoading(true);
    
    try {
      let successCount = 0;
      let updateCount = 0;
      let errorCount = 0;
      let duplicateCount = 0;
      
      // Process each row
      for (let i = 0; i < importExcelData.length; i++) {
        const row = importExcelData[i];
        
        try {
          // Validate required fields
          if (!row['NIP'] || !row['Nama Karyawan'] || !row['Nomor KTP']) {
            console.warn(`Baris ${i + 1}: Data tidak lengkap, dilewati`);
            errorCount++;
            continue;
          }
          
          // Check for duplicates by NIP
          const existingDoc = allData.find(d => d.nip === row['NIP'].toString().trim());
          
          // Prepare data
          const dataToSave = {
            namaLengkap: row['Nama Karyawan'] || '',
            nip: row['NIP'].toString().trim(),
            nomorKTP: row['Nomor KTP'].toString().trim(),
            tempatLahir: row['Tempat Lahir'] || '',
            tanggalLahir: row['Tanggal Lahir'] ? parseDate(row['Tanggal Lahir']) : null,
            jabatan: row['Jabatan'] || '',
            deptKaryawan: row['Departemen'] || '',
            tanggalMulai: row['Tanggal Mulai'] ? parseDate(row['Tanggal Mulai']) : new Date(),
            tanggalBerakhir: row['Tanggal Berakhir'] ? parseDate(row['Tanggal Berakhir']) : new Date(),
            alasanBerhenti: row['Alasan Berhenti'] || 'KONTRAK BERAKHIR',
            noSurat: row['No Surat'] || '',
            tanggalSurat: row['Tanggal Surat'] ? parseDate(row['Tanggal Surat']) : new Date(),
            tujuanSurat: row['Tujuan Surat'] || '',
            whatsapp: row['WhatsApp'] || '',
            email: row['Email'] || '',
            wilayahArea: row['Provinsi/Wilayah'] || '',
            kabupaten: row['Kabupaten'] || '',
            koordinator: row['Koordinator'] || '',
            namaPenandatangan: row['Penandatangan'] || settings.defaultPenandatangan,
            jabatanPenandatangan: row['Jabatan Penandatangan'] || settings.defaultJabatan,
            kotaPenandatangan: row['Kota Penandatangan'] || settings.kotaTandaTangan,
            keterangan: row['Keterangan'] || '',
            status: mapStatus(row['Status']) || 'pending',
            updatedAt: new Date(),
            updatedBy: 'Import Excel'
          };
          
          // Add created date for new records
          if (!existingDoc) {
            dataToSave.createdAt = new Date();
            dataToSave.downloadCount = 0;
          }
          
          // Check for duplicate NIP with other records
          const duplicateNIP = allData.find(d => 
            d.nip === dataToSave.nip && 
            (!existingDoc || d.id !== existingDoc.id)
          );
          
          if (duplicateNIP && !existingDoc) {
            console.warn(`NIP ${dataToSave.nip} sudah digunakan, dilewati`);
            duplicateCount++;
            continue;
          }
          
          // Save to Firebase
          if (existingDoc) {
            // Update existing document
            await db.collection('packlaring').doc(existingDoc.id).update(dataToSave);
            updateCount++;
          } else {
            // Add new document
            await db.collection('packlaring').add(dataToSave);
            successCount++;
          }
          
        } catch (error) {
          console.error(`Error processing row ${i + 1}:`, error);
          errorCount++;
        }
      }
      
      // Show results
      const message = `Import selesai: ${successCount} data baru, ${updateCount} data diupdate, ${duplicateCount} duplikat dilewati, ${errorCount} error`;
      showNotification(message, 'success');
      
      // Reload data
      loadData();
      closeImportExportModal();
      
    } catch (error) {
      console.error('Error importing data:', error);
      showNotification('Gagal import data: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Helper function to parse date from various formats
  function parseDate(dateValue) {
    if (!dateValue) return null;
    
    // If it's already a Date object
    if (dateValue instanceof Date) {
      return dateValue;
    }
    
    // If it's a string
    if (typeof dateValue === 'string') {
      // Try different date formats
      const formats = [
        // ISO format
        () => new Date(dateValue),
        // DD/MM/YYYY
        () => {
          const parts = dateValue.split('/');
          if (parts.length === 3) {
            return new Date(parts[2], parts[1] - 1, parts[0]);
          }
          return null;
        },
        // MM/DD/YYYY
        () => {
          const parts = dateValue.split('/');
          if (parts.length === 3) {
            return new Date(parts[2], parts[0] - 1, parts[1]);
          }
          return null;
        },
        // YYYY-MM-DD
        () => {
          const parts = dateValue.split('-');
          if (parts.length === 3) {
            return new Date(parts[0], parts[1] - 1, parts[2]);
          }
          return null;
        }
      ];
      
      for (const format of formats) {
        try {
          const date = format();
          if (date && !isNaN(date.getTime())) {
            return date;
          }
        } catch (e) {
          // Continue to next format
        }
      }
    }
    
    // If it's a number (Excel serial date)
    if (typeof dateValue === 'number') {
      // Excel serial date starts from Jan 1, 1900
      const excelEpoch = new Date(1899, 11, 30);
      return new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
    }
    
    // Return current date as fallback
    return new Date();
  }

  // Map status from Excel to Firebase
  function mapStatus(status) {
    if (!status) return 'pending';
    
    const statusStr = status.toString().toLowerCase();
    if (statusStr.includes('selesai') || statusStr.includes('completed')) return 'completed';
    if (statusStr.includes('proses') || statusStr.includes('processed')) return 'processed';
    return 'pending';
  }

  // Export Excel with Links
  function exportExcelWithLinks() {
    // Prepare data with download links
    const exportData = filteredData.map(data => {
      const isTeknisi = data.jabatan && (
        data.jabatan.toLowerCase().includes('teknisi') || 
        data.jabatan.toLowerCase().includes('koordinator') ||
        data.jabatan.toLowerCase().includes('supervisor')
      );
      
      // Generate download link
      const currentUrl = window.location.href;
      let baseUrl = currentUrl;
      
      if (currentUrl.includes('admin.html')) {
        baseUrl = currentUrl.replace('admin.html', 'download-letter.html');
      } else {
        const url = new URL(currentUrl);
        url.pathname = url.pathname.replace(/\/[^\/]*$/, '/download-letter.html');
        baseUrl = url.toString();
      }
      
      const downloadUrl = `${baseUrl.split('?')[0]}?id=${data.id}&ktp=${encodeURIComponent(data.nomorKTP || '')}`;
      
      return {
        'ID Database': data.id || '',
        'No Surat': data.noSurat || '',
        'Nama Karyawan': data.namaLengkap || '',
        'NIP': data.nip || '',
        'Nomor KTP': data.nomorKTP || '',
        'Provinsi/Wilayah': isTeknisi ? (data.wilayahArea || '') : '',
        'Kabupaten': isTeknisi ? (data.kabupaten || '') : '',
        'Koordinator': isTeknisi ? (data.koordinator || '') : '',
        'Keterangan': data.keterangan || '',
        'WhatsApp': data.whatsapp || '',
        'Jabatan': data.jabatan || '',
        'Departemen': data.deptKaryawan || '',
        'Tempat Lahir': data.tempatLahir || '',
        'Tanggal Lahir': formatShortDate(data.tanggalLahir),
        'Tanggal Mulai': formatShortDate(data.tanggalMulai),
        'Tanggal Berakhir': formatShortDate(data.tanggalBerakhir),
        'Alasan Berhenti': data.alasanBerhenti || '',
        'Status': getStatusText(data.status),
        'Tanggal Surat': formatShortDate(data.tanggalSurat),
        'Tujuan Surat': data.tujuanSurat || '',
        'Email': data.email || '',
        'Penandatangan': data.namaPenandatangan || '',
        'Jabatan Penandatangan': data.jabatanPenandatangan || '',
        'Kota Penandatangan': data.kotaPenandatangan || '',
        'Tanggal Input': formatShortDate(data.createdAt),
        'Terakhir Update': formatShortDate(data.updatedAt || data.createdAt),
        'Total Download': data.downloadCount || 0,
        'Terakhir Download': data.lastDownloadedAt ? formatShortDate(data.lastDownloadedAt) : '',
        'Download oleh': data.lastDownloadedBy || '',
        'Link Download': downloadUrl,
        'Catatan Admin': data.catatanAdmin || ''
      };
    });
    
    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(exportData);
    
    // Set column widths
    const wscols = [
      {wch: 25}, {wch: 20}, {wch: 25}, {wch: 15}, {wch: 20},
      {wch: 20}, {wch: 15}, {wch: 15}, {wch: 25}, {wch: 15},
      {wch: 20}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15},
      {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 25},
      {wch: 25}, {wch: 15}, {wch: 15}, {wch: 10}, {wch: 15},
      {wch: 15}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 50},
      {wch: 30}
    ];
    ws['!cols'] = wscols;
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data Packlaring");
    
    // Generate filename
    const fileName = `Data_Packlaring_${new Date().toISOString().slice(0,10)}.xlsx`;
    
    // Save file
    XLSX.writeFile(wb, fileName);
    
    showNotification(`Data berhasil diexport ke Excel dengan ${exportData.length} baris!`, 'success');
  }

  // Download Template
  function downloadTemplate() {
    // Create sample data for template
    const templateData = [{
      'Nama Karyawan': 'CONTOH: John Doe',
      'NIP': 'CONTOH: NEXT-2024-01-001',
      'Nomor KTP': 'CONTOH: 1234567890123456',
      'Provinsi/Wilayah': 'CONTOH: Jawa Barat',
      'Kabupaten': 'CONTOH: Bandung',
      'Koordinator': 'CONTOH: Budi Santoso',
      'Keterangan': 'CONTOH: Karyawan kontrak',
      'WhatsApp': 'CONTOH: 081234567890',
      'Jabatan': 'CONTOH: TEKNISI',
      'Departemen': 'CONTOH: Teknik',
      'Tempat Lahir': 'CONTOH: Jakarta',
      'Tanggal Lahir': '01/01/1990',
      'Tanggal Mulai': '01/01/2024',
      'Tanggal Berakhir': '31/12/2024',
      'Alasan Berhenti': 'KONTRAK BERAKHIR',
      'Status': 'pending',
      'No Surat': 'CONTOH: 001/SK-HRD/NEXT/I/24',
      'Tanggal Surat': '01/01/2024',
      'Tujuan Surat': 'CONTOH: Untuk keperluan administrasi',
      'Email': 'CONTOH: john.doe@email.com',
      'Penandatangan': 'M. Fajrian Noor',
      'Jabatan Penandatangan': 'Direktur',
      'Kota Penandatangan': 'Bekasi'
    }];
    
    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(templateData);
    
    // Set column widths
    const wscols = [
      {wch: 20}, {wch: 20}, {wch: 20}, {wch: 15}, {wch: 15},
      {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 15},
      {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 20},
      {wch: 15}, {wch: 25}, {wch: 15}, {wch: 30}, {wch: 25},
      {wch: 20}, {wch: 20}, {wch: 15}
    ];
    ws['!cols'] = wscols;
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    
    // Add instructions sheet
    const instructions = [
      ['INSTRUKSI PENGGUNAAN TEMPLATE'],
      [''],
      ['1. Isi data sesuai kolom yang tersedia'],
      ['2. Kolom wajib diisi: Nama Karyawan, NIP, Nomor KTP, Jabatan, Tanggal Mulai, Tanggal Berakhir, No Surat, Tanggal Surat, WhatsApp'],
      ['3. Format tanggal: DD/MM/YYYY atau YYYY-MM-DD'],
      ['4. Status: pending, processed, atau completed'],
      ['5. Alasan Berhenti: KONTRAK BERAKHIR, PENGUNDURAN DIRI, PHK, PENSIUN, MENINGGAL DUNIA'],
      ['6. Jabatan: TEKNISI, STAFF ADMIN PUSAT, STAFF ADMIN WILAYAH, SPV AREA, KORDINATOR WILAYAH, CUSTOMER SERVICE, STAFF MONITORING, MANAGER AREA'],
      ['7. Untuk kolom LINK DOWNLOAD, biarkan kosong - akan otomatis di-generate'],
      [''],
      ['CATATAN:'],
      ['- Data dengan NIP yang sama akan diupdate'],
      ['- Data baru akan ditambahkan'],
      ['- File dapat diimport kembali setelah diedit']
    ];
    
    const ws2 = XLSX.utils.aoa_to_sheet(instructions);
    XLSX.utils.book_append_sheet(wb, ws2, "Instruksi");
    
    // Save file
    XLSX.writeFile(wb, 'Template_Import_Packlaring.xlsx');
    
    showNotification('Template berhasil didownload!', 'success');
  }

  // Clear selected file
  function clearSelectedFile() {
    importExcelFile = null;
    importExcelData = [];
    document.getElementById('fileInput').value = '';
    document.getElementById('filePreview').style.display = 'none';
    document.getElementById('importPreview').style.display = 'none';
  }

  // Drag and drop for file upload
  function setupDragAndDrop() {
    const dropArea = document.getElementById('fileUploadArea');
    
    if (!dropArea) return;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
      dropArea.classList.add('drag-over');
    }
    
    function unhighlight() {
      dropArea.classList.remove('drag-over');
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        const file = files[0];
        
        // Create a fake event object
        const event = {
          target: {
            files: [file]
          }
        };
        
        handleFileSelect(event);
      }
    }
  }

  // ==================== FUNGSI TAMBAH DATA BARU ====================

  // Show Add Modal
  function showAddModal() {
    // Reset form
    document.getElementById('addForm').reset();
    
    // Set default values
    document.getElementById('addNamaPenandatangan').value = settings.defaultPenandatangan;
    document.getElementById('addJabatanPenandatangan').value = settings.defaultJabatan;
    document.getElementById('addKotaPenandatangan').value = settings.kotaTandaTangan;
    
    // Set today's date for tanggalSurat
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('addTanggalSurat').value = today;
    
    // Hide lokasi fields initially
    document.getElementById('addLokasiTeknisiFields').classList.remove('active');
    
    // Show modal
    const addModal = document.getElementById('addModal');
    if (addModal) addModal.classList.add('active');
  }

  // Close Add Modal
  function closeAddModal() {
    const addModal = document.getElementById('addModal');
    if (addModal) addModal.classList.remove('active');
  }

  // Toggle lokasi fields for add form
  function toggleAddLokasiFields() {
    const jabatan = document.getElementById('addJabatan').value;
    const lokasiFields = document.getElementById('addLokasiTeknisiFields');
    
    const isTeknisi = jabatan && (
      jabatan.toLowerCase().includes('teknisi') || 
      jabatan.toLowerCase().includes('koordinator') ||
      jabatan.toLowerCase().includes('supervisor')
    );
    
    if (isTeknisi) {
      lokasiFields.classList.add('active');
    } else {
      lokasiFields.classList.remove('active');
    }
  }

  // Save new data
  async function saveNewData() {
    showLoading(true);
    
    try {
      // Ambil nilai dari form
      const formData = {
        namaLengkap: document.getElementById('addNamaLengkap').value,
        nip: document.getElementById('addNIP').value,
        nomorKTP: document.getElementById('addNomorKTP').value,
        tempatLahir: document.getElementById('addTempatLahir').value,
        jabatan: document.getElementById('addJabatan').value,
        deptKaryawan: document.getElementById('addDeptKaryawan').value,
        alasanBerhenti: document.getElementById('addAlasanBerhenti').value,
        noSurat: document.getElementById('addNoSurat').value,
        tujuanSurat: document.getElementById('addTujuanSurat').value,
        whatsapp: document.getElementById('addWhatsapp').value,
        email: document.getElementById('addEmail').value,
        namaPenandatangan: document.getElementById('addNamaPenandatangan').value,
        jabatanPenandatangan: document.getElementById('addJabatanPenandatangan').value,
        kotaPenandatangan: document.getElementById('addKotaPenandatangan').value,
        keterangan: document.getElementById('addKeterangan').value,
        status: document.getElementById('addStatus').value,
        createdAt: new Date(),
        updatedAt: new Date(),
        createdBy: 'Admin Panel',
        downloadCount: 0
      };
      
      // Handle semua field tanggal
      const tanggalLahirInput = document.getElementById('addTanggalLahir').value;
      if (tanggalLahirInput) {
        formData.tanggalLahir = new Date(tanggalLahirInput);
      }
      
      const tanggalMulaiInput = document.getElementById('addTanggalMulai').value;
      if (tanggalMulaiInput) {
        formData.tanggalMulai = new Date(tanggalMulaiInput);
      } else {
        throw new Error('Tanggal Mulai wajib diisi');
      }
      
      const tanggalBerakhirInput = document.getElementById('addTanggalBerakhir').value;
      if (tanggalBerakhirInput) {
        formData.tanggalBerakhir = new Date(tanggalBerakhirInput);
      } else {
        throw new Error('Tanggal Berakhir wajib diisi');
      }
      
      const tanggalSuratInput = document.getElementById('addTanggalSurat').value;
      if (tanggalSuratInput) {
        formData.tanggalSurat = new Date(tanggalSuratInput);
      } else {
        throw new Error('Tanggal Surat wajib diisi');
      }
      
      // Cek apakah jabatan teknisi
      const isTeknisi = formData.jabatan && (
        formData.jabatan.toLowerCase().includes('teknisi') || 
        formData.jabatan.toLowerCase().includes('koordinator') ||
        formData.jabatan.toLowerCase().includes('supervisor')
      );
      
      if (isTeknisi) {
        formData.wilayahArea = document.getElementById('addWilayah').value || '';
        formData.kabupaten = document.getElementById('addKabupaten').value || '';
        formData.koordinator = document.getElementById('addKoordinator').value || '';
      }
      
      // Validasi data wajib
      if (!formData.namaLengkap || !formData.nip || !formData.nomorKTP) {
        throw new Error('Nama, NIP, dan Nomor KTP wajib diisi');
      }
      
      if (!formData.jabatan || !formData.tanggalMulai || !formData.tanggalBerakhir) {
        throw new Error('Jabatan dan tanggal kerja wajib diisi');
      }
      
      if (!formData.noSurat || !formData.tanggalSurat) {
        throw new Error('Nomor surat dan tanggal surat wajib diisi');
      }
      
      // Check for duplicate NIP
      const duplicateNIP = allData.find(d => d.nip === formData.nip);
      if (duplicateNIP) {
        throw new Error(`NIP ${formData.nip} sudah digunakan oleh ${duplicateNIP.namaLengkap}`);
      }
      
      // Check for duplicate No KTP
      const duplicateKTP = allData.find(d => d.nomorKTP === formData.nomorKTP);
      if (duplicateKTP) {
        throw new Error(`Nomor KTP ${formData.nomorKTP} sudah digunakan oleh ${duplicateKTP.namaLengkap}`);
      }
      
      // Check for duplicate No Surat
      const duplicateNoSurat = allData.find(d => d.noSurat === formData.noSurat);
      if (duplicateNoSurat) {
        throw new Error(`Nomor Surat ${formData.noSurat} sudah digunakan oleh ${duplicateNoSurat.namaLengkap}`);
      }
      
      // Save to Firebase
      await db.collection('packlaring').add(formData);
      
      closeAddModal();
      loadData();
      
      showNotification('Data baru berhasil disimpan!', 'success');
      
    } catch (error) {
      console.error('Error saving new data:', error);
      showNotification('Gagal menyimpan data: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // ==================== FUNGSI YANG TIDAK BERUBAH ====================

  // Format tanggal Indonesia
  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return date.toLocaleDateString('id-ID', options);
  }

  function formatShortDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // Format nomor KTP untuk display
  function formatNomorKTPDisplay(ktp) {
    if (!ktp || ktp === '-') return '-';
    const cleanKTP = ktp.replace(/\D/g, '');
    if (cleanKTP.length !== 16) return ktp;
    
    let formatted = '';
    for (let i = 0; i < cleanKTP.length; i++) {
      if (i > 0 && i % 4 === 0) {
        formatted += '-';
      }
      formatted += cleanKTP[i];
    }
    return formatted;
  }

  // Format WhatsApp untuk display
  function formatWhatsAppDisplay(wa) {
    if (!wa || wa === '-') return '-';
    const cleanWA = wa.replace(/\D/g, '');
    if (cleanWA.length < 10) return wa;
    
    if (cleanWA.startsWith('62')) {
      return `+62 ${cleanWA.substring(2, 5)}-${cleanWA.substring(5, 9)}-${cleanWA.substring(9)}`;
    } else if (cleanWA.startsWith('0')) {
      return `0${cleanWA.substring(1, 5)}-${cleanWA.substring(5, 9)}-${cleanWA.substring(9)}`;
    }
    return wa;
  }

  // Tab Navigation
  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Load data if needed
    if (tabName === 'dashboard') {
      setTimeout(() => {
        updateDashboard();
        updateChart();
      }, 100);
    } else if (tabName === 'data') {
      renderDataTable();
    } else if (tabName === 'settings') {
      loadSettings();
      updateFirebaseStorageInfo();
    }
  }

  // Show Loading
  function showLoading(show) {
    const loadingElement = document.getElementById('loading');
    if (loadingElement) {
      loadingElement.classList.toggle('active', show);
    }
  }

  // Show Notification
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    const icon = notification.querySelector('.notification-icon');
    const content = notification.querySelector('.notification-content');
    const title = content.querySelector('h4');
    const text = content.querySelector('p');
    
    // Set icon based on type
    if (type === 'success') {
      icon.textContent = '‚úÖ';
      title.textContent = 'Berhasil';
    } else if (type === 'error') {
      icon.textContent = '‚ùå';
      title.textContent = 'Error';
    } else if (type === 'warning') {
      icon.textContent = '‚ö†Ô∏è';
      title.textContent = 'Peringatan';
    } else if (type === 'info') {
      icon.textContent = '‚ÑπÔ∏è';
      title.textContent = 'Informasi';
    }
    
    text.textContent = message;
    notification.className = `notification ${type} show`;
    
    // Auto hide after 5 seconds
    setTimeout(() => {
      notification.classList.remove('show');
    }, 5000);
  }

  function hideNotification() {
    const notification = document.getElementById('notification');
    if (notification) {
      notification.classList.remove('show');
    }
  }

  // Load Data from Firebase
  async function loadData() {
    showLoading(true);
    
    try {
      const snapshot = await db.collection('packlaring')
        .orderBy('createdAt', 'desc')
        .limit(1000)
        .get();
      
      allData = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        data.id = doc.id;
        
        // Convert Firestore timestamps to Date objects
        if (data.createdAt && data.createdAt.toDate) {
          data.createdAt = data.createdAt.toDate();
        }
        if (data.updatedAt && data.updatedAt.toDate) {
          data.updatedAt = data.updatedAt.toDate();
        }
        if (data.downloadedAt && data.downloadedAt.toDate) {
          data.downloadedAt = data.downloadedAt.toDate();
        }
        if (data.lastDownloadedAt && data.lastDownloadedAt.toDate) {
          data.lastDownloadedAt = data.lastDownloadedAt.toDate();
        }
        
        allData.push(data);
      });
      
      // Apply sorting
      sortData();
      
      filteredData = [...allData];
      renderDataTable();
      updateStats();
      updateRecentList();
      
      setTimeout(() => {
        updateDashboard();
        updateSystemInfo();
        updateFirebaseStorageInfo();
      }, 100);
      
      const connectionStatus = document.getElementById('connectionStatus');
      if (connectionStatus) connectionStatus.textContent = '‚úÖ Terhubung';
      
      const lastUpdate = document.getElementById('lastUpdate');
      if (lastUpdate) lastUpdate.textContent = new Date().toLocaleTimeString('id-ID');
      
    } catch (error) {
      console.error('Error loading data:', error);
      showNotification('Gagal memuat data: ' + error.message, 'error');
      const connectionStatus = document.getElementById('connectionStatus');
      if (connectionStatus) connectionStatus.textContent = '‚ùå Gagal';
    } finally {
      showLoading(false);
    }
  }

  // Sort Data
  function sortData() {
    allData.sort((a, b) => {
      let aValue, bValue;
      
      switch(currentSortColumn) {
        case 'namaLengkap':
          aValue = (a.namaLengkap || '').toLowerCase();
          bValue = (b.namaLengkap || '').toLowerCase();
          break;
        case 'nip':
          aValue = a.nip || '';
          bValue = b.nip || '';
          break;
        case 'noSurat':
          aValue = a.noSurat || '';
          bValue = b.noSurat || '';
          break;
        case 'wilayahArea':
          aValue = (a.wilayahArea || '').toLowerCase();
          bValue = (b.wilayahArea || '').toLowerCase();
          break;
        case 'kabupaten':
          aValue = (a.kabupaten || '').toLowerCase();
          bValue = (b.kabupaten || '').toLowerCase();
          break;
        case 'koordinator':
          aValue = (a.koordinator || '').toLowerCase();
          bValue = (b.koordinator || '').toLowerCase();
          break;
        case 'keterangan':
          aValue = (a.keterangan || '').toLowerCase();
          bValue = (b.keterangan || '').toLowerCase();
          break;
        case 'whatsapp':
          aValue = a.whatsapp || '';
          bValue = b.whatsapp || '';
          break;
        case 'tanggalSurat':
          aValue = a.tanggalSurat ? new Date(a.tanggalSurat) : new Date(0);
          bValue = b.tanggalSurat ? new Date(b.tanggalSurat) : new Date(0);
          break;
        case 'status':
          aValue = a.status || 'pending';
          bValue = b.status || 'pending';
          break;
        case 'createdAt':
        default:
          aValue = a.createdAt || new Date(0);
          bValue = b.createdAt || new Date(0);
          break;
      }
      
      if (currentSortDirection === 'asc') {
        return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
      } else {
        return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
      }
    });
  }

  // Toggle Sort
  function toggleSort(column) {
    if (currentSortColumn === column) {
      currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortColumn = column;
      currentSortDirection = 'asc';
    }
    
    // Update sort indicators
    document.querySelectorAll('.data-table th').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
    });
    
    const currentTh = document.querySelector(`.data-table th[data-sort="${column}"]`);
    if (currentTh) {
      currentTh.classList.add(`sort-${currentSortDirection}`);
    }
    
    // Sort and render
    sortData();
    filteredData = [...allData];
    currentPage = 1;
    renderDataTable();
  }

  // Render Data Table with Pagination
  function renderDataTable() {
    const tbody = document.getElementById('dataTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="14" style="text-align: center; padding: 40px; color: #666;">
            <h3>üì≠ Tidak Ada Data</h3>
            <p>Tidak ada data packlaring yang ditemukan.</p>
          </td>
        </tr>
      `;
      updatePaginationInfo();
      updateSelectedCount();
      return;
    }
    
    // Calculate pagination
    totalPages = Math.ceil(filteredData.length / itemsPerPage);
    if (currentPage > totalPages) currentPage = totalPages;
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
    const displayData = filteredData.slice(startIndex, endIndex);
    
    // Render table rows
    displayData.forEach((data, index) => {
      const globalIndex = startIndex + index + 1;
      const isSelected = selectedIds.has(data.id);
      const row = document.createElement('tr');
      
      // Cek jika jabatan adalah teknisi untuk menampilkan data khusus
      const isTeknisi = data.jabatan && (
        data.jabatan.toLowerCase().includes('teknisi') || 
        data.jabatan.toLowerCase().includes('koordinator') ||
        data.jabatan.toLowerCase().includes('supervisor')
      );
      
      // Hitung waktu dari pending ke completed
      let processingTime = '-';
      if (data.status === 'completed' && data.createdAt && data.downloadedAt) {
        const created = data.createdAt;
        const downloaded = data.downloadedAt;
        const diffMs = downloaded - created;
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffDays > 0) {
          processingTime = `${diffDays} hari`;
        } else if (diffHours > 0) {
          processingTime = `${diffHours} jam`;
        } else {
          processingTime = '< 1 jam';
        }
      }
      
      row.innerHTML = `
        <td>
          <input type="checkbox" class="data-checkbox" data-id="${data.id}" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${data.id}')" style="width: 18px; height: 18px;">
        </td>
        <td>${globalIndex}</td>
        <td><strong>${data.namaLengkap || '-'}</strong></td>
        <td>${data.nip || '-'}</td>
        <td>${formatNomorKTPDisplay(data.nomorKTP || '-')}</td>
        <td>${isTeknisi ? (data.wilayahArea || '-') : '-'}</td>
        <td>${isTeknisi ? (data.kabupaten || '-') : '-'}</td>
        <td>${isTeknisi ? (data.koordinator || '-') : '-'}</td>
        <td>${data.keterangan || '-'}</td>
        <td>${formatWhatsAppDisplay(data.whatsapp || '-')}</td>
        <td>${data.noSurat || '-'}</td>
        <td>${formatShortDate(data.tanggalSurat || data.createdAt)}</td>
        <td>
          <span class="status-badge status-${data.status || 'pending'}">
            ${getStatusText(data.status)}
          </span>
          ${data.downloadCount ? `<br><small>üì• ${data.downloadCount}x</small>` : ''}
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-info btn-small" onclick="showDetail('${data.id}')" title="Detail">
              üìã
            </button>
            <button class="btn btn-warning btn-small" onclick="generateLink('${data.id}')" title="Generate Link">
              üîó
            </button>
            <button class="btn btn-success btn-small" onclick="editData('${data.id}')" title="Edit">
              ‚úèÔ∏è
            </button>
            <button class="btn btn-danger btn-small" onclick="confirmDeleteData('${data.id}')" title="Hapus">
              üóëÔ∏è
            </button>
          </div>
        </td>
      `;
      
      // Tambahkan warna latar untuk data teknisi
      if (isTeknisi) {
        row.style.backgroundColor = '#f0f8ff';
      }
      
      tbody.appendChild(row);
    });
    
    updatePaginationInfo();
    updatePaginationControls();
    updateSelectedCount();
  }

  // Update Pagination Information
  function updatePaginationInfo() {
    const paginationInfo = document.getElementById('paginationInfo');
    if (!paginationInfo) return;
    
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
    
    paginationInfo.innerHTML = 
      `Menampilkan ${startIndex}-${endIndex} dari ${filteredData.length} data`;
  }

  // Update Pagination Controls
  function updatePaginationControls() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageNumbers = document.getElementById('pageNumbers');
    
    if (!prevBtn || !nextBtn || !pageNumbers) return;
    
    // Update buttons state
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
    
    // Generate page numbers
    pageNumbers.innerHTML = '';
    
    // Calculate page range to display
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    // Adjust if at the beginning
    if (currentPage <= 3) {
      endPage = Math.min(5, totalPages);
    }
    
    // Adjust if at the end
    if (currentPage >= totalPages - 2) {
      startPage = Math.max(1, totalPages - 4);
    }
    
    // Add page numbers
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => goToPage(i);
      pageNumbers.appendChild(pageBtn);
    }
  }

  // Pagination Functions
  function nextPage() {
    if (currentPage < totalPages) {
      currentPage++;
      renderDataTable();
    }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderDataTable();
    }
  }

  function goToPage(page) {
    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      renderDataTable();
    }
  }

  // Get Status Text
  function getStatusText(status) {
    const statusMap = {
      'pending': '‚è≥ Pending',
      'processed': 'üîÑ Diproses',
      'completed': '‚úÖ Selesai'
    };
    return statusMap[status] || '‚è≥ Pending';
  }

  // Update Statistics
  function updateStats() {
    const total = allData.length;
    const pending = allData.filter(d => d.status === 'pending').length;
    const completed = allData.filter(d => d.status === 'completed').length;
    
    const totalDataElement = document.getElementById('totalData');
    const pendingDataElement = document.getElementById('pendingData');
    const completedDataElement = document.getElementById('completedData');
    
    if (totalDataElement) totalDataElement.textContent = total;
    if (pendingDataElement) pendingDataElement.textContent = pending;
    if (completedDataElement) completedDataElement.textContent = completed;
  }

  // Update System Information
  function updateSystemInfo() {
    // Calculate storage size
    const storageSize = calculateStorageSize(allData);
    
    const dbSizeElement = document.getElementById('dbSize');
    const storageSizeElement = document.getElementById('storageSize');
    
    if (dbSizeElement) dbSizeElement.textContent = storageSize;
    if (storageSizeElement) storageSizeElement.textContent = storageSize;
    
    // Calculate storage usage percentage (simulated)
    const storageUsed = allData.length;
    const storageLimit = 10000;
    const percentage = Math.min((storageUsed / storageLimit) * 100, 100);
    
    const storageProgressBar = document.getElementById('storageProgressBar');
    const storageUsedElement = document.getElementById('storageUsed');
    const storageTotalElement = document.getElementById('storageTotal');
    const storageDetails = document.getElementById('storageDetails');
    const todayDataCount = document.getElementById('todayDataCount');
    const totalDataInfo = document.getElementById('totalDataInfo');
    
    if (storageProgressBar) storageProgressBar.style.width = `${percentage}%`;
    if (storageUsedElement) storageUsedElement.textContent = storageUsed;
    if (storageTotalElement) storageTotalElement.textContent = storageLimit;
    if (storageDetails) storageDetails.innerHTML = 
      `<span id="storageUsed">${storageUsed}</span> dari <span id="storageTotal">${storageLimit}</span> data`;
    
    // Count today's data
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayData = allData.filter(d => {
      const dataDate = d.createdAt ? new Date(d.createdAt) : null;
      if (!dataDate) return false;
      dataDate.setHours(0, 0, 0, 0);
      return dataDate.getTime() === today.getTime();
    });
    
    if (todayDataCount) todayDataCount.textContent = todayData.length;
    if (totalDataInfo) totalDataInfo.textContent = allData.length;
  }

  // Get Firebase Storage Information
  async function updateFirebaseStorageInfo() {
    try {
      // Get storage usage from Firebase
      const totalDocs = allData.length;
      
      // Estimated storage usage (average 1KB per document)
      const estimatedUsageKB = totalDocs * 1;
      const estimatedUsageMB = estimatedUsageKB / 1024;
      const estimatedUsageGB = estimatedUsageMB / 1024;
      
      // Firebase free tier: 1GB storage
      const freeStorageGB = 1;
      const usedStorageGB = Math.min(estimatedUsageGB, freeStorageGB);
      const availableStorageGB = freeStorageGB - usedStorageGB;
      const percentageUsed = (usedStorageGB / freeStorageGB) * 100;
      
      // Update UI
      const firebaseTotalStorage = document.getElementById('firebaseTotalStorage');
      const firebaseUsedStorage = document.getElementById('firebaseUsedStorage');
      const firebaseAvailableStorage = document.getElementById('firebaseAvailableStorage');
      const firebaseStoragePercent = document.getElementById('firebaseStoragePercent');
      const firebaseStorageProgress = document.getElementById('firebaseStorageProgress');
      const firebaseStorageText = document.getElementById('firebaseStorageText');
      
      if (firebaseTotalStorage) firebaseTotalStorage.textContent = `${freeStorageGB.toFixed(2)} GB`;
      if (firebaseUsedStorage) firebaseUsedStorage.textContent = `${usedStorageGB.toFixed(2)} GB`;
      if (firebaseAvailableStorage) firebaseAvailableStorage.textContent = `${availableStorageGB.toFixed(2)} GB`;
      if (firebaseStoragePercent) firebaseStoragePercent.textContent = `${percentageUsed.toFixed(1)}%`;
      if (firebaseStorageProgress) firebaseStorageProgress.style.width = `${percentageUsed}%`;
      if (firebaseStorageText) firebaseStorageText.textContent = `${percentageUsed.toFixed(1)}% terpakai`;
      
    } catch (error) {
      console.error('Error getting Firebase storage info:', error);
      showNotification('Tidak dapat memuat informasi storage Firebase', 'warning');
    }
  }

  // Calculate storage size
  function calculateStorageSize(data) {
    if (!data || data.length === 0) return '0 KB';
    
    // Calculate approximate size
    const totalSize = calculateDataSize(data);
    return formatBytes(totalSize);
  }

  // Calculate data size in bytes
  function calculateDataSize(data) {
    const jsonString = JSON.stringify(data);
    return new Blob([jsonString]).size;
  }

  // Format bytes to human readable
  function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Update Recent List
  function updateRecentList() {
    const recentList = document.getElementById('recentList');
    if (!recentList) return;
    
    recentList.innerHTML = '';
    
    const recentData = allData.slice(0, 10);
    
    recentData.forEach(data => {
      const li = document.createElement('li');
      li.className = 'recent-item';
      li.onclick = () => {
        showDetail(data.id);
        showTab('data');
      };
      
      const date = formatShortDate(data.tanggalSurat || data.createdAt);
      li.innerHTML = `
        <strong>${data.namaLengkap || 'Tanpa Nama'}</strong><br>
        <small>${data.nip || 'No NIP'} ‚Ä¢ ${date}</small>
        <div style="margin-top: 5px;">
          <span class="status-badge status-${data.status || 'pending'}" style="font-size: 10px; padding: 2px 8px;">
            ${getStatusText(data.status)}
          </span>
          ${data.downloadCount ? `<small style="display: block; color: #666; margin-top: 2px;">üì• ${data.downloadCount}x download</small>` : ''}
        </div>
      `;
      recentList.appendChild(li);
    });
  }

  // Show Detail Data
  function showDetail(docId) {
    const data = allData.find(d => d.id === docId);
    if (!data) return;
    
    // Hitung waktu processing
    let processingTime = '-';
    if (data.status === 'completed' && data.createdAt && data.downloadedAt) {
      const created = data.createdAt;
      const downloaded = data.downloadedAt;
      const diffMs = downloaded - created;
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffDays > 0) {
        processingTime = `${diffDays} hari ${diffHours % 24} jam`;
      } else if (diffHours > 0) {
        processingTime = `${diffHours} jam`;
      } else {
        processingTime = '< 1 jam';
      }
    }
    
    // Generate download link for detail view
    const currentUrl = window.location.href;
    let baseUrl = currentUrl;
    
    if (currentUrl.includes('admin.html')) {
      baseUrl = currentUrl.replace('admin.html', 'download-letter.html');
    } else {
      const url = new URL(currentUrl);
      url.pathname = url.pathname.replace(/\/[^\/]*$/, '/download-letter.html');
      baseUrl = url.toString();
    }
    
    const downloadUrl = `${baseUrl.split('?')[0]}?id=${data.id}&ktp=${encodeURIComponent(data.nomorKTP || '')}`;
    
    const detailHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div>
          <h4 style="margin-bottom: 15px; color: #333;">üë§ Data Pribadi</h4>
          <div class="detail-item">
            <strong>Nama Lengkap:</strong> ${data.namaLengkap || '-'}
          </div>
          <div class="detail-item">
            <strong>NIP:</strong> ${data.nip || '-'}
          </div>
          <div class="detail-item">
            <strong>Nomor KTP:</strong> ${formatNomorKTPDisplay(data.nomorKTP || '-')}
          </div>
          <div class="detail-item">
            <strong>Tempat Lahir:</strong> ${data.tempatLahir || '-'}
          </div>
          <div class="detail-item">
            <strong>Tanggal Lahir:</strong> ${formatDate(data.tanggalLahir)}
          </div>
          ${data.jabatan && (data.jabatan.toLowerCase().includes('teknisi') || data.jabatan.toLowerCase().includes('koordinator') || data.jabatan.toLowerCase().includes('supervisor')) ? `
          <div class="detail-item">
            <strong>Provinsi/Wilayah:</strong> ${data.wilayahArea || '-'}
          </div>
          <div class="detail-item">
            <strong>Kabupaten:</strong> ${data.kabupaten || '-'}
          </div>
          <div class="detail-item">
            <strong>Koordinator:</strong> ${data.koordinator || '-'}
          </div>
          ` : ''}
          <div class="detail-item">
            <strong>Keterangan:</strong> ${data.keterangan || '-'}
          </div>
        </div>
        
        <div>
          <h4 style="margin-bottom: 15px; color: #333;">üè¢ Data Perusahaan</h4>
          <div class="detail-item">
            <strong>Jabatan:</strong> ${data.jabatan || '-'}
          </div>
          <div class="detail-item">
            <strong>Departemen:</strong> ${data.deptKaryawan || '-'}
          </div>
          <div class="detail-item">
            <strong>No. Surat:</strong> ${data.noSurat || '-'}
          </div>
          <div class="detail-item">
            <strong>Tanggal Surat:</strong> ${formatDate(data.tanggalSurat)}
          </div>
          <div class="detail-item">
            <strong>Tujuan Surat:</strong> ${data.tujuanSurat || '-'}
          </div>
          <div class="detail-item">
            <strong>Tanggal Mulai:</strong> ${formatDate(data.tanggalMulai)}
          </div>
          <div class="detail-item">
            <strong>Tanggal Berakhir:</strong> ${formatDate(data.tanggalBerakhir)}
          </div>
          <div class="detail-item">
            <strong>Alasan Berhenti:</strong> ${data.alasanBerhenti || '-'}
          </div>
        </div>
        
        <div>
          <h4 style="margin-bottom: 15px; color: #333;">üìÖ Status & Download</h4>
          <div class="detail-item">
            <strong>Status:</strong> <span class="status-badge status-${data.status || 'pending'}">
              ${getStatusText(data.status)}
            </span>
          </div>
          <div class="detail-item">
            <strong>Waktu Processing:</strong> ${processingTime}
          </div>
          <div class="detail-item">
            <strong>Total Download:</strong> ${data.downloadCount || 0} kali
          </div>
          <div class="detail-item">
            <strong>Terakhir Download:</strong> ${data.lastDownloadedAt ? formatDate(data.lastDownloadedAt) : '-'}
          </div>
          <div class="detail-item">
            <strong>Download oleh:</strong> ${data.lastDownloadedBy || '-'}
          </div>
        </div>
        
        <div>
          <h4 style="margin-bottom: 15px; color: #333;">üìû Kontak & Log</h4>
          <div class="detail-item">
            <strong>WhatsApp:</strong> ${formatWhatsAppDisplay(data.whatsapp || '-')}
          </div>
          <div class="detail-item">
            <strong>Email:</strong> ${data.email || '-'}
          </div>
          <div class="detail-item">
            <strong>Tanggal Input:</strong> ${formatDate(data.createdAt)}
          </div>
          <div class="detail-item">
            <strong>Terakhir Update:</strong> ${formatDate(data.updatedAt || data.createdAt)}
          </div>
          <div class="detail-item">
            <strong>Penandatangan:</strong> ${data.namaPenandatangan || '-'}
          </div>
          <div class="detail-item">
            <strong>Jabatan Penandatangan:</strong> ${data.jabatanPenandatangan || '-'}
          </div>
          <div class="detail-item">
            <strong>Kota Penandatangan:</strong> ${data.kotaPenandatangan || '-'}
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: #f1f8ff; border-radius: 10px; border-left: 4px solid #3498db;">
        <h5 style="color: #1a56db; margin-bottom: 10px;">üîó Link Download</h5>
        <input type="text" value="${downloadUrl}" readonly style="width: 100%; padding: 10px; border: 1px solid #3498db; border-radius: 6px; font-family: monospace; font-size: 12px;">
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button class="btn btn-primary btn-small" onclick="navigator.clipboard.writeText('${downloadUrl}').then(() => showNotification('Link disalin!', 'success'))">
            üìã Copy Link
          </button>
          <a href="${downloadUrl}" target="_blank" class="btn btn-info btn-small">
            üîó Buka Link
          </a>
        </div>
      </div>
      
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
        <div style="display: flex; gap: 15px; justify-content: flex-end; flex-wrap: wrap;">
          <button class="btn btn-info" onclick="generateLink('${data.id}')">
            üîó Generate & Share Link
          </button>
          <button class="btn btn-success" onclick="editData('${data.id}')">
            ‚úèÔ∏è Edit Data
          </button>
          <button class="btn btn-danger" onclick="confirmDeleteData('${data.id}')">
            üóëÔ∏è Hapus Data
          </button>
        </div>
      </div>
    `;
    
    const detailContent = document.getElementById('detailContent');
    if (detailContent) detailContent.innerHTML = detailHTML;
    
    const detailModal = document.getElementById('detailModal');
    if (detailModal) detailModal.classList.add('active');
  }

  function closeDetailModal() {
    const detailModal = document.getElementById('detailModal');
    if (detailModal) detailModal.classList.remove('active');
  }

  // ==================== FUNGSI EDIT YANG DIPERBAIKI ====================

  // Toggle field lokasi untuk teknisi
  function toggleLokasiFields() {
    const jabatan = document.getElementById('editJabatan').value;
    const lokasiFields = document.getElementById('lokasiTeknisiFields');
    
    const isTeknisi = jabatan && (
      jabatan.toLowerCase().includes('teknisi') || 
      jabatan.toLowerCase().includes('koordinator') ||
      jabatan.toLowerCase().includes('supervisor')
    );
    
    if (isTeknisi) {
      lokasiFields.classList.add('active');
    } else {
      lokasiFields.classList.remove('active');
    }
  }

  // Edit Data
  function editData(docId) {
    selectedDocId = docId;
    const data = allData.find(d => d.id === docId);
    
    if (data) {
      // Simpan data asli sebelum diedit
      originalDataBeforeEdit = JSON.parse(JSON.stringify(data));
      
      // Populate form dengan semua data
      document.getElementById('editNamaLengkap').value = data.namaLengkap || '';
      document.getElementById('editNIP').value = data.nip || '';
      document.getElementById('editNomorKTP').value = data.nomorKTP || '';
      document.getElementById('editTempatLahir').value = data.tempatLahir || '';
      
      if (data.tanggalLahir) {
        const tglLahir = new Date(data.tanggalLahir);
        document.getElementById('editTanggalLahir').value = tglLahir.toISOString().split('T')[0];
      } else {
        document.getElementById('editTanggalLahir').value = '';
      }
      
      document.getElementById('editJabatan').value = data.jabatan || '';
      document.getElementById('editDeptKaryawan').value = data.deptKaryawan || '';
      
      if (data.tanggalMulai) {
        const tglMulai = new Date(data.tanggalMulai);
        document.getElementById('editTanggalMulai').value = tglMulai.toISOString().split('T')[0];
      } else {
        document.getElementById('editTanggalMulai').value = '';
      }
      
      if (data.tanggalBerakhir) {
        const tglBerakhir = new Date(data.tanggalBerakhir);
        document.getElementById('editTanggalBerakhir').value = tglBerakhir.toISOString().split('T')[0];
      } else {
        document.getElementById('editTanggalBerakhir').value = '';
      }
      
      document.getElementById('editAlasanBerhenti').value = data.alasanBerhenti || 'KONTRAK BERAKHIR';
      document.getElementById('editNoSurat').value = data.noSurat || '';
      
      if (data.tanggalSurat) {
        let tglSurat;
        
        if (data.tanggalSurat instanceof Date) {
          tglSurat = data.tanggalSurat;
        } else if (typeof data.tanggalSurat === 'string') {
          tglSurat = new Date(data.tanggalSurat);
          
          if (isNaN(tglSurat.getTime())) {
            const parts = data.tanggalSurat.split('/');
            if (parts.length === 3) {
              tglSurat = new Date(parts[2], parts[1] - 1, parts[0]);
            } else {
              tglSurat = new Date(data.tanggalSurat.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1'));
            }
          }
        } else if (data.tanggalSurat && data.tanggalSurat.toDate) {
          tglSurat = data.tanggalSurat.toDate();
        } else {
          tglSurat = new Date();
        }
        
        if (tglSurat && !isNaN(tglSurat.getTime())) {
          document.getElementById('editTanggalSurat').value = tglSurat.toISOString().split('T')[0];
        } else {
          document.getElementById('editTanggalSurat').value = new Date().toISOString().split('T')[0];
        }
      } else {
        document.getElementById('editTanggalSurat').value = new Date().toISOString().split('T')[0];
      }
      
      document.getElementById('editTujuanSurat').value = data.tujuanSurat || '';
      document.getElementById('editWhatsapp').value = data.whatsapp || '';
      document.getElementById('editEmail').value = data.email || '';
      document.getElementById('editWilayah').value = data.wilayahArea || '';
      document.getElementById('editKabupaten').value = data.kabupaten || '';
      document.getElementById('editKoordinator').value = data.koordinator || '';
      document.getElementById('editNamaPenandatangan').value = data.namaPenandatangan || settings.defaultPenandatangan;
      document.getElementById('editJabatanPenandatangan').value = data.jabatanPenandatangan || settings.defaultJabatan;
      document.getElementById('editKotaPenandatangan').value = data.kotaPenandatangan || settings.kotaTandaTangan;
      document.getElementById('editKeterangan').value = data.keterangan || '';
      document.getElementById('editStatus').value = data.status || 'pending';
      document.getElementById('editCatatan').value = data.catatanAdmin || '';
      
      toggleLokasiFields();
      
      const editModal = document.getElementById('editModal');
      if (editModal) editModal.classList.add('active');
    }
  }

  function closeModal() {
    const editModal = document.getElementById('editModal');
    if (editModal) editModal.classList.remove('active');
    originalDataBeforeEdit = null;
  }

  // Update Data
  async function updateData() {
    showLoading(true);
    
    try {
      const formData = {
        namaLengkap: document.getElementById('editNamaLengkap').value,
        nip: document.getElementById('editNIP').value,
        nomorKTP: document.getElementById('editNomorKTP').value,
        tempatLahir: document.getElementById('editTempatLahir').value,
        jabatan: document.getElementById('editJabatan').value,
        deptKaryawan: document.getElementById('editDeptKaryawan').value,
        alasanBerhenti: document.getElementById('editAlasanBerhenti').value,
        noSurat: document.getElementById('editNoSurat').value,
        tujuanSurat: document.getElementById('editTujuanSurat').value,
        whatsapp: document.getElementById('editWhatsapp').value,
        email: document.getElementById('editEmail').value,
        namaPenandatangan: document.getElementById('editNamaPenandatangan').value,
        jabatanPenandatangan: document.getElementById('editJabatanPenandatangan').value,
        kotaPenandatangan: document.getElementById('editKotaPenandatangan').value,
        keterangan: document.getElementById('editKeterangan').value,
        status: document.getElementById('editStatus').value,
        catatanAdmin: document.getElementById('editCatatan').value,
        updatedAt: new Date(),
        updatedBy: 'Admin'
      };
      
      const tanggalLahirInput = document.getElementById('editTanggalLahir').value;
      if (tanggalLahirInput) {
        formData.tanggalLahir = new Date(tanggalLahirInput);
      } else if (originalDataBeforeEdit && originalDataBeforeEdit.tanggalLahir) {
        formData.tanggalLahir = originalDataBeforeEdit.tanggalLahir;
      }
      
      const tanggalMulaiInput = document.getElementById('editTanggalMulai').value;
      if (tanggalMulaiInput) {
        formData.tanggalMulai = new Date(tanggalMulaiInput);
      } else if (originalDataBeforeEdit && originalDataBeforeEdit.tanggalMulai) {
        formData.tanggalMulai = originalDataBeforeEdit.tanggalMulai;
      }
      
      const tanggalBerakhirInput = document.getElementById('editTanggalBerakhir').value;
      if (tanggalBerakhirInput) {
        formData.tanggalBerakhir = new Date(tanggalBerakhirInput);
      } else if (originalDataBeforeEdit && originalDataBeforeEdit.tanggalBerakhir) {
        formData.tanggalBerakhir = originalDataBeforeEdit.tanggalBerakhir;
      }
      
      const tanggalSuratInput = document.getElementById('editTanggalSurat').value;
      if (tanggalSuratInput) {
        formData.tanggalSurat = new Date(tanggalSuratInput);
      } else if (originalDataBeforeEdit && originalDataBeforeEdit.tanggalSurat) {
        formData.tanggalSurat = originalDataBeforeEdit.tanggalSurat;
      } else {
        formData.tanggalSurat = new Date();
      }
      
      const isTeknisi = formData.jabatan && (
        formData.jabatan.toLowerCase().includes('teknisi') || 
        formData.jabatan.toLowerCase().includes('koordinator') ||
        formData.jabatan.toLowerCase().includes('supervisor')
      );
      
      if (isTeknisi) {
        formData.wilayahArea = document.getElementById('editWilayah').value || '';
        formData.kabupaten = document.getElementById('editKabupaten').value || '';
        formData.koordinator = document.getElementById('editKoordinator').value || '';
      } else {
        formData.wilayahArea = '';
        formData.kabupaten = '';
        formData.koordinator = '';
      }
      
      if (!formData.namaLengkap || !formData.nip || !formData.nomorKTP) {
        throw new Error('Nama, NIP, dan Nomor KTP wajib diisi');
      }
      
      if (!formData.jabatan || !formData.tanggalMulai || !formData.tanggalBerakhir) {
        throw new Error('Jabatan dan tanggal kerja wajib diisi');
      }
      
      if (!formData.noSurat || !formData.tanggalSurat) {
        throw new Error('Nomor surat dan tanggal surat wajib diisi');
      }
      
      if (formData.nip && originalDataBeforeEdit) {
        const duplicateNIP = allData.find(d => 
          d.id !== selectedDocId && d.nip === formData.nip
        );
        
        if (duplicateNIP) {
          showNotification('NIP sudah digunakan oleh karyawan lain!', 'warning');
          return;
        }
      }
      
      if (formData.nomorKTP && originalDataBeforeEdit) {
        const duplicateKTP = allData.find(d => 
          d.id !== selectedDocId && d.nomorKTP === formData.nomorKTP
        );
        
        if (duplicateKTP) {
          showNotification('Nomor KTP sudah digunakan!', 'warning');
          return;
        }
      }
      
      if (formData.noSurat && originalDataBeforeEdit) {
        const duplicateNoSurat = allData.find(d => 
          d.id !== selectedDocId && d.noSurat === formData.noSurat
        );
        
        if (duplicateNoSurat) {
          showNotification('Nomor Surat sudah digunakan!', 'warning');
          return;
        }
      }
      
      await db.collection('packlaring').doc(selectedDocId).update(formData);
      
      closeModal();
      loadData();
      
      showNotification('Data berhasil diperbarui!', 'success');
      
    } catch (error) {
      console.error('Error updating data:', error);
      showNotification('Gagal update data: ' + error.message, 'error');
    } finally {
      showLoading(false);
      originalDataBeforeEdit = null;
    }
  }

  // Confirm Delete Data
  function confirmDeleteData(docId) {
    const data = allData.find(d => d.id === docId);
    if (!data) return;
    
    deleteDataToDelete = {
      id: docId,
      data: data
    };
    
    document.getElementById('deleteNama').textContent = data.namaLengkap || '-';
    document.getElementById('deleteNIP').textContent = data.nip || '-';
    document.getElementById('deleteNoSurat').textContent = data.noSurat || '-';
    document.getElementById('deleteTanggal').textContent = formatDate(data.createdAt);
    
    document.getElementById('deleteTitle').textContent = `Hapus Data: ${data.namaLengkap || 'Tanpa Nama'}`;
    document.getElementById('deleteMessage').textContent = 
      `Apakah Anda yakin ingin menghapus data "${data.namaLengkap || 'Data'}"?`;
    
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) deleteModal.classList.add('active');
  }

  // Close Delete Modal
  function closeDeleteModal() {
    deleteDataToDelete = null;
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) deleteModal.classList.remove('active');
  }

  // Confirm Delete
  async function confirmDelete() {
    if (!deleteDataToDelete) return;
    
    showLoading(true);
    
    try {
      await db.collection('packlaring').doc(deleteDataToDelete.id).delete();
      
      showNotification(
        `Data "${deleteDataToDelete.data.namaLengkap || 'Data'}" berhasil dihapus!`, 
        'success'
      );
      
      selectedIds.delete(deleteDataToDelete.id);
      
      closeDeleteModal();
      loadData();
      
    } catch (error) {
      console.error('Error deleting data:', error);
      showNotification('Gagal menghapus data: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Multi-select functions
  function toggleSelect(id) {
    if (selectedIds.has(id)) {
      selectedIds.delete(id);
    } else {
      selectedIds.add(id);
    }
    updateSelectedCount();
  }

  function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    if (!selectAll) return;
    
    if (selectAll.checked) {
      filteredData.forEach(item => {
        selectedIds.add(item.id);
      });
    } else {
      selectedIds.clear();
    }
    
    document.querySelectorAll('.data-checkbox').forEach(checkbox => {
      checkbox.checked = selectAll.checked;
    });
    
    updateSelectedCount();
  }

  function updateSelectedCount() {
    const selectedCount = document.getElementById('selectedCount');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    
    if (selectedCount) {
      selectedCount.textContent = `${selectedIds.size} data terpilih`;
    }
    
    if (deleteSelectedBtn) {
      deleteSelectedBtn.disabled = selectedIds.size === 0;
    }
    
    const selectAll = document.getElementById('selectAll');
    if (selectAll && filteredData.length > 0) {
      const allChecked = filteredData.every(item => selectedIds.has(item.id));
      selectAll.checked = allChecked;
      selectAll.indeterminate = !allChecked && selectedIds.size > 0;
    }
  }

  // Delete selected data
  async function deleteSelected() {
    if (selectedIds.size === 0) return;
    
    const count = selectedIds.size;
    if (!confirm(`Apakah Anda yakin ingin menghapus ${count} data yang dipilih?`)) {
      return;
    }
    
    showLoading(true);
    
    try {
      const deletePromises = Array.from(selectedIds).map(id => 
        db.collection('packlaring').doc(id).delete()
      );
      
      await Promise.all(deletePromises);
      
      showNotification(`${count} data berhasil dihapus!`, 'success');
      
      selectedIds.clear();
      loadData();
      
    } catch (error) {
      console.error('Error deleting selected data:', error);
      showNotification('Gagal menghapus data: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Show multiple delete instructions
  function deleteMultiple() {
    showNotification(
      'Pilih data yang ingin dihapus dengan mencentang kotak di kolom "Pilih", lalu klik "Hapus Terpilih"',
      'info'
    );
  }

  // Update Dashboard
  function updateDashboard() {
    const total = allData.length;
    const pending = allData.filter(d => d.status === 'pending').length;
    const completed = allData.filter(d => d.status === 'completed').length;
    
    const totalDataElement = document.getElementById('totalData');
    const pendingDataElement = document.getElementById('pendingData');
    const completedDataElement = document.getElementById('completedData');
    
    if (totalDataElement) totalDataElement.textContent = total;
    if (pendingDataElement) pendingDataElement.textContent = pending;
    if (completedDataElement) completedDataElement.textContent = completed;
    
    const cardTotal = document.getElementById('cardTotal');
    const cardPending = document.getElementById('cardPending');
    const cardCompleted = document.getElementById('cardCompleted');
    
    if (cardTotal) cardTotal.textContent = total;
    if (cardPending) cardPending.textContent = pending;
    if (cardCompleted) cardCompleted.textContent = completed;
    
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    const thisMonthData = allData.filter(d => {
      const date = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
      if (!date) return false;
      return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
    });
    
    const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
    const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;
    const lastMonthData = allData.filter(d => {
      const date = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
      if (!date) return false;
      return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
    });
    
    const totalChange = lastMonthData.length > 0 ? 
      (((thisMonthData.length - lastMonthData.length) / lastMonthData.length) * 100).toFixed(1) : 0;
    const completedChange = total > 0 ? 
      ((completed / total) * 100).toFixed(1) : 0;
    
    const cardChange = document.getElementById('cardChange');
    const cardCompletedChange = document.getElementById('cardCompletedChange');
    
    if (cardChange) {
      const changeSign = totalChange >= 0 ? '+' : '';
      cardChange.textContent = `${changeSign}${totalChange}% dari bulan lalu`;
      cardChange.className = `card-change ${totalChange >= 0 ? '' : 'negative'}`;
    }
    
    if (cardCompletedChange) {
      cardCompletedChange.textContent = `${completedChange}% selesai`;
    }
    
    updateDownloadStats();
    
    const chartContainer = document.getElementById('chartContainer');
    if (chartContainer && chartContainer.offsetParent !== null) {
      updateChart();
    }
    
    const activityList = document.getElementById('activityList');
    if (activityList) {
      updateActivityList();
    }
    
    const provinceStats = document.getElementById('provinceStats');
    if (provinceStats) {
      updateProvinceStats();
    }
  }

  // Update Download Statistics
  function updateDownloadStats() {
    const totalDownloads = allData.reduce((sum, data) => sum + (data.downloadCount || 0), 0);
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayDownloads = allData.filter(d => {
      const downloadDate = d.lastDownloadedAt ? new Date(d.lastDownloadedAt) : null;
      if (!downloadDate) return false;
      downloadDate.setHours(0, 0, 0, 0);
      return downloadDate.getTime() === today.getTime();
    }).length;
    
    const completedData = allData.filter(d => d.status === 'completed');
    let totalHours = 0;
    let countWithTime = 0;
    
    completedData.forEach(data => {
      if (data.createdAt && data.downloadedAt) {
        const diffMs = data.downloadedAt - data.createdAt;
        totalHours += diffMs / 3600000;
        countWithTime++;
      }
    });
    
    const avgTime = countWithTime > 0 ? (totalHours / countWithTime).toFixed(1) : 0;
    const conversionRate = allData.length > 0 ? ((completedData.length / allData.length) * 100).toFixed(1) : 0;
    
    const totalDownloadsEl = document.getElementById('totalDownloads');
    const todayDownloadsEl = document.getElementById('todayDownloads');
    const avgTimeEl = document.getElementById('avgTime');
    const conversionRateEl = document.getElementById('conversionRate');
    
    if (totalDownloadsEl) totalDownloadsEl.textContent = totalDownloads;
    if (todayDownloadsEl) todayDownloadsEl.textContent = todayDownloads;
    if (avgTimeEl) avgTimeEl.textContent = `${avgTime}h`;
    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
    
    updateRecentDownloads();
  }

  // Update Recent Downloads
  function updateRecentDownloads() {
    const recentDownloads = document.getElementById('recentDownloads');
    if (!recentDownloads) return;
    
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    
    const recentData = allData.filter(d => {
      const downloadDate = d.lastDownloadedAt ? new Date(d.lastDownloadedAt) : null;
      return downloadDate && downloadDate >= sevenDaysAgo;
    }).sort((a, b) => {
      const dateA = a.lastDownloadedAt || new Date(0);
      const dateB = b.lastDownloadedAt || new Date(0);
      return dateB - dateA;
    }).slice(0, 10);
    
    if (recentData.length === 0) {
      recentDownloads.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada download dalam 7 hari terakhir</p>';
      return;
    }
    
    let html = '';
    recentData.forEach(data => {
      const date = data.lastDownloadedAt ? formatDate(data.lastDownloadedAt) : '-';
      const time = data.lastDownloadedAt ? new Date(data.lastDownloadedAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
      
      html += `
        <div class="activity-item">
          <div class="activity-icon">üì•</div>
          <div class="activity-content">
            <strong>${data.namaLengkap || 'Tanpa Nama'}</strong><br>
            <small style="color: #666;">${data.nip || 'No NIP'} ‚Ä¢ ${date} ${time}</small>
            <div style="margin-top: 5px;">
              <small style="color: #3498db;">Total: ${data.downloadCount || 0}x download</small>
            </div>
          </div>
        </div>
      `;
    });
    
    recentDownloads.innerHTML = html;
  }

  // Update Chart
  function updateChart() {
    const ctx = document.getElementById('statsChart');
    if (!ctx) return;
    
    if (statsChart) {
      statsChart.destroy();
    }
    
    const now = new Date();
    const months = [];
    const monthData = { pending: [], processed: [], completed: [], downloads: [] };
    
    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleDateString('id-ID', { month: 'short' });
      months.push(monthName);
      
      const monthDataFiltered = allData.filter(d => {
        const dataDate = d.tanggalSurat ? new Date(d.tanggalSurat) : d.createdAt;
        if (!dataDate) return false;
        return dataDate.getMonth() === date.getMonth() && 
               dataDate.getFullYear() === date.getFullYear();
      });
      
      monthData.pending.push(monthDataFiltered.filter(d => d.status === 'pending').length);
      monthData.processed.push(monthDataFiltered.filter(d => d.status === 'processed').length);
      monthData.completed.push(monthDataFiltered.filter(d => d.status === 'completed').length);
      
      const monthDownloads = monthDataFiltered.reduce((sum, d) => sum + (d.downloadCount || 0), 0);
      monthData.downloads.push(monthDownloads);
    }
    
    try {
      statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Pending',
              data: monthData.pending,
              backgroundColor: '#ffc107',
              borderColor: '#ffc107',
              borderWidth: 1
            },
            {
              label: 'Diproses',
              data: monthData.processed,
              backgroundColor: '#17a2b8',
              borderColor: '#17a2b8',
              borderWidth: 1
            },
            {
              label: 'Selesai',
              data: monthData.completed,
              backgroundColor: '#28a745',
              borderColor: '#28a745',
              borderWidth: 1
            },
            {
              label: 'Downloads',
              data: monthData.downloads,
              backgroundColor: '#e74c3c',
              borderColor: '#e74c3c',
              borderWidth: 1,
              type: 'line',
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Statistik Packlaring 6 Bulan Terakhir'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              },
              title: {
                display: true,
                text: 'Jumlah Surat'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              ticks: {
                stepSize: 1
              },
              title: {
                display: true,
                text: 'Jumlah Download'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    } catch (error) {
      console.error('Error creating chart:', error);
    }
  }

  // Update Activity List
  function updateActivityList() {
    const activityList = document.getElementById('activityList');
    if (!activityList) return;
    
    const sortedData = [...allData].sort((a, b) => {
      const dateA = a.updatedAt || a.createdAt || new Date(0);
      const dateB = b.updatedAt || b.createdAt || new Date(0);
      return dateB - dateA;
    }).slice(0, 10);
    
    if (sortedData.length === 0) {
      activityList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada aktivitas</p>';
      return;
    }
    
    let activityHTML = '';
    sortedData.forEach(data => {
      const timeAgo = getTimeAgo(data.updatedAt || data.createdAt);
      const statusIcon = data.status === 'completed' ? '‚úÖ' : 
                        data.status === 'processed' ? 'üîÑ' : '‚è≥';
      
      activityHTML += `
        <div class="activity-item">
          <div class="activity-icon">${statusIcon}</div>
          <div class="activity-content">
            <strong>${data.namaLengkap || 'Tanpa Nama'}</strong><br>
            <small style="color: #666;">${data.wilayahArea || 'Tidak ada wilayah'} ‚Ä¢ ${timeAgo}</small>
            ${data.downloadCount ? `<div style="margin-top: 5px;"><small style="color: #3498db;">üì• ${data.downloadCount}x download</small></div>` : ''}
          </div>
        </div>
      `;
    });
    
    activityList.innerHTML = activityHTML;
  }

  // Get Time Ago
  function getTimeAgo(date) {
    if (!date) return '-';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) {
      return `${diffMins} menit lalu`;
    } else if (diffHours < 24) {
      return `${diffHours} jam lalu`;
    } else if (diffDays < 7) {
      return `${diffDays} hari lalu`;
    } else {
      return formatShortDate(date);
    }
  }

  // Update Province Stats
  function updateProvinceStats() {
    const provinceStats = document.getElementById('provinceStats');
    if (!provinceStats) return;
    
    const provinceCount = {};
    allData.forEach(data => {
      if (data.wilayahArea) {
        const province = data.wilayahArea;
        provinceCount[province] = (provinceCount[province] || 0) + 1;
      }
    });
    
    const sortedProvinces = Object.entries(provinceCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);
    
    if (sortedProvinces.length === 0) {
      provinceStats.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada data provinsi</p>';
      return;
    }
    
    const totalData = allData.length;
    let provinceHTML = '';
    
    sortedProvinces.forEach(([province, count], index) => {
      const percentage = totalData > 0 ? ((count / totalData) * 100).toFixed(1) : 0;
      const colorClass = `province-color-${index % 10}`;
      const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
      
      provinceHTML += `
        <div class="province-item">
          <div class="province-icon">${medal}</div>
          <div class="province-content">
            <div style="display: flex; justify-content: space-between;">
              <span>${province}</span>
              <span><strong>${count}</strong> (${percentage}%)</span>
            </div>
            <div class="province-bar">
              <div class="province-bar-fill ${colorClass}" style="width: ${percentage}%"></div>
            </div>
          </div>
        </div>
      `;
    });
    
    provinceStats.innerHTML = provinceHTML;
  }

  // Filter Data
  function filterData() {
    const statusFilterElement = document.getElementById('filterStatus');
    const bulanFilterElement = document.getElementById('filterBulan');
    const dariFilterElement = document.getElementById('filterDari');
    const sampaiFilterElement = document.getElementById('filterSampai');
    const searchFilterElement = document.getElementById('searchInput');
    
    if (!statusFilterElement || !bulanFilterElement || !searchFilterElement) return;
    
    const statusFilter = statusFilterElement.value;
    const bulanFilter = bulanFilterElement.value;
    const dariFilter = dariFilterElement ? dariFilterElement.value : '';
    const sampaiFilter = sampaiFilterElement ? sampaiFilterElement.value : '';
    const searchFilter = searchFilterElement.value.toLowerCase();
    
    filteredData = allData.filter(data => {
      if (statusFilter !== 'all' && data.status !== statusFilter) {
        return false;
      }
      
      if (bulanFilter !== 'all') {
        const date = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (!date || (date.getMonth() + 1) !== parseInt(bulanFilter)) {
          return false;
        }
      }
      
      if (dariFilter) {
        const dariDate = new Date(dariFilter);
        const dataDate = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (!dataDate || dataDate < dariDate) {
          return false;
        }
      }
      
      if (sampaiFilter) {
        const sampaiDate = new Date(sampaiFilter);
        sampaiDate.setHours(23, 59, 59);
        const dataDate = data.tanggalSurat ? new Date(data.tanggalSurat) : data.createdAt;
        if (!dataDate || dataDate > sampaiDate) {
          return false;
        }
      }
      
      if (searchFilter) {
        const searchStr = `
          ${data.namaLengkap || ''} 
          ${data.nip || ''} 
          ${data.noSurat || ''} 
          ${data.jabatan || ''}
          ${data.nomorKTP || ''}
          ${data.wilayahArea || ''}
          ${data.kabupaten || ''}
          ${data.koordinator || ''}
          ${data.keterangan || ''}
          ${data.whatsapp || ''}
        `.toLowerCase();
        
        if (!searchStr.includes(searchFilter)) {
          return false;
        }
      }
      
      return true;
    });
    
    currentPage = 1;
    renderDataTable();
  }

  // Copy Share Link
  function copyShareLink() {
    const linkInput = document.getElementById('shareLinkInput');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    
    try {
      navigator.clipboard.writeText(linkInput.value);
      showNotification('Link berhasil disalin ke clipboard!', 'success');
    } catch (error) {
      document.execCommand('copy');
      showNotification('Link berhasil disalin!', 'success');
    }
  }

  // Mark as Completed
  async function markAsCompleted() {
    if (!shareData) return;
    
    showLoading(true);
    
    try {
      await db.collection('packlaring').doc(shareData.id).update({
        status: 'completed',
        downloadedAt: new Date(),
        downloadedBy: 'Admin',
        updatedAt: new Date()
      });
      
      showNotification('Status berhasil diubah menjadi Selesai!', 'success');
      closeShareModal();
      loadData();
      
    } catch (error) {
      console.error('Error updating status:', error);
      showNotification('Gagal mengubah status: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // Send WhatsApp Notification
  function sendWhatsAppNotification() {
    if (!shareData) return;
    
    const currentUrl = window.location.href;
    let baseUrl = currentUrl;
    
    if (currentUrl.includes('admin.html')) {
      baseUrl = currentUrl.replace('admin.html', 'download-letter.html');
    } else {
      const url = new URL(currentUrl);
      url.pathname = url.pathname.replace(/\/[^\/]*$/, '/download-letter.html');
      baseUrl = url.toString();
    }
    
    const downloadUrl = `${baseUrl.split('?')[0]}?id=${shareData.id}&ktp=${encodeURIComponent(shareData.nomorKTP || '')}`;
    
    const message = `Halo ${shareData.namaLengkap || 'Karyawan'},

Surat Packlaring Anda sudah siap untuk didownload.

üîó Link Download: ${downloadUrl}

üìã Informasi:
- Nama: ${shareData.namaLengkap || '-'}
- NIP: ${shareData.nip || '-'}
- No. Surat: ${shareData.noSurat || '-'}

üìù Cara Download:
1. Buka link di atas
2. Masukkan nomor KTP: ${shareData.nomorKTP || '-'}
3. Download surat dalam format PDF

Jika ada kendala, hubungi Admin di 081383796300.

Terima kasih,
Admin NEXT Logistics`;

    const encodedMessage = encodeURIComponent(message);
    const phone = formatWhatsAppNumber(shareData.whatsapp);
    window.open(`https://wa.me/${phone}?text=${encodedMessage}`, '_blank');
    
    showNotification('Notifikasi WhatsApp dibuka di tab baru', 'success');
  }

  // Close Share Modal
  function closeShareModal() {
    const shareModal = document.getElementById('shareModal');
    if (shareModal) shareModal.classList.remove('active');
    shareData = null;
  }

  // Test Link
  function sendTestLink() {
    if (!shareData) return;
    
    const currentUrl = window.location.href;
    let baseUrl = currentUrl;
    
    if (currentUrl.includes('admin.html')) {
      baseUrl = currentUrl.replace('admin.html', 'download-letter.html');
    } else {
      const url = new URL(currentUrl);
      url.pathname = url.pathname.replace(/\/[^\/]*$/, '/download-letter.html');
      baseUrl = url.toString();
    }
    
    const downloadUrl = `${baseUrl.split('?')[0]}?id=${shareData.id}&ktp=${encodeURIComponent(shareData.nomorKTP || '')}`;
    
    window.open(downloadUrl, '_blank');
    showNotification('Link dibuka di tab baru untuk testing', 'info');
  }

  // Show All Data
  function showAllData() {
    loadAllDataWithPagination();
  }

  // Refresh Data
  function refreshData() {
    loadData();
  }

  // Load Settings
  function loadSettings() {
    const savedSettings = localStorage.getItem('packlaringAdminSettings');
    if (savedSettings) {
      settings = JSON.parse(savedSettings);
    }
    
    const emailAdmin = document.getElementById('emailAdmin');
    const whatsappAdmin = document.getElementById('whatsappAdmin');
    const autoRefresh = document.getElementById('autoRefresh');
    const formatNoSurat = document.getElementById('formatNoSurat');
    const formatNIP = document.getElementById('formatNIP');
    const kotaTandaTangan = document.getElementById('kotaTandaTangan');
    const defaultPenandatangan = document.getElementById('defaultPenandatangan');
    const defaultJabatan = document.getElementById('defaultJabatan');
    const maxData = document.getElementById('maxData');
    const showOldData = document.getElementById('showOldData');
    const maxDataPerHari = document.getElementById('maxDataPerHari');
    
    if (emailAdmin) emailAdmin.value = settings.emailAdmin;
    if (whatsappAdmin) whatsappAdmin.value = settings.whatsappAdmin;
    if (autoRefresh) autoRefresh.value = settings.autoRefresh;
    if (formatNoSurat) formatNoSurat.value = settings.formatNoSurat;
    if (formatNIP) formatNIP.value = settings.formatNIP;
    if (kotaTandaTangan) kotaTandaTangan.value = settings.kotaTandaTangan;
    if (defaultPenandatangan) defaultPenandatangan.value = settings.defaultPenandatangan;
    if (defaultJabatan) defaultJabatan.value = settings.defaultJabatan;
    if (maxData) maxData.value = settings.maxData;
    if (showOldData) showOldData.value = settings.showOldData;
    if (maxDataPerHari) maxDataPerHari.value = settings.maxDataPerHari;
    
    itemsPerPage = parseInt(settings.maxData) || 20;
    currentPage = 1;
    
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    if (pageSizeSelect) {
      pageSizeSelect.value = itemsPerPage.toString();
    }
    
    setupAutoRefresh();
  }

  // Save Settings
  function saveSettings() {
    const emailAdmin = document.getElementById('emailAdmin');
    const whatsappAdmin = document.getElementById('whatsappAdmin');
    const autoRefresh = document.getElementById('autoRefresh');
    const formatNoSurat = document.getElementById('formatNoSurat');
    const formatNIP = document.getElementById('formatNIP');
    const kotaTandaTangan = document.getElementById('kotaTandaTangan');
    const defaultPenandatangan = document.getElementById('defaultPenandatangan');
    const defaultJabatan = document.getElementById('defaultJabatan');
    const maxData = document.getElementById('maxData');
    const showOldData = document.getElementById('showOldData');
    const maxDataPerHari = document.getElementById('maxDataPerHari');
    
    if (!emailAdmin || !whatsappAdmin || !autoRefresh) {
      showNotification('Form pengaturan tidak lengkap', 'error');
      return;
    }
    
    settings.emailAdmin = emailAdmin.value;
    settings.whatsappAdmin = whatsappAdmin.value;
    settings.autoRefresh = autoRefresh.value;
    settings.formatNoSurat = formatNoSurat ? formatNoSurat.value : settings.formatNoSurat;
    settings.formatNIP = formatNIP ? formatNIP.value : settings.formatNIP;
    settings.kotaTandaTangan = kotaTandaTangan ? kotaTandaTangan.value : settings.kotaTandaTangan;
    settings.defaultPenandatangan = defaultPenandatangan ? defaultPenandatangan.value : settings.defaultPenandatangan;
    settings.defaultJabatan = defaultJabatan ? defaultJabatan.value : settings.defaultJabatan;
    settings.maxData = maxData ? maxData.value : settings.maxData;
    settings.showOldData = showOldData ? showOldData.value : settings.showOldData;
    settings.maxDataPerHari = maxDataPerHari ? maxDataPerHari.value : settings.maxDataPerHari;
    
    localStorage.setItem('packlaringAdminSettings', JSON.stringify(settings));
    
    itemsPerPage = parseInt(settings.maxData) || 20;
    currentPage = 1;
    
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    if (pageSizeSelect) {
      pageSizeSelect.value = itemsPerPage.toString();
    }
    
    if (document.getElementById('tab-data') && document.getElementById('tab-data').classList.contains('active')) {
      renderDataTable();
    }
    
    setupAutoRefresh();
    
    showNotification('Pengaturan berhasil disimpan!', 'success');
  }

  // Reset Settings
  function resetSettings() {
    if (confirm('Apakah Anda yakin ingin mereset pengaturan ke default?')) {
      settings = {
        emailAdmin: "admin@nextlogistik.com",
        whatsappAdmin: "081383796300",
        autoRefresh: 60,
        formatNoSurat: "{NO}/SK-HRD/NEXT/{BULAN}/{TAHUN2}",
        formatNIP: "NEXT-{TAHUN}-{BULAN}-{NO}",
        kotaTandaTangan: "Bekasi",
        defaultPenandatangan: "M. Fajrian Noor",
        defaultJabatan: "Direktur",
        maxData: 20,
        showOldData: 90,
        maxDataPerHari: "0"
      };
      
      localStorage.setItem('packlaringAdminSettings', JSON.stringify(settings));
      loadSettings();
      
      showNotification('Pengaturan berhasil direset ke default!', 'success');
    }
  }

  // Setup Auto Refresh
  function setupAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
    
    const refreshSeconds = parseInt(settings.autoRefresh);
    if (refreshSeconds > 0) {
      autoRefreshInterval = setInterval(() => {
        loadData();
      }, refreshSeconds * 1000);
      
      console.log(`Auto refresh diatur setiap ${refreshSeconds} detik`);
    }
  }

  // Initialize Admin Panel
  document.addEventListener('DOMContentLoaded', function() {
    // Set default dates for filter
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setMonth(today.getMonth() - 1);
    
    const filterDari = document.getElementById('filterDari');
    const filterSampai = document.getElementById('filterSampai');
    
    if (filterDari) filterDari.value = lastMonth.toISOString().split('T')[0];
    if (filterSampai) filterSampai.value = today.toISOString().split('T')[0];
    
    // Add sort event listeners to table headers
    document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
      th.addEventListener('click', function() {
        const sortColumn = this.getAttribute('data-sort');
        toggleSort(sortColumn);
      });
    });
    
    // Set initial sort indicator
    const initialTh = document.querySelector(`.data-table th[data-sort="${currentSortColumn}"]`);
    if (initialTh) {
      initialTh.classList.add(`sort-${currentSortDirection}`);
    }
    
    // Setup drag and drop for file upload
    setupDragAndDrop();
    
    // Load initial data
    loadData();
    loadSettings();
    
    // Setup auto refresh
    setupAutoRefresh();
    
    // Auto update dashboard setiap 10 detik jika di tab dashboard
    setInterval(() => {
      const dashboardTab = document.getElementById('tab-dashboard');
      if (dashboardTab && dashboardTab.classList.contains('active')) {
        updateDashboard();
      }
    }, 10000);
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl + R untuk refresh
      if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        refreshData();
      }
      
      // Ctrl + F untuk focus search
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.focus();
      }
      
      // Escape untuk close modal
      if (e.key === 'Escape') {
        closeModal();
        closeDetailModal();
        closeDeleteModal();
        closeShareModal();
        closeAddModal();
        closeImportExportModal();
      }
      
      // Ctrl + A untuk select all pada tabel
      if (e.ctrlKey && e.key === 'a' && document.getElementById('tab-data').classList.contains('active')) {
        e.preventDefault();
        const selectAll = document.getElementById('selectAll');
        if (selectAll) {
          selectAll.checked = !selectAll.checked;
          toggleSelectAll();
        }
      }
      
      // Delete key untuk hapus data terpilih
      if (e.key === 'Delete' && selectedIds.size > 0) {
        e.preventDefault();
        deleteSelected();
      }
      
      // Ctrl + I untuk import/export modal
      if (e.ctrlKey && e.key === 'i') {
        e.preventDefault();
        showImportExportModal();
      }
      
      // Ctrl + N untuk tambah data baru
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        showAddModal();
      }
    });
  });
</script>
</body>
</html>
