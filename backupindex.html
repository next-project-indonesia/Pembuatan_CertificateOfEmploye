<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulir Packlaring - NEXT Logistics</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #ffffff);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #f7a01e 70%, #f10707 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .logo {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .title h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .title p {
      font-size: 14px;
      opacity: 0.9;
    }

    .badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      margin-top: 10px;
    }

    /* Form Container */
    .form-container {
      padding: 30px;
    }

    /* Progress Steps */
    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .steps::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e0e0e0;
      z-index: 1;
    }

    .step {
      position: relative;
      z-index: 2;
      text-align: center;
      width: 80px;
    }

    .step-number {
      width: 30px;
      height: 30px;
      background: #e0e0e0;
      color: #666;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .step.active .step-number {
      background: #3498db;
      color: white;
    }

    .step.completed .step-number {
      background: #27ae60;
      color: white;
    }

    .step-label {
      font-size: 12px;
      color: #666666;
    }

    .step.active .step-label {
      color: #4898e2;
      font-weight: bold;
    }

    /* Form Steps */
    .form-step {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .form-step.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .step-title {
      font-size: 20px;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    /* Form Groups */
    .form-group {
      margin-bottom: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #444;
    }

    label.required::after {
      content: " *";
      color: #e74c3c;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
      background: #f8f9fa;
      text-transform: uppercase;
    }

    .form-control:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      background: white;
    }

    .form-control:read-only {
      background: #f5f5f5;
      color: #666;
      cursor: not-allowed;
    }

    .help-text {
      display: block;
      margin-top: 5px;
      font-size: 12px;
      color: #666;
    }

    .error-message {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .error-message.active {
      display: block;
    }

    /* Button Groups */
    .button-group {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      gap: 15px;
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-success:hover {
      background: #219653;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(39, 174, 96, 0.2);
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* Preview Section */
    .preview-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-top: 30px;
      border: 2px dashed #ddd;
    }

    .preview-title {
      font-size: 18px;
      color: #2c3e50;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .preview-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #3498db;
    }

    .preview-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }

    .preview-value {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    /* Success Message */
    .success-message {
      display: none;
      text-align: center;
      padding: 50px 30px;
      animation: fadeIn 0.5s ease;
    }

    .success-message.active {
      display: block;
    }

    .success-icon {
      font-size: 80px;
      color: #27ae60;
      margin-bottom: 20px;
    }

    .success-message h2 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .success-message p {
      color: #666;
      margin-bottom: 30px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .whatsapp-btn {
      background: #25d366;
      color: white;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 15px 30px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s;
      margin-top: 20px;
    }

    .whatsapp-btn:hover {
      background: #128c7e;
      transform: translateY(-22px);
      box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2);
    }

    /* Loading Overlay */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Alert Messages */
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .alert.active {
      display: block;
    }

    .alert-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .alert-info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }

      .header {
        padding: 20px;
      }

      .form-container {
        padding: 20px;
      }

      .steps {
        margin-bottom: 30px;
      }

      .step {
        width: 60px;
      }

      .step-label {
        font-size: 10px;
      }

      .button-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .preview-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .step-number {
        width: 25px;
        height: 25px;
        font-size: 14px;
      }

      .step-title {
        font-size: 18px;
      }

      .form-control {
        padding: 10px 12px;
        font-size: 14px;
      }
    }

    /* Utility Classes */
    .text-center {
      text-align: center;
    }

    .mb-20 {
      margin-bottom: 20px;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .hidden {
      display: none;
    }

    /* Field for Technician */
    .technician-fields {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 15px;
      border-left: 4px solid #f39c12;
    }

    /* Print Styles */
    @media print {

      .header,
      .steps,
      .button-group,
      .alert {
        display: none !important;
      }

      .form-step {
        display: block !important;
      }

      .container {
        box-shadow: none;
        border: none;
      }
    }
  </style>
</head>

<body>

  <!-- Loading Overlay -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="color: #3498db; font-weight: 600; margin-top: 10px;">Menyimpan data...</p>
  </div>

  <div class="container">
    <!-- Alert Messages -->
    <div class="alert" id="alert"></div>

    <!-- Progress Steps -->
    <div class="steps">
      <div class="step active" id="step1">
        <div class="step-number">1</div>
        <div class="step-label">Data Surat</div>
      </div>
      <div class="step" id="step2">
        <div class="step-number">2</div>
        <div class="step-label">Data Pribadi</div>
      </div>
      <div class="step" id="step3">
        <div class="step-number">3</div>
        <div class="step-label">Masa Kerja</div>
      </div>
      <div class="step" id="step4">
        <div class="step-number">4</div>
        <div class="step-label">Konfirmasi</div>
      </div>
    </div>

    <!-- Form Steps -->
    <div class="form-container">
      <!-- Step 1: Data Surat -->
      <div class="form-step active" id="formStep1">
        <h2 class="step-title">üìÑ Data Surat</h2>

        <div class="form-row">
          <div class="form-group">
            <label class="required">Kode Surat</label>
            <input type="text" id="kodeSurat" class="form-control" value="SK" readonly>
            <span class="help-text">Kode tetap untuk Surat Keterangan</span>
          </div>

          <div class="form-group">
            <label class="required">Departemen</label>
            <input type="text" id="departemen" class="form-control" value="HRD" readonly>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="required">Nomor Surat</label>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="noSurat" class="form-control" placeholder="Auto Generate" readonly>
              <button type="button" class="btn btn-warning" onclick="generateNomorSurat()" style="white-space: nowrap;">
                Generate
              </button>
            </div>
            <span class="help-text">Generate otomatis dari sistem</span>
            <div class="error-message" id="errorNoSurat"></div>
          </div>

          <div class="form-group">
            <label class="required">Tanggal Surat</label>
            <input type="date" id="tanggalSurat" class="form-control">
            <div class="error-message" id="errorTanggalSurat"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="required">Tujuan Surat</label>
          <select id="tujuanSurat" class="form-control">
            <option value="Packlaring" selected>Paklaring</option>
            <option value="Pengunduran Diri">Pengunduran Diri</option>
            <option value="PHK">Pemutusan Hubungan Kerja</option>
            <option value="Mutasi">Mutasi</option>
            <option value="Promosi">Promosi</option>
          </select>
        </div>

        <div class="button-group">
          <div></div>
          <button class="btn btn-primary" onclick="nextStep()">
            Selanjutnya <span style="font-size: 18px;">‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 2: Data Pribadi -->
      <div class="form-step" id="formStep2">
        <h2 class="step-title">üë§ Data Pribadi</h2>

        <div class="form-group">
          <label class="required">Nama Lengkap</label>
          <input type="text" id="namaLengkap" class="form-control" placeholder="MASUKKAN NAMA LENGKAP SESUAI KTP"
            oninput="this.value = this.value.toUpperCase()" onblur="this.value = this.value.trim().toUpperCase()">
          <span class="help-text">Nama akan otomatis menjadi huruf besar semua</span>
          <div class="error-message" id="errorNamaLengkap"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="required">Nomor KTP</label>
            <input type="text" id="nomorKTP" class="form-control" placeholder="MASUKKAN 16 DIGIT NOMOR KTP"
              oninput="formatNomorKTP(this)" onblur="validateUniqueKTP()" maxlength="19">
            <span class="help-text">Format: XXXX-XXXX-XXXX-XXXX</span>
            <div class="error-message" id="errorNomorKTP"></div>
          </div>

          <div class="form-group">
            <label class="required">Wilayah Area Kerja</label>
            <select id="wilayahArea" class="form-control">
              <option value="">PILIH WILAYAH AREA KERJA</option>
              <option value="ACEH">ACEH</option>
              <option value="SUMATERA UTARA">SUMATERA UTARA</option>
              <option value="SUMATERA BARAT">SUMATERA BARAT</option>
              <option value="RIAU">RIAU</option>
              <option value="JAMBI">JAMBI</option>
              <option value="SUMATERA SELATAN">SUMATERA SELATAN</option>
              <option value="BENGKULU">BENGKULU</option>
              <option value="LAMPUNG">LAMPUNG</option>
              <option value="KEPULAUAN BANGKA BELITUNG">KEPULAUAN BANGKA BELITUNG</option>
              <option value="KEPULAUAN RIAU">KEPULAUAN RIAU</option>
              <option value="DKI JAKARTA">DKI JAKARTA</option>
              <option value="JAWA BARAT">JAWA BARAT</option>
              <option value="JAWA TENGAH">JAWA TENGAH</option>
              <option value="DAERAH ISTIMEWA YOGYAKARTA">DAERAH ISTIMEWA YOGYAKARTA</option>
              <option value="JAWA TIMUR">JAWA TIMUR</option>
              <option value="BANTEN">BANTEN</option>
              <option value="BALI">BALI</option>
              <option value="NUSA TENGGARA BARAT">NUSA TENGGARA BARAT</option>
              <option value="NUSA TENGGARA TIMUR">NUSA TENGGARA TIMUR</option>
              <option value="KALIMANTAN BARAT">KALIMANTAN BARAT</option>
              <option value="KALIMANTAN TENGAH">KALIMANTAN TENGAH</option>
              <option value="KALIMANTAN SELATAN">KALIMANTAN SELATAN</option>
              <option value="KALIMANTAN TIMUR">KALIMANTAN TIMUR</option>
              <option value="KALIMANTAN UTARA">KALIMANTAN UTARA</option>
              <option value="SULAWESI UTARA">SULAWESI UTARA</option>
              <option value="SULAWESI TENGAH">SULAWESI TENGAH</option>
              <option value="SULAWESI SELATAN">SULAWESI SELATAN</option>
              <option value="SULAWESI TENGGARA">SULAWESI TENGGARA</option>
              <option value="GORONTALO">GORONTALO</option>
              <option value="SULAWESI BARAT">SULAWESI BARAT</option>
              <option value="MALUKU">MALUKU</option>
              <option value="MALUKU UTARA">MALUKU UTARA</option>
              <option value="PAPUA BARAT">PAPUA BARAT</option>
              <option value="PAPUA">PAPUA</option>
              <option value="PAPUA TENGAH">PAPUA TENGAH</option>
              <option value="PAPUA PEGUNUNGAN">PAPUA PEGUNUNGAN</option>
              <option value="PAPUA SELATAN">PAPUA SELATAN</option>
              <option value="PAPUA BARAT DAYA">PAPUA BARAT DAYA</option>
              <option value="LAINNYA">LAINNYA</option>
            </select>
            <span class="help-text">Pilih wilayah tempat Anda bekerja</span>
            <div class="error-message" id="errorWilayahArea"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="required">NIP / ID Karyawan</label>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="nip" class="form-control" placeholder="NEXT0001" readonly>
              <button type="button" class="btn btn-warning" onclick="generateNIP()" style="white-space: nowrap;">
                Generate NIP
              </button>
            </div>
            <span class="help-text">ID unik karyawan</span>
            <div class="error-message" id="errorNIP"></div>
          </div>

          <div class="form-group">
            <label class="required">Jabatan Terakhir</label>
            <select id="jabatan" class="form-control" onchange="toggleTechnicianFields()">
              <option value="">PILIH JABATAN</option>
              <option value="TEKNISI">TEKNISI</option>
              <option value="STAFF ADMIN PUSAT">STAFF ADMIN PUSAT</option>
              <option value="STAFF ADMIN WILAYAH">STAFF ADMIN WILAYAH</option>
              <option value="SPV AREA">SPV AREA</option>
              <option value="KORDINATOR WILAYAH">KORDINATOR WILAYAH</option>
              <option value="CUSTOMER SERVICE">CUSTOMER SERVICE</option>
              <option value="STAFF MONITORING">STAFF MONITORING</option>
              <option value="MANAGER AREA">MANAGER AREA</option>
            </select>
            <div class="error-message" id="errorJabatan"></div>
          </div>
        </div>

        <!-- Informasi Koordinator untuk Teknisi -->
        <div id="technicianFields" class="technician-fields" style="display: none;">
          <h4 style="margin-bottom: 15px; color: #f39c12;">üìç Informasi Koordinator untuk Teknisi</h4>
          <div class="form-row">
            <div class="form-group">
              <label class="required">Kabupaten/Kota Tempat Tugas</label>
              <input type="text" id="kabupatenKotaTugas" class="form-control" placeholder="CONTOH: KOTA JAKARTA SELATAN"
                oninput="this.value = this.value.toUpperCase()" onblur="this.value = this.value.trim().toUpperCase()">
              <span class="help-text">Masukkan kabupaten/kota tempat bertugas</span>
              <div class="error-message" id="errorKabupatenKota"></div>
            </div>
            
            <div class="form-group">
              <label class="required">Nama Koordinator Wilayah</label>
              <select id="kordinatorWilayah" class="form-control" onchange="toggleKordinatorLainnya()">
                <option value="">PILIH KOORDINATOR</option>
                <option value="LAINNYA">(SILAKAN TULIS)</option>
              </select>
              <div class="error-message" id="errorKordinatorWilayah"></div>
            </div>
          </div>
          
          <div id="kordinatorLainnyaContainer" style="display: none;">
            <div class="form-group">
              <label class="required">Nama Koordinator Wilayah Lainnya</label>
              <input type="text" id="kordinatorLainnyaInput" class="form-control" 
                placeholder="TULIS NAMA KOORDINATOR WILAYAH"
                oninput="this.value = this.value.toUpperCase()" 
                onblur="this.value = this.value.trim().toUpperCase()">
              <div class="error-message" id="errorKordinatorLainnya"></div>
            </div>
          </div>
          
          <div class="form-group">
            <label>Catatan Koordinator (Opsional)</label>
            <textarea id="catatanKordinator" class="form-control" rows="2" 
              placeholder="TAMBAHKAN CATATAN TENTANG KOORDINATOR JIKA PERLU..."
              oninput="this.value = this.value.toUpperCase()" 
              onblur="this.value = this.value.trim().toUpperCase()"></textarea>
          </div>
        </div>

        <div class="form-group">
          <label class="required">Departemen</label>
          <select id="deptKaryawan" class="form-control">
            <option value="">PILIH DEPARTEMEN</option>
            <option value="HRD">HRD</option>
          </select>
          <div class="error-message" id="errorDeptKaryawan"></div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="prevStep()">
            <span style="font-size: 18px;">‚Üê</span> Sebelumnya
          </button>
          <button class="btn btn-primary" onclick="nextStep()">
            Selanjutnya <span style="font-size: 18px;">‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 3: Masa Kerja -->
      <div class="form-step" id="formStep3">
        <h2 class="step-title">üìÖ Masa Kerja</h2>

        <div class="form-row">
          <div class="form-group">
            <label class="required">Tanggal Mulai Kerja</label>
            <input type="date" id="tanggalMulai" class="form-control">
            <span class="help-text">Tanggal mulai bekerja di perusahaan</span>
            <div class="error-message" id="errorTanggalMulai"></div>
          </div>

          <div class="form-group">
            <label class="required">Tanggal Berakhir</label>
            <input type="date" id="tanggalBerakhir" class="form-control">
            <span class="help-text">Tanggal terakhir bekerja</span>
            <div class="error-message" id="errorTanggalBerakhir"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="required">Alasan Berhenti</label>
          <select id="alasanBerhenti" class="form-control">
            <option value="KONTRAK BERAKHIR" selected>KONTRAK BERAKHIR</option>
            <option value="PENGUNDURAN DIRI">PENGUNDURAN DIRI</option>
            <option value="PHK">PEMUTUSAN HUBUNGAN KERJA</option>
            <option value="PENSIUN">PENSIUN</option>
            <option value="MENINGGAL DUNIA">MENINGGAL DUNIA</option>
            <option value="LAINNYA">LAINNYA</option>
          </select>
        </div>

        <div class="form-group">
          <label>Keterangan Tambahan</label>
          <textarea id="keterangan" class="form-control" rows="4" placeholder="TAMBAHKAN KETERANGAN JIKA DIPERLUKAN..."
            oninput="this.value = this.value.toUpperCase()"
            onblur="this.value = this.value.trim().toUpperCase()"></textarea>
        </div>

        <div class="preview-section" id="previewMasaKerja">
          <div class="preview-title">
            <span>üìã Preview Data</span>
            <button type="button" class="btn btn-secondary" onclick="updatePreview()"
              style="padding: 5px 10px; font-size: 12px;">
              Refresh Preview
            </button>
          </div>
          <div class="preview-grid" id="previewContent">
            <!-- Preview akan diisi oleh JavaScript -->
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="prevStep()">
            <span style="font-size: 18px;">‚Üê</span> Sebelumnya
          </button>
          <button class="btn btn-primary" onclick="nextStep()">
            Selanjutnya <span style="font-size: 18px;">‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 4: Konfirmasi -->
      <div class="form-step" id="formStep4">
        <h2 class="step-title">‚úÖ Konfirmasi Data</h2>

        <div class="preview-section">
          <div class="preview-title">
            <span>üìÑ Ringkasan Data Packlaring</span>
          </div>
          <div class="preview-grid" id="finalPreview">
            <!-- Final preview akan diisi oleh JavaScript -->
          </div>
        </div>

        <div class="form-group mt-20">
          <label>Email untuk Notifikasi (opsional)</label>
          <input type="email" id="email" class="form-control" placeholder="EMAIL@CONTOH.COM"
            oninput="this.value = this.value.toUpperCase()" onblur="this.value = this.value.trim().toUpperCase()">
          <span class="help-text">Kirim salinan konfirmasi ke email</span>
        </div>

        <div class="form-group">
          <label class="required">No. WhatsApp untuk Konfirmasi</label>
          <input type="tel" id="whatsapp" class="form-control" placeholder="081234567890" required>
          <span class="help-text">Nomor WhatsApp aktif untuk konfirmasi dari admin (wajib diisi)</span>
          <div class="error-message" id="errorWhatsApp"></div>
        </div>

        <div class="alert alert-info" style="display: block;">
          <strong>üì¢ INFORMASI PENTING:</strong>
          <p style="margin-top: 5px; font-size: 14px;">
            ‚Ä¢ DATA YANG SUDAH DIKIRIM AKAN DIPROSES OLEH HRD DALAM 1-3 HARI KERJA<br>
            ‚Ä¢ PASTIKAN SEMUA DATA SUDAH BENAR SEBELUM MENGIRIM<br>
            ‚Ä¢ ADMIN AKAN MENGHUBUNGI VIA WHATSAPP UNTUK KONFIRMASI<br>
            ‚Ä¢ NOMOR WHATSAPP WAJIB DIISI UNTUK KONFIRMASI<br>
            ‚Ä¢ SETIAP NOMOR KTP HANYA BOLEH TERDAFTAR SATU KALI
          </p>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="prevStep()">
            <span style="font-size: 18px;">‚Üê</span> Periksa Kembali
          </button>
          <button class="btn btn-success" onclick="submitForm()">
            <span style="font-size: 20px;">‚úì</span> Kirim Permintaan
          </button>
        </div>
      </div>

      <!-- Success Message -->
      <div class="success-message" id="successMessage">
        <div class="success-icon">‚úÖ</div>
        <h2>PERMINTAAN BERHASIL DIKIRIM!</h2>
        <p>
          DATA PACKLARING ANDA TELAH BERHASIL DISIMPAN. <br>
          TIM HRD AKAN MEMPROSES PERMINTAAN ANDA DAN AKAN MENGHUBUNGI VIA WHATSAPP DALAM 1-3 HARI KERJA.
        </p>

        <div class="preview-section" style="max-width: 500px; margin: 30px auto;">
          <div class="preview-item">
            <div class="preview-label">Nomor Surat</div>
            <div class="preview-value" id="successNoSurat">-</div>
          </div>
          <div class="preview-item">
            <div class="preview-label">Nama</div>
            <div class="preview-value" id="successNama">-</div>
          </div>
          <div class="preview-item">
            <div class="preview-label">NIP</div>
            <div class="preview-value" id="successNIP">-</div>
          </div>
          <div class="preview-item">
            <div class="preview-label">Status</div>
            <div class="preview-value" style="color: #f39c12;">‚è≥ MENUNGGU PROSES</div>
          </div>
        </div>

        <p style="margin-top: 30px; font-size: 14px; color: #666;">
          <strong>üì± HUBUNGI ADMIN:</strong><br>
          JIKA ADA PERTANYAAN, HUBUNGI ADMIN VIA WHATSAPP:
        </p>

        <a href="https://wa.me/6281383796300?text=Halo%20Admin,%20saya%20sudah%20mengirim%20permintaan%20packlaring."
          class="whatsapp-btn" target="_blank">
          <span style="font-size: 20px;">üí¨</span> CHAT ADMIN VIA WHATSAPP
        </a>

        <div style="margin-top: 40px;">
          <button class="btn btn-primary" onclick="resetForm()">
            <span style="font-size: 18px;">üîÑ</span> BUAT PERMINTAAN BARU
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Configuration -->
  <script>
    // Konfigurasi Firebase Anda
    const firebaseConfig = {
      apiKey: "AIzaSyAEvDR-h0hkgs1xAawra7u3jo9Sc3lCbpo",
      authDomain: "next-packlaring.firebaseapp.com",
      projectId: "next-packlaring",
      storageBucket: "next-packlaring.firebasestorage.app",
      messagingSenderId: "400584486436",
      appId: "1:400584486436:web:99067d2c6dc6d87ef7b2b1",
      measurementId: "G-KRFXBYN663"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global Variables
    let currentStep = 1;
    let generatedData = {
      noSurat: '',
      nip: '',
      nomorUrut: 0,
      nipNumber: 0
    };
    let isGenerating = false;
    let usedKTPs = new Set(); // Untuk melacak KTP yang sudah digunakan dalam session

    // Fungsi untuk format nomor KTP (XXXX-XXXX-XXXX-XXXX)
    function formatNomorKTP(input) {
      // Hapus semua karakter non-digit
      let value = input.value.replace(/\D/g, '');

      // Batasi hanya 16 digit
      value = value.substring(0, 16);

      // Format dengan tanda hubung setiap 4 digit
      let formattedValue = '';
      for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 4 === 0) {
          formattedValue += '-';
        }
        formattedValue += value[i];
      }

      // Set nilai kembali ke input
      input.value = formattedValue.toUpperCase();
    }

    // Fungsi untuk validasi nomor KTP
    function validateKTP(ktp) {
      // Hapus tanda hubung
      const cleanKTP = ktp.replace(/\D/g, '');

      // Validasi panjang 16 digit
      if (cleanKTP.length !== 16) {
        return false;
      }

      // Validasi hanya angka
      if (!/^\d+$/.test(cleanKTP)) {
        return false;
      }

      return true;
    }

    // Fungsi untuk validasi nomor WhatsApp
    function validateWhatsApp(whatsapp) {
      // Hapus semua karakter non-digit
      const cleanWA = whatsapp.replace(/\D/g, '');
      
      // Validasi minimal 10 digit (tanpa kode negara)
      if (cleanWA.length < 10) {
        return false;
      }
      
      // Validasi hanya angka
      if (!/^\d+$/.test(cleanWA)) {
        return false;
      }
      
      return true;
    }

    // Validasi unik KTP
    async function validateUniqueKTP() {
      const ktpInput = document.getElementById('nomorKTP');
      const ktpValue = ktpInput.value.replace(/\D/g, '');
      const errorElement = document.getElementById('errorNomorKTP');

      if (!ktpValue) {
        hideError('errorNomorKTP');
        return true;
      }

      if (!validateKTP(ktpInput.value)) {
        showError('errorNomorKTP', 'Nomor KTP harus 16 digit angka');
        return false;
      }

      showLoading(true);
      
      try {
        // Cek di Firestore apakah KTP sudah terdaftar
        const snapshot = await db.collection('packlaring')
          .where('nomorKTP', '==', ktpInput.value.toUpperCase())
          .limit(1)
          .get();

        if (!snapshot.empty) {
          showError('errorNomorKTP', 'Nomor KTP ini sudah terdaftar. 1 user hanya boleh memiliki 1 nomor KTP.');
          showLoading(false);
          return false;
        }

        // Cek juga di session storage untuk mencegah duplikasi dalam sesi yang sama
        if (usedKTPs.has(ktpValue)) {
          showError('errorNomorKTP', 'Nomor KTP ini sudah digunakan dalam sesi ini.');
          showLoading(false);
          return false;
        }

        hideError('errorNomorKTP');
        showLoading(false);
        return true;
      } catch (error) {
        console.error('Error checking KTP:', error);
        showLoading(false);
        hideError('errorNomorKTP');
        return true; // Biarkan lewat jika error
      }
    }

    // Format tanggal Indonesia
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const options = {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      };
      return date.toLocaleDateString('id-ID', options);
    }

    function formatShortDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear().toString().slice(-2);
      return `${day}/${month}/${year}`;
    }

    // Show Loading
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    // Show Alert
    function showAlert(message, type = 'success') {
      const alert = document.getElementById('alert');
      alert.textContent = message.toUpperCase();
      alert.className = `alert alert-${type} active`;

      // Auto hide after 5 seconds
      setTimeout(() => {
        alert.classList.remove('active');
      }, 5000);
    }

    // Show Error
    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.classList.add('active');
    }

    // Hide Error
    function hideError(elementId) {
      const errorElement = document.getElementById(elementId);
      errorElement.classList.remove('active');
    }

    // Toggle fields untuk teknisi
    function toggleTechnicianFields() {
      const jabatan = document.getElementById('jabatan').value;
      const technicianFields = document.getElementById('technicianFields');
      
      if (jabatan === 'TEKNISI') {
        technicianFields.style.display = 'block';
        // Set required untuk field teknisi
        document.getElementById('kabupatenKotaTugas').required = true;
        document.getElementById('kordinatorWilayah').required = true;
      } else {
        technicianFields.style.display = 'none';
        // Hapus required untuk field teknisi
        document.getElementById('kabupatenKotaTugas').required = false;
        document.getElementById('kordinatorWilayah').required = false;
      }
    }

    // Toggle input untuk koordinator lainnya
    function toggleKordinatorLainnya() {
      const kordinator = document.getElementById('kordinatorWilayah').value;
      const lainnyaContainer = document.getElementById('kordinatorLainnyaContainer');
      
      if (kordinator === 'LAINNYA') {
        lainnyaContainer.style.display = 'block';
        document.getElementById('kordinatorLainnyaInput').required = true;
      } else {
        lainnyaContainer.style.display = 'none';
        document.getElementById('kordinatorLainnyaInput').required = false;
      }
    }

    // Navigasi Step
    function nextStep() {
      // Validasi step saat ini sebelum lanjut
      if (!validateCurrentStep()) {
        return;
      }

      // Update preview jika di step 3
      if (currentStep === 3) {
        updatePreview();
      }

      // Update final preview jika di step 4
      if (currentStep === 4) {
        updateFinalPreview();
      }

      // Hide current step
      document.getElementById(`formStep${currentStep}`).classList.remove('active');
      document.getElementById(`step${currentStep}`).classList.remove('active');

      // Update current step
      currentStep++;

      // Show next step
      document.getElementById(`formStep${currentStep}`).classList.add('active');
      document.getElementById(`step${currentStep}`).classList.add('active');

      // Scroll to top of form
      document.querySelector('.form-container').scrollIntoView({
        behavior: 'smooth'
      });
    }

    function prevStep() {
      // Hide current step
      document.getElementById(`formStep${currentStep}`).classList.remove('active');
      document.getElementById(`step${currentStep}`).classList.remove('active');

      // Update current step
      currentStep--;

      // Show previous step
      document.getElementById(`formStep${currentStep}`).classList.add('active');
      document.getElementById(`step${currentStep}`).classList.add('active');

      // Scroll to top of form
      document.querySelector('.form-container').scrollIntoView({
        behavior: 'smooth'
      });
    }

    function goToStep(step) {
      // Hide current step
      document.getElementById(`formStep${currentStep}`).classList.remove('active');
      document.getElementById(`step${currentStep}`).classList.remove('active');

      // Update current step
      currentStep = step;

      // Show selected step
      document.getElementById(`formStep${currentStep}`).classList.add('active');
      document.getElementById(`step${currentStep}`).classList.add('active');
    }

    // Validasi Step
    function validateCurrentStep() {
      const errors = [];
      hideAllErrors();

      switch (currentStep) {
        case 1: // Data Surat
          if (!document.getElementById('tanggalSurat').value) {
            showError('errorTanggalSurat', 'Tanggal Surat harus diisi');
            errors.push('Tanggal Surat harus diisi');
          }
          if (!generatedData.noSurat) {
            showError('errorNoSurat', 'Generate Nomor Surat terlebih dahulu');
            errors.push('Generate Nomor Surat terlebih dahulu');
          }
          break;

        case 2: // Data Pribadi
          if (!document.getElementById('namaLengkap').value.trim()) {
            showError('errorNamaLengkap', 'Nama Lengkap harus diisi');
            errors.push('Nama Lengkap harus diisi');
          }
          
          const ktpValue = document.getElementById('nomorKTP').value;
          if (!ktpValue.trim()) {
            showError('errorNomorKTP', 'Nomor KTP harus diisi');
            errors.push('Nomor KTP harus diisi');
          } else if (!validateKTP(ktpValue)) {
            showError('errorNomorKTP', 'Nomor KTP harus 16 digit angka');
            errors.push('Nomor KTP harus 16 digit angka');
          }
          
          if (!document.getElementById('wilayahArea').value) {
            showError('errorWilayahArea', 'Wilayah Area Kerja harus dipilih');
            errors.push('Wilayah Area Kerja harus dipilih');
          }
          
          if (!generatedData.nip) {
            showError('errorNIP', 'Generate NIP terlebih dahulu');
            errors.push('Generate NIP terlebih dahulu');
          }
          
          if (!document.getElementById('jabatan').value.trim()) {
            showError('errorJabatan', 'Jabatan harus diisi');
            errors.push('Jabatan harus diisi');
          }
          
          if (!document.getElementById('deptKaryawan').value) {
            showError('errorDeptKaryawan', 'Departemen harus dipilih');
            errors.push('Departemen harus dipilih');
          }
          
          // Validasi tambahan untuk teknisi
          const jabatan = document.getElementById('jabatan').value;
          if (jabatan === 'TEKNISI') {
            if (!document.getElementById('kabupatenKotaTugas').value.trim()) {
              showError('errorKabupatenKota', 'Kabupaten/Kota Tempat Tugas harus diisi');
              errors.push('Kabupaten/Kota Tempat Tugas harus diisi');
            }
            
            const kordinator = document.getElementById('kordinatorWilayah').value;
            if (!kordinator) {
              showError('errorKordinatorWilayah', 'Nama Koordinator Wilayah harus dipilih');
              errors.push('Nama Koordinator Wilayah harus dipilih');
            }
            
            if (kordinator === 'LAINNYA' && !document.getElementById('kordinatorLainnyaInput').value.trim()) {
              showError('errorKordinatorLainnya', 'Nama Koordinator Wilayah Lainnya harus diisi');
              errors.push('Nama Koordinator Wilayah Lainnya harus diisi');
            }
          }
          break;

        case 3: // Masa Kerja
          if (!document.getElementById('tanggalMulai').value) {
            showError('errorTanggalMulai', 'Tanggal Mulai harus diisi');
            errors.push('Tanggal Mulai harus diisi');
          }
          
          if (!document.getElementById('tanggalBerakhir').value) {
            showError('errorTanggalBerakhir', 'Tanggal Berakhir harus diisi');
            errors.push('Tanggal Berakhir harus diisi');
          }

          // Validasi tanggal
          const tanggalMulai = new Date(document.getElementById('tanggalMulai').value);
          const tanggalBerakhir = new Date(document.getElementById('tanggalBerakhir').value);
          if (tanggalBerakhir <= tanggalMulai) {
            showError('errorTanggalBerakhir', 'Tanggal Berakhir harus setelah Tanggal Mulai');
            errors.push('Tanggal Berakhir harus setelah Tanggal Mulai');
          }
          break;

        case 4: // Konfirmasi
          const whatsappValue = document.getElementById('whatsapp').value.trim();
          if (!whatsappValue) {
            showError('errorWhatsApp', 'Nomor WhatsApp harus diisi');
            errors.push('Nomor WhatsApp harus diisi');
          } else if (!validateWhatsApp(whatsappValue)) {
            showError('errorWhatsApp', 'Nomor WhatsApp tidak valid. Minimal 10 digit angka');
            errors.push('Nomor WhatsApp tidak valid');
          }
          break;
      }

      if (errors.length > 0) {
        showAlert(errors.join(', '), 'error');
        return false;
      }

      return true;
    }

    // Hide all errors
    function hideAllErrors() {
      const errorElements = document.querySelectorAll('.error-message');
      errorElements.forEach(element => {
        element.classList.remove('active');
      });
    }

    // Generate Nomor Surat dengan transaction untuk menghindari bentrok
    async function generateNomorSurat() {
      if (isGenerating) return;
      
      isGenerating = true;
      showLoading(true);
      hideError('errorNoSurat');

      try {
        // Gunakan transaction untuk menghindari race condition
        const nomorSurat = await db.runTransaction(async (transaction) => {
          // Reference ke dokumen counter
          const counterRef = db.collection('counters').doc('suratCounter');
          
          // Ambil counter saat ini
          const counterDoc = await transaction.get(counterRef);
          
          let lastNumber = 0;
          if (counterDoc.exists) {
            lastNumber = counterDoc.data().lastNumber || 0;
          }
          
          // Increment counter
          const newNumber = lastNumber + 1;
          
          // Update counter
          transaction.set(counterRef, { 
            lastNumber: newNumber,
            updatedAt: new Date()
          }, { merge: true });
          
          // Format nomor surat
          const now = new Date();
          const bulan = (now.getMonth() + 1).toString().padStart(2, '0');
          const tahun2 = now.getFullYear().toString().slice(-2);
          const formattedNumber = newNumber.toString().padStart(3, '0');
          
          return `${formattedNumber}/SK-HRD/NEXT/${bulan}/${tahun2}`;
        });

        // Simpan ke variabel global
        generatedData.noSurat = nomorSurat;
        generatedData.nomorUrut = parseInt(nomorSurat.split('/')[0]);

        // Update input field
        document.getElementById('noSurat').value = nomorSurat;

        showAlert(`Nomor surat berhasil digenerate: ${nomorSurat}`, 'success');

      } catch (error) {
        console.error('Error generating nomor surat:', error);

        // Fallback dengan timestamp untuk menghindari bentrok
        const timestamp = Date.now();
        const now = new Date();
        const bulan = (now.getMonth() + 1).toString().padStart(2, '0');
        const tahun2 = now.getFullYear().toString().slice(-2);
        const uniqueNumber = (timestamp % 900) + 100; // Ambil 3 digit dari timestamp

        const nomorSurat = `${uniqueNumber}/SK-HRD/NEXT/${bulan}/${tahun2}`;

        generatedData.noSurat = nomorSurat;
        generatedData.nomorUrut = uniqueNumber;

        document.getElementById('noSurat').value = nomorSurat;

        showAlert(`Nomor surat digenerate dengan metode alternatif: ${nomorSurat}`, 'warning');
      } finally {
        showLoading(false);
        isGenerating = false;
      }
    }

    // Generate NIP dengan transaction untuk menghindari bentrok
    async function generateNIP() {
      if (isGenerating) return;
      
      isGenerating = true;
      showLoading(true);
      hideError('errorNIP');

      try {
        // Gunakan transaction untuk menghindari race condition
        const nip = await db.runTransaction(async (transaction) => {
          // Reference ke dokumen counter
          const counterRef = db.collection('counters').doc('nipCounter');
          
          // Ambil counter saat ini
          const counterDoc = await transaction.get(counterRef);
          
          let lastNumber = 0;
          if (counterDoc.exists) {
            lastNumber = counterDoc.data().lastNumber || 0;
          }
          
          // Increment counter
          const newNumber = lastNumber + 1;
          
          // Update counter
          transaction.set(counterRef, { 
            lastNumber: newNumber,
            updatedAt: new Date()
          }, { merge: true });
          
          // Format NIP
          const formattedNumber = newNumber.toString().padStart(4, '0');
          return `NEXT${formattedNumber}`;
        });

        // Simpan ke variabel global
        generatedData.nip = nip;
        generatedData.nipNumber = parseInt(nip.replace('NEXT', ''));

        // Update input field
        document.getElementById('nip').value = nip;

        showAlert(`NIP berhasil digenerate: ${nip}`, 'success');

      } catch (error) {
        console.error('Error generating NIP:', error);

        // Fallback dengan timestamp untuk menghindari bentrok
        const timestamp = Date.now();
        const uniqueNumber = (timestamp % 9000) + 1000; // Ambil 4 digit dari timestamp

        const nip = `NEXT${uniqueNumber}`;

        generatedData.nip = nip;
        generatedData.nipNumber = uniqueNumber;

        document.getElementById('nip').value = nip;

        showAlert(`NIP digenerate dengan metode alternatif: ${nip}`, 'warning');
      } finally {
        showLoading(false);
        isGenerating = false;
      }
    }

    // Update Preview
    function updatePreview() {
      const previewContent = document.getElementById('previewContent');

      // Hitung masa kerja
      const tglMulai = document.getElementById('tanggalMulai').value;
      const tglBerakhir = document.getElementById('tanggalBerakhir').value;

      let masaKerja = '-';
      if (tglMulai && tglBerakhir) {
        const mulai = new Date(tglMulai);
        const berakhir = new Date(tglBerakhir);

        const diffTime = Math.abs(berakhir - mulai);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        const tahun = Math.floor(diffDays / 365);
        const bulan = Math.floor((diffDays % 365) / 30);
        const hari = diffDays % 30;

        masaKerja = '';
        if (tahun > 0) masaKerja += `${tahun} TAHUN `;
        if (bulan > 0) masaKerja += `${bulan} BULAN `;
        if (hari > 0) masaKerja += `${hari} HARI`;
      }

      const previewHTML = `
      <div class="preview-item">
        <div class="preview-label">Periode Kerja</div>
        <div class="preview-value">${formatShortDate(tglMulai)} - ${formatShortDate(tglBerakhir)}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Lama Bekerja</div>
        <div class="preview-value">${masaKerja}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Alasan Berhenti</div>
        <div class="preview-value">${document.getElementById('alasanBerhenti').value}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Keterangan</div>
        <div class="preview-value">${document.getElementById('keterangan').value || '-'}</div>
      </div>
    `;

      previewContent.innerHTML = previewHTML;
    }

    // Update Final Preview
    function updateFinalPreview() {
      const finalPreview = document.getElementById('finalPreview');

      // Ambil data koordinator jika teknisi
      let kordinatorInfo = '';
      const jabatan = document.getElementById('jabatan').value;
      if (jabatan === 'TEKNISI') {
        const kabupaten = document.getElementById('kabupatenKotaTugas').value;
        let kordinator = document.getElementById('kordinatorWilayah').value;
        
        if (kordinator === 'LAINNYA') {
          kordinator = document.getElementById('kordinatorLainnyaInput').value;
        }
        
        kordinatorInfo = `
          <div class="preview-item">
            <div class="preview-label">Kab/Kota Tugas</div>
            <div class="preview-value">${kabupaten}</div>
          </div>
          <div class="preview-item">
            <div class="preview-label">Koordinator Wilayah</div>
            <div class="preview-value">${kordinator}</div>
          </div>
        `;
      }

      const data = {
        noSurat: document.getElementById('noSurat').value,
        nama: document.getElementById('namaLengkap').value,
        nomorKTP: document.getElementById('nomorKTP').value,
        wilayahArea: document.getElementById('wilayahArea').value,
        nip: document.getElementById('nip').value,
        jabatan: jabatan,
        dept: document.getElementById('deptKaryawan').value,
        tglMulai: formatDate(document.getElementById('tanggalMulai').value),
        tglBerakhir: formatDate(document.getElementById('tanggalBerakhir').value),
        alasan: document.getElementById('alasanBerhenti').value,
        tglSurat: formatDate(document.getElementById('tanggalSurat').value),
        tujuan: document.getElementById('tujuanSurat').value,
        whatsapp: document.getElementById('whatsapp').value
      };

      const previewHTML = `
      <div class="preview-item">
        <div class="preview-label">Nomor Surat</div>
        <div class="preview-value">${data.noSurat}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Nama Lengkap</div>
        <div class="preview-value">${data.nama}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Nomor KTP</div>
        <div class="preview-value">${data.nomorKTP}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Wilayah Area Kerja</div>
        <div class="preview-value">${data.wilayahArea}</div>
      </div>
      ${kordinatorInfo}
      <div class="preview-item">
        <div class="preview-label">NIP</div>
        <div class="preview-value">${data.nip}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Jabatan</div>
        <div class="preview-value">${data.jabatan}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Departemen</div>
        <div class="preview-value">${data.dept}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Masa Kerja</div>
        <div class="preview-value">${data.tglMulai} - ${data.tglBerakhir}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Alasan Berhenti</div>
        <div class="preview-value">${data.alasan}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">WhatsApp</div>
        <div class="preview-value">${data.whatsapp}</div>
      </div>
      <div class="preview-item">
        <div class="preview-label">Tanggal Surat</div>
        <div class="preview-value">${data.tglSurat}</div>
      </div>
    `;

      finalPreview.innerHTML = previewHTML;
    }

    // Submit Form dengan validasi tambahan
    async function submitForm() {
      // Validasi semua data
      if (!validateCurrentStep()) {
        goToStep(1);
        return;
      }

      // Validasi KTP unik sebelum submit
      const isKTPValid = await validateUniqueKTP();
      if (!isKTPValid) {
        showAlert('NOMOR KTP SUDAH TERDAFTAR. 1 USER HANYA BOLEH MEMILIKI 1 NOMOR KTP.', 'error');
        goToStep(2);
        return;
      }

      showLoading(true);

      try {
        // Kumpulkan semua data
        const formData = {
          // Data Surat
          kodeSurat: document.getElementById('kodeSurat').value,
          departemen: document.getElementById('departemen').value,
          noSurat: document.getElementById('noSurat').value,
          tanggalSurat: document.getElementById('tanggalSurat').value,
          tujuanSurat: document.getElementById('tujuanSurat').value,

          // Data Pribadi
          namaLengkap: document.getElementById('namaLengkap').value.trim().toUpperCase(),
          nomorKTP: document.getElementById('nomorKTP').value.toUpperCase(),
          wilayahArea: document.getElementById('wilayahArea').value.toUpperCase(),
          nip: document.getElementById('nip').value,
          jabatan: document.getElementById('jabatan').value.trim().toUpperCase(),
          deptKaryawan: document.getElementById('deptKaryawan').value.toUpperCase(),

          // Data Koordinator (jika teknisi)
          kabupatenKotaTugas: '',
          kordinatorWilayah: '',
          catatanKordinator: '',

          // Masa Kerja
          tanggalMulai: document.getElementById('tanggalMulai').value,
          tanggalBerakhir: document.getElementById('tanggalBerakhir').value,
          alasanBerhenti: document.getElementById('alasanBerhenti').value.toUpperCase(),
          keterangan: document.getElementById('keterangan').value.trim().toUpperCase(),

          // Kontak
          email: document.getElementById('email').value.trim().toUpperCase(),
          whatsapp: document.getElementById('whatsapp').value.trim(),

          // Metadata
          nomorUrut: generatedData.nomorUrut,
          nipNumber: generatedData.nipNumber,
          createdAt: new Date(),
          updatedAt: new Date(),
          status: 'pending',
          source: 'user_form',
          sessionId: sessionStorage.getItem('sessionId') || generateSessionId()
        };

        // Tambahkan data koordinator jika teknisi
        if (formData.jabatan === 'TEKNISI') {
          formData.kabupatenKotaTugas = document.getElementById('kabupatenKotaTugas').value.trim().toUpperCase();
          
          let kordinator = document.getElementById('kordinatorWilayah').value;
          if (kordinator === 'LAINNYA') {
            kordinator = document.getElementById('kordinatorLainnyaInput').value.trim().toUpperCase();
          }
          formData.kordinatorWilayah = kordinator;
          
          formData.catatanKordinator = document.getElementById('catatanKordinator').value.trim().toUpperCase();
        }

        // Simpan ke Firebase dengan pengecekan duplikasi
        const ktpClean = formData.nomorKTP.replace(/\D/g, '');
        
        // Cek lagi untuk memastikan tidak ada duplikasi
        const existingKTP = await db.collection('packlaring')
          .where('nomorKTP', '==', formData.nomorKTP)
          .limit(1)
          .get();

        if (!existingKTP.empty) {
          showAlert('NOMOR KTP SUDAH TERDAFTAR. DATA TIDAK DAPAT DISIMPAN.', 'error');
          showLoading(false);
          return;
        }

        // Cek duplikasi NIP
        const existingNIP = await db.collection('packlaring')
          .where('nip', '==', formData.nip)
          .limit(1)
          .get();

        if (!existingNIP.empty) {
          showAlert('NIP SUDAH TERDAFTAR. SILAKAN GENERATE NIP BARU.', 'error');
          showLoading(false);
          generateNIP(); // Generate NIP baru
          return;
        }

        // Simpan data
        const docRef = await db.collection('packlaring').add(formData);
        const docId = docRef.id;

        // Simpan KTP ke session storage untuk mencegah duplikasi dalam session
        usedKTPs.add(ktpClean);
        sessionStorage.setItem('usedKTPs', JSON.stringify(Array.from(usedKTPs)));

        // Update success message
        document.getElementById('successNoSurat').textContent = formData.noSurat;
        document.getElementById('successNama').textContent = formData.namaLengkap;
        document.getElementById('successNIP').textContent = formData.nip;

        // Show success message
        document.getElementById('formStep4').classList.remove('active');
        document.getElementById('successMessage').classList.add('active');

        // Kirim notifikasi WhatsApp otomatis
        sendWhatsAppNotification(formData, docId);

        showAlert('DATA BERHASIL DIKIRIM! TIM HRD AKAN MENGHUBUNGI ANDA.', 'success');

      } catch (error) {
        console.error('Error submitting form:', error);
        showAlert('GAGAL MENGIRIM DATA: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Generate session ID
    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Send WhatsApp Notification
    function sendWhatsAppNotification(data, docId) {
      const phoneNumber = "6281383796300";
      
      // Buat pesan dengan informasi koordinator jika teknisi
      let koordinatorInfo = '';
      if (data.jabatan === 'TEKNISI') {
        koordinatorInfo = `
KOORDINATOR:
üìç ${data.kabupatenKotaTugas}
üë§ ${data.kordinatorWilayah}
${data.catatanKordinator ? `üìù ${data.catatanKordinator}` : ''}
`;
      }

      const message = `*üìã PERMINTAAN PACKLARING BARU*

NAMA: *${data.namaLengkap}*
NOMOR KTP: ${data.nomorKTP}
WILAYAH AREA: ${data.wilayahArea}
NIP: ${data.nip}
JABATAN: ${data.jabatan}
DEPARTEMEN: ${data.deptKaryawan}

${koordinatorInfo}
NO. SURAT: ${data.noSurat}
TANGGAL: ${formatDate(data.tanggalSurat)}
ALASAN: ${data.alasanBerhenti}

MASA KERJA: ${formatDate(data.tanggalMulai)} - ${formatDate(data.tanggalBerakhir)}

KONTAK:
üìß ${data.email || 'TIDAK ADA EMAIL'}
üì± ${data.whatsapp || 'TIDAK ADA WHATSAPP'}

ID DOKUMEN: ${docId}

SILAKAN PROSES MELALUI PANEL ADMIN.`;

      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;

      // Buka WhatsApp di tab baru
      setTimeout(() => {
        window.open(whatsappUrl, '_blank');
      }, 2000);
    }

    // Reset Form
    function resetForm() {
      // Reset semua form
      document.getElementById('tanggalSurat').value = '';
      document.getElementById('namaLengkap').value = '';
      document.getElementById('nomorKTP').value = '';
      document.getElementById('wilayahArea').value = '';
      document.getElementById('nip').value = '';
      document.getElementById('jabatan').value = '';
      document.getElementById('deptKaryawan').value = '';
      document.getElementById('tanggalMulai').value = '';
      document.getElementById('tanggalBerakhir').value = '';
      document.getElementById('keterangan').value = '';
      document.getElementById('email').value = '';
      document.getElementById('whatsapp').value = '';
      
      // Reset field teknisi
      document.getElementById('kabupatenKotaTugas').value = '';
      document.getElementById('kordinatorWilayah').value = '';
      document.getElementById('kordinatorLainnyaInput').value = '';
      document.getElementById('catatanKordinator').value = '';
      document.getElementById('technicianFields').style.display = 'none';

      // Reset generated data
      generatedData = {
        noSurat: '',
        nip: '',
        nomorUrut: 0,
        nipNumber: 0
      };

      // Reset steps
      currentStep = 1;

      // Hide success message
      document.getElementById('successMessage').classList.remove('active');

      // Reset all steps visual
      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index === 0) step.classList.add('active');
      });

      document.querySelectorAll('.form-step').forEach((step, index) => {
        step.classList.remove('active');
        if (index === 0) step.classList.add('active');
      });

      // Reset previews
      document.getElementById('previewContent').innerHTML = '';
      document.getElementById('finalPreview').innerHTML = '';

      // Hide all errors
      hideAllErrors();

      // Scroll to top
      window.scrollTo(0, 0);

      // Generate nomor surat dan NIP baru
      generateNomorSurat();
      generateNIP();

      showAlert('FORM TELAH DIRESET. SILAKAN ISI DATA BARU.', 'info');
    }

    // Initialize Form
    function initForm() {
      // Set default tanggal surat ke hari ini
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('tanggalSurat').value = today;

      // Set min date for tanggal berakhir
      const tanggalMulaiInput = document.getElementById('tanggalMulai');
      const tanggalBerakhirInput = document.getElementById('tanggalBerakhir');

      tanggalMulaiInput.addEventListener('change', function () {
        tanggalBerakhirInput.min = this.value;
      });

      // Load used KTPs from session storage
      const savedKTPs = sessionStorage.getItem('usedKTPs');
      if (savedKTPs) {
        usedKTPs = new Set(JSON.parse(savedKTPs));
      }

      // Generate session ID jika belum ada
      if (!sessionStorage.getItem('sessionId')) {
        sessionStorage.setItem('sessionId', generateSessionId());
      }

      // Auto generate nomor surat dan NIP
      generateNomorSurat();
      generateNIP();

      // Event listener untuk uppercase otomatis
      const uppercaseInputs = document.querySelectorAll('input[type="text"], textarea');
      uppercaseInputs.forEach(input => {
        if (!input.id.includes('noSurat') && !input.id.includes('nip') &&
          !input.id.includes('kodeSurat') && !input.id.includes('departemen')) {
          input.addEventListener('input', function () {
            this.value = this.value.toUpperCase();
          });

          input.addEventListener('blur', function () {
            this.value = this.value.trim().toUpperCase();
          });
        }
      });

      // Event listener untuk select elements
      const selectElements = document.querySelectorAll('select');
      selectElements.forEach(select => {
        select.addEventListener('change', function () {
          this.value = this.value.toUpperCase();
        });
      });

      // Event listener untuk validasi KTP saat input
      document.getElementById('nomorKTP').addEventListener('blur', validateUniqueKTP);

      // Event listener untuk validasi WhatsApp
      document.getElementById('whatsapp').addEventListener('blur', function() {
        const value = this.value.trim();
        if (value && !validateWhatsApp(value)) {
          showError('errorWhatsApp', 'Nomor WhatsApp tidak valid. Minimal 10 digit angka');
        } else {
          hideError('errorWhatsApp');
        }
      });

      // Show welcome message
      setTimeout(() => {
        showAlert('SELAMAT DATANG! SILAKAN ISI FORMULIR PACKLARING. PASTIKAN DATA YANG ANDA MASUKKAN BENAR DAN TIDAK DUPLIKAT.', 'info');
      }, 1000);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
      initForm();

      // Setup keyboard shortcuts
      document.addEventListener('keydown', function (e) {
        // Ctrl + Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
          if (currentStep === 4) {
            submitForm();
          } else {
            nextStep();
          }
        }

        // Escape to go back
        if (e.key === 'Escape' && currentStep > 1) {
          prevStep();
        }
      });
    });
    
  </script>
</body>

</html>
